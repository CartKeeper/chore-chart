<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <meta name="theme-color" content="#0f0f1a">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="Quest Log">
  <link rel="manifest" href="manifest.json">
  <link rel="apple-touch-icon" href="icons/apple-touch-icon.png">
  <title>Quest Log</title>
  <style>
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
      -webkit-tap-highlight-color: transparent;
      -ms-overflow-style: none;
      scrollbar-width: none;
    }

    *::-webkit-scrollbar {
      display: none;
    }

    html {
      overscroll-behavior: none;
      -webkit-text-size-adjust: 100%;
      overflow-x: hidden;
      touch-action: pan-y;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: linear-gradient(135deg, #0f0f1a 0%, #1a1a2e 50%, #16213e 100%);
      min-height: 100vh;
      min-height: 100dvh;
      color: #e2e8f0;
      padding: 16px;
      padding-bottom: 100px;
      overscroll-behavior: none;
      -webkit-overflow-scrolling: touch;
      overflow-x: hidden;
      max-width: 100vw;
      touch-action: pan-y;
    }

    .grid-bg {
      position: fixed;
      top: 0; left: 0; right: 0; bottom: 0;
      background-image:
        linear-gradient(rgba(59, 130, 246, 0.03) 1px, transparent 1px),
        linear-gradient(90deg, rgba(59, 130, 246, 0.03) 1px, transparent 1px);
      background-size: 50px 50px;
      pointer-events: none;
      z-index: 0;
    }

    .container {
      position: relative;
      z-index: 1;
      max-width: 500px;
      margin: 0 auto;
    }

    .header {
      text-align: center;
      margin-bottom: 20px;
      padding: 20px;
      background: linear-gradient(135deg, rgba(59, 130, 246, 0.1) 0%, rgba(139, 92, 246, 0.1) 100%);
      border-radius: 20px;
      border: 1px solid rgba(59, 130, 246, 0.2);
      position: relative;
    }

    .header-tag {
      font-size: 12px;
      letter-spacing: 3px;
      color: #60a5fa;
      margin-bottom: 8px;
    }

    .header h1 {
      font-size: 28px;
      font-weight: 800;
      background: linear-gradient(135deg, #60a5fa 0%, #a78bfa 50%, #f472b6 100%);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }

    .header p {
      color: #94a3b8;
      font-size: 14px;
      margin-top: 4px;
    }

    /* Theme Button (top right) */
    .settings-btn {
      position: absolute;
      top: 16px;
      right: 16px;
      width: 40px;
      height: 40px;
      border-radius: 50%;
      border: 2px solid rgba(168, 85, 247, 0.5);
      background: rgba(168, 85, 247, 0.1);
      color: #c4b5fd;
      font-size: 18px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.2s;
    }

    .settings-btn:hover {
      background: rgba(168, 85, 247, 0.2);
      border-color: #c4b5fd;
    }

    /* Help Button */
    .help-btn {
      position: absolute;
      top: 16px;
      left: 16px;
      width: 40px;
      height: 40px;
      border: none;
      background: none;
      font-size: 22px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.2s;
      padding: 0;
    }

    .help-btn:hover {
      transform: scale(1.15);
    }


    /* Tab Navigation */
    .tab-nav {
      display: flex;
      gap: 8px;
      margin-bottom: 20px;
      background: rgba(15, 23, 42, 0.6);
      padding: 6px;
      border-radius: 14px;
      border: 1px solid rgba(59, 130, 246, 0.1);
    }

    .tab-btn {
      flex: 1;
      padding: 14px 8px;
      border: none;
      border-radius: 10px;
      font-size: 14px;
      font-weight: 700;
      cursor: pointer;
      transition: all 0.2s;
      background: transparent;
      color: #64748b;
    }

    .tab-btn.active {
      background: linear-gradient(135deg, #3b82f6, #60a5fa);
      color: white;
      box-shadow: 0 4px 15px rgba(59, 130, 246, 0.3);
    }

    .tab-content {
      display: none;
    }

    .tab-content.active {
      display: block;
    }

    .stats-grid {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 12px;
      margin-bottom: 20px;
    }

    .stat-card {
      border-radius: 14px;
      padding: 14px 10px;
      text-align: center;
    }

    .stat-card.level {
      background: linear-gradient(135deg, rgba(34, 197, 94, 0.15) 0%, rgba(34, 197, 94, 0.05) 100%);
      border: 1px solid rgba(34, 197, 94, 0.3);
    }

    .stat-card.xp {
      background: linear-gradient(135deg, rgba(59, 130, 246, 0.15) 0%, rgba(59, 130, 246, 0.05) 100%);
      border: 1px solid rgba(59, 130, 246, 0.3);
    }

    .stat-card.rank {
      border-radius: 14px;
      padding: 14px 10px;
      text-align: center;
    }

    .stat-label {
      font-size: 12px;
      letter-spacing: 2px;
      margin-bottom: 2px;
    }

    .stat-value {
      font-size: 32px;
      font-weight: 900;
    }

    .stat-card.level .stat-label { color: #86efac; }
    .stat-card.level .stat-value { color: #22c55e; }
    .stat-card.xp .stat-label { color: #93c5fd; }
    .stat-card.xp .stat-value { color: #3b82f6; font-size: 26px; }
    .stat-card.rank .stat-label { color: #c4b5fd; }
    .stat-card.rank .stat-value { font-size: 18px; }

    .progress-bar {
      height: 5px;
      background: rgba(59, 130, 246, 0.2);
      border-radius: 3px;
      margin-top: 6px;
      overflow: hidden;
    }

    .progress-fill {
      height: 100%;
      background: linear-gradient(90deg, #3b82f6, #60a5fa);
      border-radius: 3px;
      transition: width 0.5s ease;
    }

    .progress-text {
      font-size: 12px;
      color: #64748b;
      margin-top: 4px;
    }

    /* Wallet Section */
    .wallet-card {
      background: linear-gradient(135deg, rgba(34, 197, 94, 0.15) 0%, rgba(16, 185, 129, 0.1) 100%);
      border: 2px solid rgba(34, 197, 94, 0.3);
      border-radius: 20px;
      padding: 20px;
      margin-bottom: 20px;
      position: relative;
      overflow: hidden;
    }

    .wallet-card::before {
      content: '$';
      position: absolute;
      right: -10px;
      top: -20px;
      font-size: 120px;
      font-weight: 900;
      color: rgba(34, 197, 94, 0.1);
      pointer-events: none;
    }

    .wallet-header {
      display: flex;
      align-items: center;
      gap: 10px;
      margin-bottom: 16px;
    }

    .wallet-title {
      font-size: 16px;
      font-weight: 700;
      color: #86efac;
      letter-spacing: 1px;
    }

    .wallet-amount {
      font-size: 48px;
      font-weight: 900;
      color: #22c55e;
      text-shadow: 0 0 30px rgba(34, 197, 94, 0.5);
    }

    .wallet-breakdown {
      display: flex;
      flex-direction: column;
      gap: 8px;
      margin-top: 16px;
      padding-top: 16px;
      border-top: 1px solid rgba(34, 197, 94, 0.2);
    }

    .wallet-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-size: 15px;
    }

    .wallet-row-label {
      color: #94a3b8;
    }

    .wallet-row-value {
      font-weight: 700;
      color: #e2e8f0;
    }

    .wallet-row-value.bonus {
      color: #fbbf24;
    }

    .wallet-row-value.multiplier {
      color: #a855f7;
    }

    .streak-indicator {
      display: flex;
      align-items: center;
      gap: 6px;
      margin-top: 12px;
      padding: 10px;
      background: rgba(168, 85, 247, 0.15);
      border-radius: 10px;
      border: 1px solid rgba(168, 85, 247, 0.3);
    }

    .streak-flames {
      font-size: 18px;
    }

    .streak-text {
      font-size: 14px;
      color: #c4b5fd;
    }

    .streak-text strong {
      color: #a855f7;
    }

    .streak-days {
      display: flex;
      gap: 4px;
      margin-left: auto;
    }

    .streak-day {
      width: 24px;
      height: 24px;
      border-radius: 50%;
      background: rgba(71, 85, 105, 0.5);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 12px;
    }

    .streak-day.complete {
      background: linear-gradient(135deg, #a855f7, #7c3aed);
      color: white;
    }

    /* Achievements */
    .achievements-grid {
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    .achievement-card {
      display: flex;
      align-items: center;
      gap: 14px;
      padding: 16px;
      background: rgba(30, 41, 59, 0.5);
      border: 1px solid rgba(71, 85, 105, 0.3);
      border-radius: 14px;
      transition: all 0.3s;
    }

    .achievement-card.unlocked {
      background: linear-gradient(135deg, rgba(234, 179, 8, 0.15) 0%, rgba(251, 191, 36, 0.05) 100%);
      border-color: rgba(234, 179, 8, 0.4);
    }

    .achievement-icon {
      width: 50px;
      height: 50px;
      border-radius: 12px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 24px;
      background: rgba(71, 85, 105, 0.3);
    }

    .achievement-card.unlocked .achievement-icon {
      background: linear-gradient(135deg, #fbbf24, #f59e0b);
      box-shadow: 0 0 20px rgba(251, 191, 36, 0.4);
    }

    .achievement-info {
      flex: 1;
    }

    .achievement-name {
      font-size: 16px;
      font-weight: 700;
      color: #64748b;
    }

    .achievement-card.unlocked .achievement-name {
      color: #fbbf24;
    }

    .achievement-desc {
      font-size: 13px;
      color: #64748b;
      margin-top: 2px;
    }

    .achievement-reward {
      font-size: 14px;
      font-weight: 800;
      color: #64748b;
    }

    .achievement-card.unlocked .achievement-reward {
      color: #22c55e;
    }

    .achievement-card.claimable {
      animation: pulse-glow 2s ease-in-out infinite;
    }

    @keyframes pulse-glow {
      0%, 100% { box-shadow: 0 0 5px rgba(34, 197, 94, 0.3); }
      50% { box-shadow: 0 0 20px rgba(34, 197, 94, 0.6); }
    }

    .achievement-claim-btn {
      background: linear-gradient(135deg, #22c55e, #16a34a);
      color: white;
      border: none;
      border-radius: 8px;
      padding: 10px 16px;
      font-size: 14px;
      font-weight: 700;
      cursor: pointer;
      transition: transform 0.2s, box-shadow 0.2s;
    }

    .achievement-claim-btn:hover {
      transform: scale(1.05);
      box-shadow: 0 4px 12px rgba(34, 197, 94, 0.4);
    }

    .achievement-claimed-badge {
      background: rgba(34, 197, 94, 0.2);
      color: #22c55e;
      border-radius: 8px;
      padding: 8px 14px;
      font-size: 13px;
      font-weight: 600;
    }

    /* Trophy Summary */
    .trophy-summary {
      display: flex;
      align-items: center;
      justify-content: space-around;
      background: linear-gradient(135deg, rgba(234, 179, 8, 0.1) 0%, rgba(251, 191, 36, 0.05) 100%);
      border: 1px solid rgba(234, 179, 8, 0.3);
      border-radius: 16px;
      padding: 20px;
      margin-bottom: 20px;
    }

    .trophy-summary-stat {
      text-align: center;
    }

    .trophy-summary-value {
      font-size: 24px;
      font-weight: 800;
      color: #22c55e;
    }

    .trophy-summary-value.unclaimed {
      color: #fbbf24;
    }

    .trophy-summary-value.potential {
      color: #64748b;
    }

    .trophy-summary-label {
      font-size: 13px;
      color: #64748b;
      text-transform: uppercase;
      margin-top: 4px;
      letter-spacing: 0.5px;
    }

    .trophy-summary-divider {
      width: 1px;
      height: 40px;
      background: rgba(71, 85, 105, 0.3);
    }

    /* Unclaimed Alert */
    .unclaimed-alert {
      display: flex;
      align-items: center;
      gap: 10px;
      background: linear-gradient(135deg, rgba(34, 197, 94, 0.15) 0%, rgba(22, 163, 74, 0.05) 100%);
      border: 1px solid rgba(34, 197, 94, 0.4);
      border-radius: 12px;
      padding: 14px 18px;
      margin-bottom: 20px;
      animation: pulse-glow 2s ease-in-out infinite;
    }

    .unclaimed-icon {
      font-size: 20px;
    }

    .unclaimed-text {
      font-size: 16px;
      font-weight: 600;
      color: #22c55e;
    }

    /* Privileges */
    .section.privileges {
      border: 1px solid rgba(168, 85, 247, 0.2);
    }

    .privileges-grid {
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    .privilege-card {
      display: flex;
      align-items: center;
      gap: 14px;
      padding: 16px;
      background: rgba(30, 41, 59, 0.5);
      border: 1px solid rgba(71, 85, 105, 0.3);
      border-radius: 14px;
    }

    .privilege-card.unlocked {
      background: linear-gradient(135deg, rgba(168, 85, 247, 0.15) 0%, rgba(124, 58, 237, 0.05) 100%);
      border-color: rgba(168, 85, 247, 0.4);
    }

    .privilege-card.used {
      opacity: 0.6;
    }

    .privilege-icon {
      width: 50px;
      height: 50px;
      border-radius: 12px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 24px;
      background: rgba(71, 85, 105, 0.3);
    }

    .privilege-card.unlocked .privilege-icon {
      background: linear-gradient(135deg, #a855f7, #7c3aed);
      box-shadow: 0 0 20px rgba(168, 85, 247, 0.4);
    }

    .privilege-info {
      flex: 1;
    }

    .privilege-name {
      font-size: 16px;
      font-weight: 700;
      color: #64748b;
    }

    .privilege-card.unlocked .privilege-name {
      color: #a855f7;
    }

    .privilege-desc {
      font-size: 13px;
      color: #64748b;
      margin-top: 2px;
    }

    .privilege-use-btn {
      background: linear-gradient(135deg, #a855f7, #7c3aed);
      color: white;
      border: none;
      border-radius: 8px;
      padding: 10px 16px;
      font-size: 14px;
      font-weight: 700;
      cursor: pointer;
    }

    .privilege-used-badge {
      background: rgba(168, 85, 247, 0.2);
      color: #a855f7;
      border-radius: 8px;
      padding: 8px 14px;
      font-size: 13px;
      font-weight: 600;
    }

    .section {
      background: rgba(15, 23, 42, 0.6);
      border-radius: 18px;
      padding: 18px;
      margin-bottom: 20px;
    }

    .section.weekly {
      border: 1px solid rgba(59, 130, 246, 0.2);
    }

    .section.nightly {
      border: 1px solid rgba(168, 85, 247, 0.2);
    }

    .section.achievements {
      border: 1px solid rgba(234, 179, 8, 0.2);
    }

    .section-header {
      display: flex;
      align-items: center;
      gap: 10px;
      margin-bottom: 16px;
      flex-wrap: wrap;
    }

    .section-icon {
      font-size: 22px;
    }

    .section-title {
      font-size: 18px;
      font-weight: 700;
      color: #f1f5f9;
    }

    .section-badge {
      padding: 4px 10px;
      border-radius: 20px;
      font-size: 12px;
      font-weight: 600;
    }

    .section.weekly .section-badge {
      background: rgba(234, 179, 8, 0.2);
      color: #fbbf24;
    }

    .section.nightly .section-badge {
      background: rgba(168, 85, 247, 0.2);
      color: #c4b5fd;
    }

    .day-tabs {
      display: flex;
      gap: 6px;
      margin-bottom: 16px;
      overflow-x: auto;
      overflow-y: hidden;
      padding-bottom: 4px;
      -webkit-overflow-scrolling: touch;
      -ms-overflow-style: none;
      scrollbar-width: none;
    }

    .day-tabs::-webkit-scrollbar {
      display: none;
    }

    .day-tab {
      flex: 1;
      min-width: 44px;
      padding: 10px 4px;
      border: none;
      border-radius: 10px;
      font-size: 13px;
      font-weight: 700;
      cursor: pointer;
      transition: all 0.2s;
      background: rgba(59, 130, 246, 0.1);
      color: #93c5fd;
    }

    .day-tab.weekend {
      background: rgba(168, 85, 247, 0.1);
      color: #c4b5fd;
    }

    .day-tab.active {
      background: linear-gradient(135deg, #3b82f6, #60a5fa);
      color: white;
      box-shadow: 0 0 15px rgba(59, 130, 246, 0.4);
    }

    .day-tab.weekend.active {
      background: linear-gradient(135deg, #a855f7, #c084fc);
      box-shadow: 0 0 15px rgba(168, 85, 247, 0.4);
    }

    .quests-list {
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    .quest-item {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 12px 14px;
      border-radius: 12px;
      transition: all 0.2s;
      border: 1px solid rgba(71, 85, 105, 0.3);
      background: rgba(30, 41, 59, 0.5);
      cursor: pointer;
    }

    .quest-help-slot {
      width: 44px;
      height: 44px;
      flex-shrink: 0;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .quest-help-btn {
      width: 44px;
      height: 44px;
      min-width: 44px;
      min-height: 44px;
      border: 1px solid rgba(147, 197, 253, 0.3);
      border-radius: 50%;
      background: rgba(59, 130, 246, 0.15);
      color: #93c5fd;
      font-size: 18px;
      font-weight: 700;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 0;
      transition: all 0.2s;
    }

    .quest-help-btn:hover {
      transform: scale(1.1);
      color: #60a5fa;
      background: rgba(59, 130, 246, 0.25);
    }

    .quest-item.completed {
      background: linear-gradient(135deg, rgba(34, 197, 94, 0.2) 0%, rgba(34, 197, 94, 0.1) 100%);
      border-color: rgba(34, 197, 94, 0.4);
    }

    .quest-icon {
      font-size: 28px;
      width: 40px;
      text-align: center;
    }

    .quest-info {
      flex: 1;
    }

    .quest-name {
      font-size: 16px;
      font-weight: 700;
      color: #e2e8f0;
    }

    .quest-item.completed .quest-name {
      color: #86efac;
    }

    .quest-desc {
      font-size: 13px;
      color: #94a3b8;
    }

    .quest-xp {
      font-size: 14px;
      font-weight: 700;
      color: #fbbf24;
      background: rgba(234, 179, 8, 0.15);
      padding: 6px 12px;
      border-radius: 20px;
    }

    .quest-item.completed .quest-xp {
      color: #4ade80;
      background: rgba(34, 197, 94, 0.2);
    }

    .nightly-info {
      font-size: 14px;
      color: #94a3b8;
      padding: 14px;
      background: rgba(168, 85, 247, 0.1);
      border-radius: 10px;
      border-left: 3px solid #a855f7;
      margin-bottom: 16px;
    }

    .nightly-grid {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 10px;
    }

    .nightly-item {
      padding: 16px 10px;
      border-radius: 12px;
      text-align: center;
      cursor: pointer;
      transition: all 0.2s;
      border: 1px solid rgba(71, 85, 105, 0.3);
      background: rgba(30, 41, 59, 0.5);
    }

    .nightly-item.completed {
      background: linear-gradient(135deg, #a855f7 0%, #7c3aed 100%);
      border-color: #c4b5fd;
      box-shadow: 0 0 15px rgba(168, 85, 247, 0.4);
    }

    .nightly-icon {
      font-size: 24px;
      margin-bottom: 6px;
    }

    .nightly-label {
      font-size: 13px;
      font-weight: 600;
      color: #94a3b8;
    }

    .nightly-item.completed .nightly-label {
      color: white;
    }

    .actions {
      display: flex;
      gap: 10px;
      margin-top: 20px;
    }

    .btn {
      flex: 1;
      padding: 14px;
      border-radius: 12px;
      font-size: 15px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
      border: none;
    }

    .btn-primary {
      background: linear-gradient(135deg, #3b82f6, #60a5fa);
      color: white;
    }

    .btn-secondary {
      background: transparent;
      border: 1px solid rgba(59, 130, 246, 0.3);
      color: #93c5fd;
    }

    /* Pay Scale */
    .pay-scale {
      background: rgba(15, 23, 42, 0.6);
      border: 1px solid rgba(34, 197, 94, 0.2);
      border-radius: 14px;
      padding: 16px;
      margin-bottom: 20px;
    }

    .pay-scale-title {
      font-size: 14px;
      font-weight: 700;
      color: #86efac;
      margin-bottom: 12px;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .pay-tiers {
      display: flex;
      flex-direction: column;
      gap: 6px;
    }

    .pay-tier {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 10px 14px;
      border-radius: 8px;
      font-size: 14px;
      background: rgba(30, 41, 59, 0.5);
    }

    .pay-tier.current {
      background: linear-gradient(135deg, rgba(34, 197, 94, 0.3) 0%, rgba(34, 197, 94, 0.1) 100%);
      border: 1px solid rgba(34, 197, 94, 0.4);
    }

    .pay-tier-name {
      font-weight: 600;
    }

    .pay-tier-range {
      color: #64748b;
      font-size: 13px;
    }

    .pay-tier-amount {
      font-weight: 800;
      color: #22c55e;
    }

    /* Modal Overlay */
    .modal-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.8);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 300;
      padding: 20px;
    }

    .modal-overlay.show {
      display: flex;
    }

    .modal {
      background: linear-gradient(135deg, #1e293b 0%, #0f172a 100%);
      border: 2px solid rgba(59, 130, 246, 0.4);
      border-radius: 24px;
      padding: 30px;
      max-width: 400px;
      width: 100%;
      max-height: 85vh;
      overflow-y: auto;
      -webkit-overflow-scrolling: touch;
      -ms-overflow-style: none;
      scrollbar-width: none;
      animation: modalPop 0.3s ease;
    }

    .modal::-webkit-scrollbar {
      display: none;
    }

    @keyframes modalPop {
      from { transform: scale(0.8); opacity: 0; }
      to { transform: scale(1); opacity: 1; }
    }

    .modal-title {
      font-size: 20px;
      font-weight: 800;
      color: #f1f5f9;
      margin-bottom: 20px;
      text-align: center;
    }

    /* PIN Input */
    .pin-container {
      text-align: center;
    }

    .pin-input {
      display: flex;
      justify-content: center;
      gap: 10px;
      margin: 20px 0;
    }

    .pin-digit {
      width: 50px;
      height: 60px;
      border-radius: 12px;
      border: 2px solid rgba(59, 130, 246, 0.3);
      background: rgba(30, 41, 59, 0.8);
      color: #e2e8f0;
      font-size: 24px;
      font-weight: 700;
      text-align: center;
    }

    .pin-digit:focus {
      border-color: #3b82f6;
      outline: none;
    }

    .pin-error {
      color: #f87171;
      font-size: 14px;
      margin-top: 10px;
      display: none;
    }

    .pin-error.show {
      display: block;
    }

    /* Settings Panel */
    .settings-tabs {
      display: flex;
      gap: 6px;
      margin-bottom: 20px;
      overflow-x: auto;
      overflow-y: hidden;
      -webkit-overflow-scrolling: touch;
      -ms-overflow-style: none;
      scrollbar-width: none;
    }

    .settings-tabs::-webkit-scrollbar {
      display: none;
    }

    .settings-tab {
      padding: 10px 14px;
      border: none;
      border-radius: 8px;
      font-size: 13px;
      font-weight: 700;
      cursor: pointer;
      background: rgba(59, 130, 246, 0.1);
      color: #93c5fd;
      white-space: nowrap;
    }

    .settings-tab.active {
      background: linear-gradient(135deg, #3b82f6, #60a5fa);
      color: white;
    }

    .settings-content {
      display: none;
    }

    .settings-content.active {
      display: block;
    }

    .form-group {
      margin-bottom: 16px;
    }

    .form-label {
      display: block;
      font-size: 14px;
      font-weight: 600;
      color: #94a3b8;
      margin-bottom: 6px;
    }

    .form-input, .form-select {
      width: 100%;
      padding: 12px;
      border-radius: 10px;
      border: 1px solid rgba(59, 130, 246, 0.3);
      background: rgba(30, 41, 59, 0.8);
      color: #e2e8f0;
      font-size: 14px;
    }

    .form-input:focus, .form-select:focus {
      border-color: #3b82f6;
      outline: none;
    }

    .day-checkbox {
      display: flex;
      align-items: center;
      gap: 4px;
      padding: 10px 14px;
      background: rgba(30, 41, 59, 0.8);
      border: 1px solid rgba(59, 130, 246, 0.3);
      border-radius: 8px;
      cursor: pointer;
      font-size: 15px;
      color: #94a3b8;
      transition: all 0.2s;
    }

    .day-checkbox:has(input:checked) {
      background: rgba(59, 130, 246, 0.3);
      border-color: #3b82f6;
      color: #e2e8f0;
    }

    .day-checkbox input {
      display: none;
    }

    .btn-lg {
      width: 100%;
      padding: 14px;
      margin-top: 10px;
    }

    .item-list {
      display: flex;
      flex-direction: column;
      gap: 10px;
      margin-bottom: 16px;
    }

    .earnings-tally-container {
      margin-top: 20px;
      padding: 16px;
      background: linear-gradient(135deg, rgba(34, 197, 94, 0.1) 0%, rgba(59, 130, 246, 0.1) 100%);
      border-radius: 16px;
      border: 1px solid rgba(34, 197, 94, 0.3);
    }

    .earnings-tally-title {
      font-size: 16px;
      font-weight: 700;
      color: #e2e8f0;
      margin-bottom: 16px;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .earnings-tally-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px;
      margin-bottom: 16px;
    }

    .earnings-tally-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 10px 14px;
      background: rgba(15, 23, 42, 0.5);
      border-radius: 8px;
      font-size: 14px;
    }

    .earnings-tally-label {
      color: #94a3b8;
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .earnings-tally-value {
      font-weight: 600;
      color: #fbbf24;
    }

    .earnings-tally-total {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 12px 16px;
      background: rgba(34, 197, 94, 0.2);
      border-radius: 12px;
      margin-top: 12px;
    }

    .earnings-tally-total-label {
      font-size: 14px;
      font-weight: 600;
      color: #e2e8f0;
    }

    .earnings-tally-total-values {
      text-align: right;
    }

    .earnings-tally-xp {
      font-size: 18px;
      font-weight: 800;
      color: #fbbf24;
    }

    .earnings-tally-pay {
      font-size: 14px;
      font-weight: 700;
      color: #22c55e;
    }

    .item-card {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 12px;
      border-radius: 10px;
      background: rgba(30, 41, 59, 0.5);
      border: 1px solid rgba(71, 85, 105, 0.3);
    }

    .item-icon {
      font-size: 24px;
    }

    .item-info {
      flex: 1;
    }

    .item-name {
      font-size: 16px;
      font-weight: 600;
      color: #e2e8f0;
    }

    .item-desc {
      font-size: 13px;
      color: #64748b;
    }

    .item-btn {
      width: 32px;
      height: 32px;
      border-radius: 8px;
      border: none;
      background: rgba(239, 68, 68, 0.2);
      color: #f87171;
      font-size: 14px;
      cursor: pointer;
    }

    .avatar-picker {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
    }

    .avatar-option {
      width: 44px;
      height: 44px;
      border-radius: 10px;
      border: 2px solid rgba(255, 255, 255, 0.1);
      background: rgba(30, 41, 59, 0.8);
      font-size: 24px;
      cursor: pointer;
      transition: all 0.2s;
    }

    .avatar-option:hover {
      border-color: rgba(59, 130, 246, 0.5);
      transform: scale(1.05);
    }

    .avatar-option.selected {
      border-color: #3b82f6;
      background: rgba(59, 130, 246, 0.2);
      box-shadow: 0 0 10px rgba(59, 130, 246, 0.3);
    }

    /* Link Code Display */
    .link-code-display {
      text-align: center;
      padding: 20px;
      background: rgba(34, 197, 94, 0.1);
      border: 1px solid rgba(34, 197, 94, 0.3);
      border-radius: 14px;
      margin: 16px 0;
    }

    .link-code {
      font-size: 36px;
      font-weight: 900;
      color: #22c55e;
      letter-spacing: 8px;
      font-family: monospace;
    }

    .link-code-label {
      font-size: 13px;
      color: #86efac;
      margin-bottom: 8px;
    }

    .link-code-expires {
      font-size: 13px;
      color: #64748b;
      margin-top: 8px;
    }

    /* Toast */
    .toast {
      position: fixed;
      top: 20px;
      left: 50%;
      transform: translateX(-50%) translateY(-100px);
      background: linear-gradient(135deg, #22c55e, #16a34a);
      color: white;
      padding: 12px 24px;
      border-radius: 12px;
      font-size: 14px;
      font-weight: 600;
      box-shadow: 0 10px 40px rgba(0,0,0,0.3);
      transition: transform 0.3s ease;
      z-index: 400;
    }

    .toast.show {
      transform: translateX(-50%) translateY(0);
    }

    .toast.error {
      background: linear-gradient(135deg, #ef4444, #dc2626);
    }

    /* Setup Wizard */
    .setup-wizard {
      text-align: center;
      padding: 20px 0;
    }

    .setup-step {
      display: none;
    }

    .setup-step.active {
      display: block;
    }

    .setup-icon {
      font-size: 60px;
      margin-bottom: 16px;
    }

    .setup-title {
      font-size: 24px;
      font-weight: 800;
      color: #f1f5f9;
      margin-bottom: 8px;
    }

    .setup-desc {
      font-size: 14px;
      color: #94a3b8;
      margin-bottom: 24px;
    }

    /* Loading */
    .loading {
      text-align: center;
      padding: 60px 20px;
      color: #94a3b8;
    }

    .loading-spinner {
      width: 40px;
      height: 40px;
      border: 3px solid rgba(59, 130, 246, 0.3);
      border-top-color: #3b82f6;
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin: 0 auto 16px;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    /* Empty State */
    .empty-state {
      text-align: center;
      padding: 40px 20px;
      color: #64748b;
    }

    .empty-icon {
      font-size: 48px;
      margin-bottom: 12px;
    }

    .empty-text {
      font-size: 16px;
    }

    /* Help Content */
    .help-content {
      font-size: 15px;
      line-height: 1.6;
      color: #94a3b8;
    }

    .help-section {
      margin-bottom: 20px;
    }

    .help-section h3 {
      font-size: 16px;
      font-weight: 700;
      color: #f1f5f9;
      margin-bottom: 8px;
    }

    .help-section ul {
      padding-left: 20px;
    }

    .help-section li {
      margin-bottom: 6px;
    }

    /* Payday Modal */
    .payday-modal {
      text-align: center;
    }

    .payday-icon {
      font-size: 60px;
      margin-bottom: 16px;
    }

    .payday-title {
      font-size: 28px;
      font-weight: 900;
      color: #22c55e;
      margin-bottom: 8px;
    }

    .payday-subtitle {
      color: #94a3b8;
      font-size: 14px;
      margin-bottom: 24px;
    }

    .payday-amount {
      font-size: 56px;
      font-weight: 900;
      color: #22c55e;
      text-shadow: 0 0 40px rgba(34, 197, 94, 0.5);
      margin-bottom: 24px;
    }

    .payday-details {
      text-align: left;
      background: rgba(30, 41, 59, 0.5);
      border-radius: 12px;
      padding: 16px;
      margin-bottom: 24px;
    }

    .payday-row {
      display: flex;
      justify-content: space-between;
      padding: 10px 0;
      font-size: 15px;
      border-bottom: 1px solid rgba(71, 85, 105, 0.3);
    }

    .payday-row:last-child {
      border-bottom: none;
      font-weight: 700;
      font-size: 16px;
      padding-top: 12px;
    }

    /* Avatar selection */
    .avatar-grid {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
      margin-top: 8px;
    }

    .avatar-btn {
      font-size: 28px;
      padding: 8px;
      border: 2px solid transparent;
      border-radius: 10px;
      background: rgba(30,41,59,0.5);
      cursor: pointer;
    }

    .avatar-btn.selected {
      border-color: #3b82f6;
      background: rgba(59,130,246,0.2);
    }

    /* Theme Cards */
    .theme-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 12px;
    }

    .theme-card {
      padding: 16px;
      border-radius: 14px;
      cursor: pointer;
      transition: all 0.2s;
      text-align: center;
      border: 2px solid transparent;
    }

    .theme-card:hover {
      transform: scale(1.02);
    }

    .theme-card.selected {
      border-color: #fbbf24;
      box-shadow: 0 0 20px rgba(251, 191, 36, 0.3);
    }

    .theme-card-icon {
      font-size: 36px;
      margin-bottom: 8px;
    }

    .theme-card-name {
      font-size: 13px;
      font-weight: 700;
      margin-bottom: 4px;
    }

    .theme-card-desc {
      font-size: 12px;
      opacity: 0.7;
    }

    /* ============================================ */
    /* THEME: Default (Quest) */
    /* ============================================ */
    .theme-default {
      --bg-primary: #0f0f1a;
      --bg-secondary: #1a1a2e;
      --bg-tertiary: #16213e;
      --accent-primary: #3b82f6;
      --accent-secondary: #60a5fa;
      --accent-glow: rgba(59, 130, 246, 0.3);
      --text-primary: #e2e8f0;
      --text-secondary: #94a3b8;
      --success: #22c55e;
      --warning: #fbbf24;
      --xp-color: #fbbf24;
    }

    /* ============================================ */
    /* THEME: Roblox */
    /* ============================================ */
    .theme-roblox {
      --bg-primary: #1a1a1a;
      --bg-secondary: #2d2d2d;
      --bg-tertiary: #393939;
      --accent-primary: #00a2ff;
      --accent-secondary: #00d4aa;
      --accent-glow: rgba(0, 162, 255, 0.3);
      --text-primary: #ffffff;
      --text-secondary: #b8b8b8;
      --success: #00d4aa;
      --warning: #ffcc00;
      --xp-color: #00d4aa;
    }

    .theme-roblox body {
      background: linear-gradient(180deg, #1a1a1a 0%, #2d2d2d 100%) !important;
      font-family: 'Trebuchet MS', 'Lucida Sans', Arial, sans-serif !important;
    }

    .theme-roblox .header {
      background: linear-gradient(135deg, rgba(0, 162, 255, 0.2) 0%, rgba(0, 212, 170, 0.1) 100%) !important;
      border-color: rgba(0, 162, 255, 0.4) !important;
      border-radius: 8px !important;
    }

    .theme-roblox .header h1 {
      background: linear-gradient(135deg, #00a2ff 0%, #00d4aa 100%) !important;
      -webkit-background-clip: text !important;
      font-family: 'Trebuchet MS', sans-serif !important;
      letter-spacing: 2px;
    }

    .theme-roblox .stat-card {
      border-radius: 8px !important;
      border-width: 2px !important;
    }

    .theme-roblox .stat-card.level {
      background: linear-gradient(135deg, rgba(0, 162, 255, 0.2) 0%, rgba(0, 162, 255, 0.05) 100%) !important;
      border-color: rgba(0, 162, 255, 0.4) !important;
    }

    .theme-roblox .stat-card.xp {
      background: linear-gradient(135deg, rgba(0, 212, 170, 0.2) 0%, rgba(0, 212, 170, 0.05) 100%) !important;
      border-color: rgba(0, 212, 170, 0.4) !important;
    }

    .theme-roblox .stat-card.rank {
      background: linear-gradient(135deg, rgba(255, 204, 0, 0.15) 0%, rgba(255, 204, 0, 0.05) 100%) !important;
      border-color: rgba(255, 204, 0, 0.3) !important;
    }

    .theme-roblox .stat-value {
      color: #ffffff !important;
    }

    .theme-roblox .stat-label {
      color: #b8b8b8 !important;
    }

    .theme-roblox .section {
      border-radius: 8px !important;
      background: rgba(45, 45, 45, 0.8) !important;
      border-color: rgba(0, 162, 255, 0.2) !important;
    }

    .theme-roblox .quest-item {
      border-radius: 8px !important;
      border-width: 2px !important;
      background: rgba(45, 45, 45, 0.6) !important;
      border-color: rgba(0, 162, 255, 0.3) !important;
    }

    .theme-roblox .quest-item.completed {
      background: linear-gradient(135deg, rgba(0, 212, 170, 0.3) 0%, rgba(0, 212, 170, 0.1) 100%) !important;
      border-color: #00d4aa !important;
    }

    .theme-roblox .quest-name {
      color: #ffffff !important;
    }

    .theme-roblox .btn-primary {
      background: linear-gradient(135deg, #00a2ff, #00d4aa) !important;
      border-radius: 8px !important;
      font-weight: 800 !important;
      text-transform: uppercase;
      letter-spacing: 1px;
    }

    .theme-roblox .tab-btn {
      color: #b8b8b8 !important;
    }

    .theme-roblox .tab-btn.active {
      background: linear-gradient(135deg, #00a2ff, #00d4aa) !important;
      color: #ffffff !important;
    }

    .theme-roblox .day-tab {
      color: #b8b8b8 !important;
    }

    .theme-roblox .day-tab.active {
      background: rgba(0, 162, 255, 0.3) !important;
      color: #00a2ff !important;
      border-color: rgba(0, 162, 255, 0.5) !important;
    }

    .theme-roblox .nightly-item {
      background: rgba(45, 45, 45, 0.6) !important;
      border-color: rgba(0, 162, 255, 0.3) !important;
    }

    .theme-roblox .nightly-item.completed {
      background: linear-gradient(135deg, #00d4aa 0%, #00a2ff 100%) !important;
    }

    .theme-roblox .quest-xp,
    .theme-roblox .section-badge {
      background: rgba(0, 212, 170, 0.2) !important;
      color: #00d4aa !important;
    }

    .theme-roblox .quest-help-btn {
      border-color: rgba(0, 162, 255, 0.4) !important;
      background: rgba(0, 162, 255, 0.2) !important;
      color: #00a2ff !important;
    }

    /* ============================================ */
    /* THEME: Fortnite */
    /* ============================================ */
    .theme-fortnite {
      --bg-primary: #0d1b2a;
      --bg-secondary: #1b263b;
      --bg-tertiary: #415a77;
      --accent-primary: #9d4edd;
      --accent-secondary: #e0aaff;
      --accent-glow: rgba(157, 78, 221, 0.4);
      --text-primary: #ffffff;
      --text-secondary: #adb5bd;
      --success: #06ffa5;
      --warning: #ffe66d;
      --xp-color: #ffe66d;
    }

    .theme-fortnite body {
      background: linear-gradient(135deg, #0d1b2a 0%, #1b263b 50%, #0d1b2a 100%) !important;
      font-family: 'Segoe UI', 'Burbank Big', Arial, sans-serif !important;
    }

    .theme-fortnite .grid-bg {
      background-image:
        radial-gradient(circle at 20% 80%, rgba(157, 78, 221, 0.1) 0%, transparent 50%),
        radial-gradient(circle at 80% 20%, rgba(224, 170, 255, 0.1) 0%, transparent 50%),
        linear-gradient(rgba(157, 78, 221, 0.02) 1px, transparent 1px),
        linear-gradient(90deg, rgba(157, 78, 221, 0.02) 1px, transparent 1px) !important;
    }

    .theme-fortnite .header {
      background: linear-gradient(135deg, rgba(157, 78, 221, 0.2) 0%, rgba(224, 170, 255, 0.1) 100%) !important;
      border-color: rgba(157, 78, 221, 0.5) !important;
      border-width: 2px !important;
    }

    .theme-fortnite .header h1 {
      background: linear-gradient(135deg, #e0aaff 0%, #9d4edd 50%, #ffe66d 100%) !important;
      -webkit-background-clip: text !important;
      text-transform: uppercase;
      letter-spacing: 3px;
    }

    .theme-fortnite .header-tag {
      color: #e0aaff !important;
    }

    .theme-fortnite .stat-card.level {
      background: linear-gradient(135deg, rgba(6, 255, 165, 0.2) 0%, rgba(6, 255, 165, 0.05) 100%) !important;
      border-color: rgba(6, 255, 165, 0.4) !important;
    }

    .theme-fortnite .stat-card.level .stat-value {
      color: #06ffa5 !important;
      text-shadow: 0 0 20px rgba(6, 255, 165, 0.5);
    }

    .theme-fortnite .stat-card.xp {
      background: linear-gradient(135deg, rgba(157, 78, 221, 0.2) 0%, rgba(157, 78, 221, 0.05) 100%) !important;
      border-color: rgba(157, 78, 221, 0.4) !important;
    }

    .theme-fortnite .stat-card.xp .stat-value {
      color: #e0aaff !important;
    }

    .theme-fortnite .section.weekly {
      border-color: rgba(157, 78, 221, 0.4) !important;
      background: rgba(27, 38, 59, 0.8) !important;
    }

    .theme-fortnite .section.nightly {
      border-color: rgba(6, 255, 165, 0.3) !important;
      background: rgba(27, 38, 59, 0.8) !important;
    }

    .theme-fortnite .quest-item {
      background: rgba(65, 90, 119, 0.4) !important;
      border-color: rgba(157, 78, 221, 0.3) !important;
    }

    .theme-fortnite .quest-item.completed {
      background: linear-gradient(135deg, rgba(6, 255, 165, 0.3) 0%, rgba(6, 255, 165, 0.1) 100%) !important;
      border-color: #06ffa5 !important;
    }

    .theme-fortnite .quest-item.completed .quest-name {
      color: #06ffa5 !important;
    }

    .theme-fortnite .quest-xp {
      background: rgba(255, 230, 109, 0.2) !important;
      color: #ffe66d !important;
    }

    .theme-fortnite .tab-btn.active {
      background: linear-gradient(135deg, #9d4edd, #e0aaff) !important;
    }

    .theme-fortnite .day-tab.active {
      background: linear-gradient(135deg, #9d4edd, #e0aaff) !important;
    }

    .theme-fortnite .btn-primary {
      background: linear-gradient(135deg, #9d4edd, #e0aaff) !important;
      text-transform: uppercase;
      letter-spacing: 1px;
      font-weight: 800 !important;
    }

    .theme-fortnite .nightly-item.completed {
      background: linear-gradient(135deg, #9d4edd 0%, #06ffa5 100%) !important;
    }

    .theme-fortnite .wallet-card {
      background: linear-gradient(135deg, rgba(6, 255, 165, 0.2) 0%, rgba(157, 78, 221, 0.1) 100%) !important;
      border-color: rgba(6, 255, 165, 0.4) !important;
    }

    .theme-fortnite .wallet-amount {
      color: #06ffa5 !important;
      text-shadow: 0 0 30px rgba(6, 255, 165, 0.6);
    }

    /* ============================================ */
    /* THEME: Minecraft */
    /* ============================================ */
    .theme-minecraft {
      --bg-primary: #2d1f0f;
      --bg-secondary: #3d2914;
      --bg-tertiary: #5c4023;
      --accent-primary: #5d8c2e;
      --accent-secondary: #7cb342;
      --accent-glow: rgba(93, 140, 46, 0.3);
      --text-primary: #ffffff;
      --text-secondary: #c9b896;
      --success: #5d8c2e;
      --warning: #ffc107;
      --xp-color: #7cb342;
    }

    .theme-minecraft body {
      background: linear-gradient(180deg, #2d1f0f 0%, #1a1209 100%) !important;
      font-family: 'Courier New', monospace !important;
      image-rendering: pixelated;
    }

    .theme-minecraft .grid-bg {
      background-image:
        repeating-linear-gradient(
          0deg,
          transparent,
          transparent 16px,
          rgba(93, 140, 46, 0.03) 16px,
          rgba(93, 140, 46, 0.03) 17px
        ),
        repeating-linear-gradient(
          90deg,
          transparent,
          transparent 16px,
          rgba(93, 140, 46, 0.03) 16px,
          rgba(93, 140, 46, 0.03) 17px
        ) !important;
    }

    .theme-minecraft .header {
      background: linear-gradient(180deg, #5c4023 0%, #3d2914 100%) !important;
      border: 4px solid #2d1f0f !important;
      border-radius: 0 !important;
      box-shadow: inset 0 2px 0 rgba(255,255,255,0.1), inset 0 -2px 0 rgba(0,0,0,0.3);
    }

    .theme-minecraft .header h1 {
      background: linear-gradient(180deg, #7cb342 0%, #5d8c2e 100%) !important;
      -webkit-background-clip: text !important;
      font-family: 'Courier New', monospace !important;
      letter-spacing: 4px;
      text-shadow: 2px 2px 0 #2d1f0f;
    }

    .theme-minecraft .stat-card,
    .theme-minecraft .section,
    .theme-minecraft .quest-item,
    .theme-minecraft .nightly-item,
    .theme-minecraft .btn,
    .theme-minecraft .tab-btn,
    .theme-minecraft .day-tab,
    .theme-minecraft .modal {
      border-radius: 0 !important;
    }

    .theme-minecraft .stat-card {
      background: linear-gradient(180deg, #5c4023 0%, #3d2914 100%) !important;
      border: 3px solid #2d1f0f !important;
      box-shadow: inset 0 2px 0 rgba(255,255,255,0.1), inset 0 -2px 0 rgba(0,0,0,0.3);
    }

    .theme-minecraft .section {
      background: linear-gradient(180deg, #3d2914 0%, #2d1f0f 100%) !important;
      border: 3px solid #5c4023 !important;
    }

    .theme-minecraft .quest-item {
      background: #5c4023 !important;
      border: 2px solid #2d1f0f !important;
    }

    .theme-minecraft .quest-item.completed {
      background: linear-gradient(180deg, #5d8c2e 0%, #4a7024 100%) !important;
      border-color: #7cb342 !important;
    }

    .theme-minecraft .tab-btn.active,
    .theme-minecraft .day-tab.active {
      background: linear-gradient(180deg, #5d8c2e 0%, #4a7024 100%) !important;
      border: 2px solid #7cb342;
    }

    .theme-minecraft .btn-primary {
      background: linear-gradient(180deg, #5d8c2e 0%, #4a7024 100%) !important;
      border: 3px solid #2d1f0f !important;
      box-shadow: inset 0 2px 0 rgba(255,255,255,0.2), inset 0 -2px 0 rgba(0,0,0,0.3);
      text-transform: uppercase;
    }

    .theme-minecraft .nightly-item.completed {
      background: linear-gradient(180deg, #5d8c2e 0%, #4a7024 100%) !important;
    }

    .theme-minecraft .quest-xp,
    .theme-minecraft .section-badge {
      background: rgba(124, 179, 66, 0.3) !important;
      color: #7cb342 !important;
      border-radius: 0 !important;
    }

    .theme-minecraft .wallet-card {
      background: linear-gradient(180deg, #5c4023 0%, #3d2914 100%) !important;
      border: 3px solid #5d8c2e !important;
      border-radius: 0 !important;
    }

    .theme-minecraft .wallet-amount {
      color: #7cb342 !important;
      font-family: 'Courier New', monospace !important;
    }

    /* ============================================ */
    /* THEME: Barbie / Dreamhouse */
    /* ============================================ */
    .theme-barbie {
      --bg-primary: #ff1493;
      --bg-secondary: #ff69b4;
      --bg-tertiary: #ffb6c1;
      --accent-primary: #ff69b4;
      --accent-secondary: #fff0f5;
      --accent-glow: rgba(255, 105, 180, 0.4);
      --text-primary: #ffffff;
      --text-secondary: #ffe4ec;
      --success: #ff69b4;
      --warning: #ffd700;
      --xp-color: #ff69b4;
    }

    .theme-barbie body {
      background: linear-gradient(135deg, #ff1493 0%, #ff69b4 50%, #ffb6c1 100%) !important;
      font-family: 'Comic Sans MS', 'Chalkboard SE', cursive !important;
    }

    .theme-barbie .grid-bg {
      background-image: radial-gradient(circle at 20% 50%, rgba(255, 255, 255, 0.1) 0%, transparent 50%),
                        radial-gradient(circle at 80% 50%, rgba(255, 255, 255, 0.1) 0%, transparent 50%) !important;
    }

    .theme-barbie .header {
      background: linear-gradient(135deg, rgba(255, 255, 255, 0.3) 0%, rgba(255, 182, 193, 0.3) 100%) !important;
      border-color: rgba(255, 255, 255, 0.5) !important;
      border-radius: 20px !important;
    }

    .theme-barbie .header h1 {
      background: linear-gradient(135deg, #ffffff 0%, #ffe4ec 100%) !important;
      -webkit-background-clip: text !important;
      text-shadow: 2px 2px 4px rgba(255, 20, 147, 0.3);
    }

    .theme-barbie .stat-card {
      background: linear-gradient(135deg, rgba(255, 255, 255, 0.25) 0%, rgba(255, 182, 193, 0.2) 100%) !important;
      border-color: rgba(255, 255, 255, 0.4) !important;
      border-radius: 16px !important;
    }

    .theme-barbie .section {
      background: rgba(255, 255, 255, 0.2) !important;
      border-color: rgba(255, 255, 255, 0.3) !important;
      border-radius: 20px !important;
    }

    .theme-barbie .quest-item {
      background: rgba(255, 255, 255, 0.25) !important;
      border-color: rgba(255, 255, 255, 0.4) !important;
      border-radius: 14px !important;
    }

    .theme-barbie .quest-item.completed {
      background: linear-gradient(135deg, rgba(255, 215, 0, 0.4) 0%, rgba(255, 255, 255, 0.3) 100%) !important;
      border-color: #ffd700 !important;
    }

    .theme-barbie .btn-primary {
      background: linear-gradient(135deg, #ffffff, #ffe4ec) !important;
      color: #ff1493 !important;
      border-radius: 25px !important;
      font-weight: 700 !important;
    }

    .theme-barbie .tab-btn.active {
      background: rgba(255, 255, 255, 0.4) !important;
      color: #ff1493 !important;
    }

    .theme-barbie .nightly-item.completed {
      background: linear-gradient(135deg, #ffd700 0%, #ffec8b 100%) !important;
    }

    .theme-barbie .quest-xp,
    .theme-barbie .section-badge {
      background: rgba(255, 255, 255, 0.3) !important;
      color: #ffffff !important;
    }

    /* ============================================ */
    /* THEME: Animal Crossing / Island Life */
    /* ============================================ */
    .theme-animalcrossing {
      --bg-primary: #4db6ac;
      --bg-secondary: #7ed6a5;
      --bg-tertiary: #a5d6a7;
      --accent-primary: #81c784;
      --accent-secondary: #fff59d;
      --accent-glow: rgba(129, 199, 132, 0.4);
      --text-primary: #1b5e20;
      --text-secondary: #2e7d32;
      --success: #66bb6a;
      --warning: #fff176;
      --xp-color: #ffc107;
    }

    .theme-animalcrossing body {
      background: linear-gradient(180deg, #87ceeb 0%, #7ed6a5 40%, #4db6ac 100%) !important;
      font-family: 'Comic Sans MS', 'Marker Felt', fantasy !important;
    }

    .theme-animalcrossing .grid-bg {
      background-image: radial-gradient(ellipse at top, rgba(255, 255, 255, 0.3) 0%, transparent 60%) !important;
    }

    .theme-animalcrossing .header {
      background: linear-gradient(135deg, rgba(255, 255, 255, 0.5) 0%, rgba(165, 214, 167, 0.4) 100%) !important;
      border-color: rgba(129, 199, 132, 0.5) !important;
      border-radius: 20px !important;
    }

    .theme-animalcrossing .header h1 {
      background: linear-gradient(135deg, #2e7d32 0%, #1b5e20 100%) !important;
      -webkit-background-clip: text !important;
    }

    .theme-animalcrossing .stat-card {
      background: rgba(255, 255, 255, 0.6) !important;
      border-color: rgba(129, 199, 132, 0.5) !important;
      color: #1b5e20 !important;
      border-radius: 16px !important;
    }

    .theme-animalcrossing .stat-card .stat-value,
    .theme-animalcrossing .stat-card .stat-label {
      color: #1b5e20 !important;
    }

    .theme-animalcrossing .section {
      background: rgba(255, 255, 255, 0.5) !important;
      border-color: rgba(129, 199, 132, 0.4) !important;
      border-radius: 20px !important;
    }

    .theme-animalcrossing .section-title {
      color: #1b5e20 !important;
    }

    .theme-animalcrossing .quest-item {
      background: rgba(255, 255, 255, 0.7) !important;
      border-color: rgba(129, 199, 132, 0.5) !important;
      border-radius: 14px !important;
    }

    .theme-animalcrossing .quest-name,
    .theme-animalcrossing .quest-desc {
      color: #1b5e20 !important;
    }

    .theme-animalcrossing .quest-item.completed {
      background: linear-gradient(135deg, rgba(255, 245, 157, 0.8) 0%, rgba(255, 255, 255, 0.6) 100%) !important;
      border-color: #ffc107 !important;
    }

    .theme-animalcrossing .btn-primary {
      background: linear-gradient(135deg, #81c784, #66bb6a) !important;
      color: #ffffff !important;
      border-radius: 25px !important;
    }

    .theme-animalcrossing .tab-btn {
      color: #1b5e20 !important;
    }

    .theme-animalcrossing .tab-btn.active {
      background: #81c784 !important;
      color: #ffffff !important;
    }

    .theme-animalcrossing .nightly-item.completed {
      background: linear-gradient(135deg, #fff59d 0%, #ffc107 100%) !important;
    }

    .theme-animalcrossing .quest-xp,
    .theme-animalcrossing .section-badge {
      background: rgba(255, 193, 7, 0.3) !important;
      color: #f57f17 !important;
    }

    /* ============================================ */
    /* THEME: Gacha Life / Studio */
    /* ============================================ */
    .theme-gacha {
      --bg-primary: #e1bee7;
      --bg-secondary: #ce93d8;
      --bg-tertiary: #f3e5f5;
      --accent-primary: #ba68c8;
      --accent-secondary: #f48fb1;
      --accent-glow: rgba(186, 104, 200, 0.4);
      --text-primary: #4a148c;
      --text-secondary: #6a1b9a;
      --success: #ab47bc;
      --warning: #f48fb1;
      --xp-color: #9c27b0;
    }

    .theme-gacha body {
      background: linear-gradient(135deg, #f3e5f5 0%, #e1bee7 50%, #ce93d8 100%) !important;
      font-family: 'Comic Sans MS', cursive !important;
    }

    .theme-gacha .grid-bg {
      background-image: radial-gradient(circle at 10% 20%, rgba(244, 143, 177, 0.2) 0%, transparent 40%),
                        radial-gradient(circle at 90% 80%, rgba(186, 104, 200, 0.2) 0%, transparent 40%) !important;
    }

    .theme-gacha .header {
      background: linear-gradient(135deg, rgba(255, 255, 255, 0.6) 0%, rgba(225, 190, 231, 0.5) 100%) !important;
      border-color: rgba(186, 104, 200, 0.4) !important;
      border-radius: 20px !important;
    }

    .theme-gacha .header h1 {
      background: linear-gradient(135deg, #9c27b0 0%, #e91e63 100%) !important;
      -webkit-background-clip: text !important;
    }

    .theme-gacha .stat-card {
      background: rgba(255, 255, 255, 0.6) !important;
      border-color: rgba(186, 104, 200, 0.4) !important;
      color: #4a148c !important;
      border-radius: 16px !important;
    }

    .theme-gacha .stat-card .stat-value,
    .theme-gacha .stat-card .stat-label {
      color: #4a148c !important;
    }

    .theme-gacha .section {
      background: rgba(255, 255, 255, 0.5) !important;
      border-color: rgba(186, 104, 200, 0.3) !important;
      border-radius: 20px !important;
    }

    .theme-gacha .section-title {
      color: #4a148c !important;
    }

    .theme-gacha .quest-item {
      background: rgba(255, 255, 255, 0.7) !important;
      border-color: rgba(186, 104, 200, 0.4) !important;
      border-radius: 14px !important;
    }

    .theme-gacha .quest-name,
    .theme-gacha .quest-desc {
      color: #4a148c !important;
    }

    .theme-gacha .quest-item.completed {
      background: linear-gradient(135deg, rgba(244, 143, 177, 0.5) 0%, rgba(255, 255, 255, 0.5) 100%) !important;
      border-color: #f48fb1 !important;
    }

    .theme-gacha .btn-primary {
      background: linear-gradient(135deg, #ba68c8, #f48fb1) !important;
      color: #ffffff !important;
      border-radius: 25px !important;
    }

    .theme-gacha .tab-btn {
      color: #4a148c !important;
    }

    .theme-gacha .tab-btn.active {
      background: linear-gradient(135deg, #ba68c8, #f48fb1) !important;
      color: #ffffff !important;
    }

    .theme-gacha .nightly-item.completed {
      background: linear-gradient(135deg, #f48fb1 0%, #ba68c8 100%) !important;
    }

    .theme-gacha .quest-xp,
    .theme-gacha .section-badge {
      background: rgba(186, 104, 200, 0.2) !important;
      color: #9c27b0 !important;
    }

    /* ============================================ */
    /* THEME: Princess / Royal Quest */
    /* ============================================ */
    .theme-princess {
      --bg-primary: #7e57c2;
      --bg-secondary: #9575cd;
      --bg-tertiary: #b39ddb;
      --accent-primary: #ffd700;
      --accent-secondary: #e1bee7;
      --accent-glow: rgba(255, 215, 0, 0.4);
      --text-primary: #ffffff;
      --text-secondary: #e1bee7;
      --success: #ffd700;
      --warning: #ffab00;
      --xp-color: #ffd700;
    }

    .theme-princess body {
      background: linear-gradient(180deg, #1a0533 0%, #4a148c 40%, #7e57c2 100%) !important;
      font-family: 'Georgia', 'Times New Roman', serif !important;
    }

    .theme-princess .grid-bg {
      background-image: radial-gradient(ellipse at 50% 0%, rgba(255, 215, 0, 0.1) 0%, transparent 50%) !important;
    }

    .theme-princess .header {
      background: linear-gradient(135deg, rgba(255, 215, 0, 0.2) 0%, rgba(126, 87, 194, 0.3) 100%) !important;
      border-color: rgba(255, 215, 0, 0.5) !important;
      border-radius: 20px !important;
      border-width: 2px !important;
    }

    .theme-princess .header h1 {
      background: linear-gradient(135deg, #ffd700 0%, #ffec8b 50%, #ffd700 100%) !important;
      -webkit-background-clip: text !important;
      text-shadow: 0 0 20px rgba(255, 215, 0, 0.5);
    }

    .theme-princess .stat-card {
      background: linear-gradient(135deg, rgba(126, 87, 194, 0.4) 0%, rgba(149, 117, 205, 0.3) 100%) !important;
      border-color: rgba(255, 215, 0, 0.4) !important;
      border-radius: 16px !important;
    }

    .theme-princess .section {
      background: rgba(126, 87, 194, 0.3) !important;
      border-color: rgba(255, 215, 0, 0.3) !important;
      border-radius: 20px !important;
    }

    .theme-princess .quest-item {
      background: rgba(149, 117, 205, 0.4) !important;
      border-color: rgba(255, 215, 0, 0.3) !important;
      border-radius: 14px !important;
    }

    .theme-princess .quest-item.completed {
      background: linear-gradient(135deg, rgba(255, 215, 0, 0.4) 0%, rgba(255, 236, 139, 0.2) 100%) !important;
      border-color: #ffd700 !important;
    }

    .theme-princess .btn-primary {
      background: linear-gradient(135deg, #ffd700, #ffec8b) !important;
      color: #4a148c !important;
      border-radius: 25px !important;
      font-weight: 700 !important;
    }

    .theme-princess .tab-btn.active {
      background: linear-gradient(135deg, #ffd700, #ffec8b) !important;
      color: #4a148c !important;
    }

    .theme-princess .nightly-item.completed {
      background: linear-gradient(135deg, #ffd700 0%, #ffec8b 100%) !important;
    }

    .theme-princess .quest-xp,
    .theme-princess .section-badge {
      background: rgba(255, 215, 0, 0.2) !important;
      color: #ffd700 !important;
    }

    .theme-princess .wallet-card {
      background: linear-gradient(135deg, rgba(255, 215, 0, 0.2) 0%, rgba(126, 87, 194, 0.3) 100%) !important;
      border-color: rgba(255, 215, 0, 0.4) !important;
    }

    /* Parent Portal Styles */
    .portal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
      padding: 16px 20px;
      background: linear-gradient(135deg, rgba(139, 92, 246, 0.15) 0%, rgba(59, 130, 246, 0.1) 100%);
      border-radius: 16px;
      border: 1px solid rgba(139, 92, 246, 0.3);
      position: relative;
    }

    .portal-title {
      font-size: 20px;
      font-weight: 800;
      color: #c4b5fd;
    }

    .portal-subtitle {
      font-size: 13px;
      color: #94a3b8;
    }

    .portal-actions {
      display: flex;
      gap: 8px;
    }

    .portal-btn {
      padding: 12px 18px;
      border-radius: 10px;
      border: none;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
    }

    .portal-btn.settings {
      background: rgba(59, 130, 246, 0.2);
      color: #93c5fd;
    }

    .portal-btn.exit {
      background: rgba(239, 68, 68, 0.2);
      color: #fca5a5;
    }

    .portal-btn.notification {
      background: rgba(234, 179, 8, 0.2);
      color: #fbbf24;
      position: relative;
    }

    .notification-badge {
      position: absolute;
      top: -4px;
      right: -4px;
      background: #ef4444;
      color: white;
      font-size: 12px;
      font-weight: 700;
      min-width: 20px;
      height: 20px;
      border-radius: 10px;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 0 4px;
    }

    .notifications-dropdown {
      position: absolute;
      top: calc(100% + 8px);
      right: 0;
      width: 320px;
      max-height: 400px;
      background: rgba(15, 23, 42, 0.98);
      border: 1px solid rgba(59, 130, 246, 0.3);
      border-radius: 12px;
      box-shadow: 0 10px 40px rgba(0, 0, 0, 0.5);
      z-index: 1000;
      overflow: hidden;
    }

    .notifications-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 14px 16px;
      border-bottom: 1px solid rgba(71, 85, 105, 0.3);
      font-size: 14px;
      font-weight: 700;
      color: #f1f5f9;
    }

    .notifications-list {
      max-height: 340px;
      overflow-y: auto;
      -webkit-overflow-scrolling: touch;
      -ms-overflow-style: none;
      scrollbar-width: none;
    }

    .notifications-list::-webkit-scrollbar {
      display: none;
    }

    .notification-item {
      display: flex;
      align-items: flex-start;
      gap: 12px;
      padding: 14px 16px;
      border-bottom: 1px solid rgba(71, 85, 105, 0.2);
      cursor: pointer;
      transition: background 0.2s;
    }

    .notification-item:hover {
      background: rgba(59, 130, 246, 0.1);
    }

    .notification-item.unread {
      background: rgba(59, 130, 246, 0.05);
    }

    .notification-icon {
      font-size: 24px;
    }

    .notification-content {
      flex: 1;
    }

    .notification-text {
      font-size: 15px;
      color: #e2e8f0;
      margin-bottom: 4px;
    }

    .notification-time {
      font-size: 13px;
      color: #64748b;
    }

    .notification-empty {
      padding: 30px;
      text-align: center;
      color: #64748b;
      font-size: 15px;
    }

    /* Child Selector */
    .child-selector {
      display: flex;
      gap: 12px;
      margin-bottom: 16px;
      overflow-x: auto;
      overflow-y: hidden;
      padding: 4px;
      -webkit-overflow-scrolling: touch;
      -ms-overflow-style: none;
      scrollbar-width: none;
    }

    .child-selector::-webkit-scrollbar {
      display: none;
    }

    .child-select-card {
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: 12px 20px;
      border-radius: 14px;
      border: 2px solid rgba(59, 130, 246, 0.2);
      background: rgba(30, 41, 59, 0.5);
      cursor: pointer;
      transition: all 0.2s;
      min-width: 80px;
    }

    .child-select-card:hover {
      border-color: rgba(59, 130, 246, 0.4);
      transform: translateY(-2px);
    }

    .child-select-card.selected {
      border-color: #3b82f6;
      background: linear-gradient(135deg, rgba(59, 130, 246, 0.2) 0%, rgba(59, 130, 246, 0.1) 100%);
      box-shadow: 0 4px 15px rgba(59, 130, 246, 0.2);
    }

    .child-select-avatar {
      font-size: 32px;
      margin-bottom: 6px;
    }

    .child-select-name {
      font-size: 14px;
      font-weight: 700;
      color: #e2e8f0;
    }

    .child-select-card.selected .child-select-name {
      color: #60a5fa;
    }

    /* Child Stats Grid */
    .child-stats-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 12px;
    }

    .child-stat-card {
      padding: 16px;
      border-radius: 12px;
      background: rgba(30, 41, 59, 0.6);
      border: 1px solid rgba(255, 255, 255, 0.05);
    }

    .child-stat-card.highlight {
      background: linear-gradient(135deg, rgba(59, 130, 246, 0.2) 0%, rgba(139, 92, 246, 0.1) 100%);
      border-color: rgba(59, 130, 246, 0.3);
    }

    .child-stat-value {
      font-size: 28px;
      font-weight: 900;
      color: #f1f5f9;
    }

    .child-stat-label {
      font-size: 12px;
      font-weight: 700;
      color: #64748b;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      margin-top: 4px;
    }

    /* Week Progress Grid */
    .week-progress-grid {
      display: grid;
      grid-template-columns: repeat(7, 1fr);
      gap: 8px;
      margin-top: 12px;
    }

    .week-day-card {
      padding: 12px 8px;
      border-radius: 10px;
      background: rgba(30, 41, 59, 0.5);
      text-align: center;
      border: 1px solid rgba(255, 255, 255, 0.05);
    }

    .week-day-card.today {
      background: rgba(59, 130, 246, 0.2);
      border-color: rgba(59, 130, 246, 0.4);
    }

    .week-day-name {
      font-size: 12px;
      font-weight: 700;
      color: #64748b;
      margin-bottom: 6px;
    }

    .week-day-card.today .week-day-name {
      color: #60a5fa;
    }

    .week-day-count {
      font-size: 20px;
      font-weight: 900;
      color: #e2e8f0;
    }

    .portal-nav {
      display: flex;
      gap: 6px;
      margin-bottom: 12px;
      overflow-x: auto;
      overflow-y: hidden;
      padding-bottom: 4px;
      -webkit-overflow-scrolling: touch;
      -ms-overflow-style: none;
      scrollbar-width: none;
    }

    .portal-nav::-webkit-scrollbar {
      display: none;
    }

    .portal-nav.main-nav {
      background: rgba(30, 41, 59, 0.4);
      padding: 8px;
      border-radius: 12px;
      margin-bottom: 16px;
    }

    .portal-nav.secondary-nav {
      margin-bottom: 20px;
      justify-content: center;
    }

    .portal-nav-btn {
      padding: 12px 16px;
      border: none;
      border-radius: 10px;
      font-size: 13px;
      font-weight: 600;
      cursor: pointer;
      background: rgba(30, 41, 59, 0.6);
      color: #94a3b8;
      transition: all 0.2s;
      white-space: nowrap;
      flex: 1;
      text-align: center;
    }

    .portal-nav.main-nav .portal-nav-btn {
      background: transparent;
    }

    .portal-nav-btn.secondary {
      flex: none;
      padding: 10px 14px;
      font-size: 13px;
      border-radius: 8px;
    }

    .portal-nav-btn:hover {
      background: rgba(59, 130, 246, 0.1);
      color: #e2e8f0;
    }

    .portal-nav-btn.active {
      background: linear-gradient(135deg, #3b82f6, #60a5fa);
      color: white;
      box-shadow: 0 4px 15px rgba(59, 130, 246, 0.3);
    }

    .portal-nav-btn.secondary.active {
      background: linear-gradient(135deg, #8b5cf6, #a78bfa);
      box-shadow: 0 4px 15px rgba(139, 92, 246, 0.3);
    }

    .portal-section {
      display: none;
    }

    .portal-section.active {
      display: block;
    }

    /* Child Cards */
    .child-card {
      background: rgba(30, 41, 59, 0.6);
      border: 1px solid rgba(71, 85, 105, 0.3);
      border-radius: 16px;
      padding: 20px;
      margin-bottom: 16px;
    }

    .child-card-header {
      display: flex;
      align-items: center;
      gap: 14px;
      margin-bottom: 16px;
    }

    .child-avatar {
      width: 56px;
      height: 56px;
      border-radius: 14px;
      background: linear-gradient(135deg, rgba(59, 130, 246, 0.2), rgba(139, 92, 246, 0.2));
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 28px;
    }

    .child-info {
      flex: 1;
    }

    .child-name {
      font-size: 18px;
      font-weight: 700;
      color: #f1f5f9;
    }

    .child-level {
      font-size: 12px;
      color: #94a3b8;
    }

    .child-rank-badge {
      padding: 6px 14px;
      border-radius: 20px;
      font-size: 14px;
      font-weight: 800;
    }

    .child-stats {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 12px;
      margin-bottom: 16px;
    }

    .child-stat {
      text-align: center;
      padding: 12px;
      background: rgba(15, 23, 42, 0.5);
      border-radius: 10px;
    }

    .child-stat-value {
      font-size: 20px;
      font-weight: 800;
      color: #e2e8f0;
    }

    .child-stat-label {
      font-size: 12px;
      color: #64748b;
      letter-spacing: 1px;
      margin-top: 2px;
    }

    /* Progress Bars */
    .progress-section {
      margin-bottom: 14px;
    }

    .progress-header {
      display: flex;
      justify-content: space-between;
      margin-bottom: 6px;
    }

    .progress-label {
      font-size: 13px;
      color: #94a3b8;
    }

    .progress-value {
      font-size: 13px;
      font-weight: 700;
      color: #e2e8f0;
    }

    .progress-track {
      height: 8px;
      background: rgba(71, 85, 105, 0.3);
      border-radius: 4px;
      overflow: hidden;
    }

    .progress-fill-bar {
      height: 100%;
      border-radius: 4px;
      transition: width 0.5s ease;
    }

    .progress-fill-bar.xp {
      background: linear-gradient(90deg, #3b82f6, #60a5fa);
    }

    .progress-fill-bar.daily {
      background: linear-gradient(90deg, #22c55e, #4ade80);
    }

    .progress-fill-bar.weekly {
      background: linear-gradient(90deg, #a855f7, #c084fc);
    }

    /* Bar Chart */
    .chart-container {
      background: rgba(15, 23, 42, 0.5);
      border-radius: 12px;
      padding: 16px;
      margin-top: 16px;
    }

    .chart-title {
      font-size: 14px;
      font-weight: 700;
      color: #94a3b8;
      margin-bottom: 12px;
    }

    .bar-chart {
      display: flex;
      align-items: flex-end;
      justify-content: space-between;
      height: 100px;
      gap: 8px;
    }

    .bar-item {
      flex: 1;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 6px;
    }

    .bar {
      width: 100%;
      max-width: 30px;
      border-radius: 4px 4px 0 0;
      background: linear-gradient(180deg, #3b82f6, #1e40af);
      transition: height 0.3s ease;
      min-height: 4px;
    }

    .bar.today {
      background: linear-gradient(180deg, #22c55e, #15803d);
    }

    .bar-label {
      font-size: 12px;
      color: #64748b;
      font-weight: 600;
    }

    .bar-value {
      font-size: 12px;
      color: #94a3b8;
    }

    /* Activity Feed */
    .activity-feed {
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    .activity-item {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 12px;
      background: rgba(30, 41, 59, 0.5);
      border-radius: 10px;
      border-left: 3px solid #22c55e;
    }

    .activity-icon {
      font-size: 24px;
    }

    .activity-content {
      flex: 1;
    }

    .activity-text {
      font-size: 15px;
      color: #e2e8f0;
    }

    .activity-text strong {
      color: #60a5fa;
    }

    .activity-time {
      font-size: 13px;
      color: #64748b;
    }

    .activity-xp {
      font-size: 14px;
      font-weight: 700;
      color: #4ade80;
    }

    /* Notification Bell */
    .notif-btn {
      position: relative;
      padding: 10px 14px;
      background: rgba(234, 179, 8, 0.2);
      color: #fbbf24;
      border: none;
      border-radius: 10px;
      cursor: pointer;
      font-size: 16px;
    }

    .notif-badge {
      position: absolute;
      top: -4px;
      right: -4px;
      width: 20px;
      height: 20px;
      background: #ef4444;
      border-radius: 50%;
      font-size: 12px;
      font-weight: 700;
      color: white;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    /* Summary Cards */
    .summary-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 12px;
      margin-bottom: 20px;
    }

    .summary-card {
      background: rgba(30, 41, 59, 0.6);
      border-radius: 14px;
      padding: 16px;
      text-align: center;
    }

    .summary-card.earnings {
      border: 1px solid rgba(34, 197, 94, 0.3);
    }

    .summary-card.completions {
      border: 1px solid rgba(59, 130, 246, 0.3);
    }

    .summary-icon {
      font-size: 28px;
      margin-bottom: 8px;
    }

    .summary-value {
      font-size: 24px;
      font-weight: 800;
    }

    .summary-card.earnings .summary-value {
      color: #22c55e;
    }

    .summary-card.completions .summary-value {
      color: #3b82f6;
    }

    .summary-label {
      font-size: 12px;
      color: #64748b;
      letter-spacing: 1px;
      margin-top: 4px;
    }

    /* Empty activity */
    .empty-activity {
      text-align: center;
      padding: 40px 20px;
      color: #64748b;
    }

    .empty-activity-icon {
      font-size: 40px;
      margin-bottom: 10px;
    }

    /* Money Maker Items */
    .money-maker-item {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 14px;
      border-radius: 12px;
      cursor: pointer;
      transition: all 0.2s;
      border: 2px solid rgba(234, 179, 8, 0.3);
      background: linear-gradient(135deg, rgba(234, 179, 8, 0.1) 0%, rgba(251, 191, 36, 0.05) 100%);
    }

    .money-maker-item:hover {
      border-color: rgba(234, 179, 8, 0.5);
      transform: scale(1.01);
    }

    .money-maker-item.completed {
      background: linear-gradient(135deg, rgba(34, 197, 94, 0.2) 0%, rgba(34, 197, 94, 0.1) 100%);
      border-color: rgba(34, 197, 94, 0.4);
    }

    .money-maker-icon {
      font-size: 28px;
      width: 40px;
      text-align: center;
    }

    .money-maker-info {
      flex: 1;
    }

    .money-maker-name {
      font-size: 14px;
      font-weight: 700;
      color: #fbbf24;
    }

    .money-maker-item.completed .money-maker-name {
      color: #86efac;
    }

    .money-maker-desc {
      font-size: 13px;
      color: #94a3b8;
    }

    .money-maker-xp {
      font-size: 14px;
      font-weight: 700;
      color: #fbbf24;
      background: rgba(234, 179, 8, 0.2);
      padding: 6px 12px;
      border-radius: 20px;
    }

    .money-maker-item.completed .money-maker-xp {
      color: #4ade80;
      background: rgba(34, 197, 94, 0.2);
    }

    .money-maker-item.pending {
      background: linear-gradient(135deg, rgba(234, 179, 8, 0.15) 0%, rgba(234, 179, 8, 0.05) 100%);
      border-color: rgba(234, 179, 8, 0.4);
      pointer-events: none;
      opacity: 0.85;
    }

    .money-maker-item.pending .money-maker-name {
      color: #fbbf24;
    }

    .money-maker-item.pending .money-maker-xp {
      color: #fbbf24;
      background: rgba(234, 179, 8, 0.15);
      font-size: 12px;
    }
  </style>
</head>
<body>
  <div class="grid-bg"></div>

  <div class="container" id="app">
    <!-- Loading State -->
    <div id="loading-state" class="loading">
      <div class="loading-spinner"></div>
      <p>Loading Quest Log...</p>
    </div>

    <!-- Setup Wizard -->
    <div id="setup-wizard" class="setup-wizard" style="display: none;">
      <div class="setup-step active" data-step="welcome">
        <div class="setup-icon"></div>
        <div class="setup-title">Welcome to Quest Log!</div>
        <div class="setup-desc">A fun way to track chores and earn rewards.</div>
        <button class="btn btn-primary btn-lg" onclick="goToStep('choose')">Get Started</button>
      </div>

      <div class="setup-step" data-step="choose">
        <div class="setup-icon"></div>
        <div class="setup-title">Who's setting up?</div>
        <div class="setup-desc">Parents set up first, then kids join with a code.</div>
        <button class="btn btn-primary btn-lg" onclick="choosePath('new')"> I'm a Parent (New Family)</button>
        <button class="btn btn-secondary btn-lg" onclick="choosePath('join')"> I'm a Kid (Join with Code)</button>
        <button class="btn btn-secondary btn-lg" onclick="choosePath('login')"> Log In with Passcode</button>
      </div>

      <div class="setup-step" data-step="login">
        <div class="setup-icon"></div>
        <div class="setup-title">Parent Login</div>
        <div class="setup-desc">Enter your family name and parent PIN to access your family.</div>
        <div class="form-group">
          <label class="form-label">Family Name</label>
          <input type="text" class="form-input" id="setup-login-family" placeholder="The Smith Family">
        </div>
        <div class="form-group">
          <label class="form-label">Parent PIN (4 digits)</label>
          <input type="password" class="form-input" id="setup-login-pin" placeholder="" maxlength="4" inputmode="numeric">
        </div>
        <button class="btn btn-primary btn-lg" onclick="loginWithPin()">Log In</button>
        <button class="btn btn-secondary btn-lg" onclick="goToStep('choose')">Back</button>
      </div>

      <div class="setup-step" data-step="create">
        <div class="setup-icon"></div>
        <div class="setup-title">Parent Setup</div>
        <div class="setup-desc">Create your family and set a PIN for parent access.</div>
        <div class="form-group">
          <label class="form-label">Family Name</label>
          <input type="text" class="form-input" id="setup-family-name" placeholder="The Smith Family">
        </div>
        <div class="form-group">
          <label class="form-label">Parent PIN (4 digits)</label>
          <input type="password" class="form-input" id="setup-parent-pin" placeholder="" maxlength="4" inputmode="numeric">
        </div>
        <button class="btn btn-primary btn-lg" onclick="createNewFamily()">Create Family</button>
        <button class="btn btn-secondary btn-lg" onclick="goToStep('choose')">Back</button>
      </div>

      <div class="setup-step" data-step="join">
        <div class="setup-icon"></div>
        <div class="setup-title">Join Family</div>
        <div class="setup-desc">Enter the 6-digit code from your parent.</div>
        <div class="form-group">
          <label class="form-label">Family Code</label>
          <input type="text" class="form-input" id="setup-link-code" placeholder="123456" maxlength="6" inputmode="numeric" style="text-align: center; font-size: 24px; letter-spacing: 8px;">
        </div>
        <button class="btn btn-primary btn-lg" onclick="joinWithCode()">Join Family</button>
        <button class="btn btn-secondary btn-lg" onclick="goToStep('choose')">Back</button>
      </div>

      <div class="setup-step" data-step="add-child">
        <div class="setup-icon"></div>
        <div class="setup-title">Add a Child</div>
        <div class="setup-desc">Who will be completing quests?</div>
        <div class="form-group">
          <label class="form-label">Child's Name</label>
          <input type="text" class="form-input" id="setup-child-name" placeholder="Carter">
        </div>
        <div class="form-group">
          <label class="form-label">Avatar</label>
          <div class="avatar-grid" id="avatar-grid"></div>
        </div>
        <button class="btn btn-primary btn-lg" onclick="addFirstChild()">Add Child & Start</button>
      </div>

      <div class="setup-step" data-step="select-child">
        <div class="setup-icon"></div>
        <div class="setup-title">Select Your Profile</div>
        <div class="setup-desc">Which profile is yours?</div>
        <div id="child-select-list" class="item-list"></div>
      </div>

      <div class="setup-step" data-step="parent-setup-complete">
        <div class="setup-icon"></div>
        <div class="setup-title">Family Created!</div>
        <div class="setup-desc">Now let's set up chores and get your kids started.</div>
        <div style="background: rgba(59, 130, 246, 0.1); border: 1px solid rgba(59, 130, 246, 0.3); border-radius: 12px; padding: 16px; margin: 20px 0; text-align: left;">
          <div style="font-size: 12px; font-weight: 700; color: #60a5fa; margin-bottom: 10px;"> NEXT STEPS:</div>
          <ol style="font-size: 13px; color: #94a3b8; margin: 0; padding-left: 20px;">
            <li style="margin-bottom: 8px;">Create chores in the Parent Portal</li>
            <li style="margin-bottom: 8px;">Assign chores to your kids</li>
            <li style="margin-bottom: 8px;">Set up reminders (optional)</li>
            <li>Generate a link code for your child's device</li>
          </ol>
        </div>
        <button class="btn btn-primary btn-lg" onclick="enterParentPortalFromSetup()">Open Parent Portal</button>
      </div>

      <div class="setup-step" data-step="setup-link-instructions">
        <div class="setup-icon"></div>
        <div class="setup-title">Link Your Child's Device</div>
        <div class="setup-desc">Setup is complete on this device!</div>
        <div style="background: rgba(34, 197, 94, 0.1); border: 1px solid rgba(34, 197, 94, 0.3); border-radius: 12px; padding: 16px; margin: 20px 0; text-align: left;">
          <div style="font-size: 12px; font-weight: 700; color: #4ade80; margin-bottom: 10px;"> TO LINK A CHILD'S DEVICE:</div>
          <ol style="font-size: 13px; color: #94a3b8; margin: 0; padding-left: 20px;">
            <li style="margin-bottom: 8px;">Open Quest Log on your child's device</li>
            <li style="margin-bottom: 8px;">Select "I'm a Kid (Join with Code)"</li>
            <li style="margin-bottom: 8px;">Enter the link code from Parent Portal</li>
            <li>Select their profile to start!</li>
          </ol>
        </div>
        <div style="background: rgba(139, 92, 246, 0.1); border: 1px solid rgba(139, 92, 246, 0.3); border-radius: 12px; padding: 16px; margin: 20px 0;">
          <div style="font-size: 13px; color: #c4b5fd; margin-bottom: 8px;"> To access Parent Portal later:</div>
          <div style="font-size: 12px; color: #94a3b8;">Tap the title "MISSIONS" 5 times quickly</div>
        </div>
        <button class="btn btn-primary btn-lg" onclick="enterParentPortalFromSetup()">Back to Parent Portal</button>
        <button class="btn btn-secondary btn-lg" onclick="goToStep('welcome')">Start Over</button>
      </div>
    </div>

    <!-- Parent Portal -->
    <div id="parent-portal" style="display: none;">
      <div class="portal-header">
        <div>
          <div class="portal-title" id="family-name-display">Family Dashboard</div>
          <div class="portal-subtitle">Parent Portal</div>
        </div>
        <div class="portal-actions">
          <button class="portal-btn notification" id="notification-bell" onclick="toggleNotifications()" title="Notifications">
            
            <span class="notification-badge" id="notification-badge" style="display: none;">0</span>
          </button>
          <button class="portal-btn settings" onclick="generateLinkCode()" title="Link Device"></button>
        </div>
        <!-- Notifications Dropdown -->
        <div class="notifications-dropdown" id="notifications-dropdown" style="display: none;">
          <div class="notifications-header">
            <span>Notifications</span>
            <button onclick="clearNotifications()" style="background: none; border: none; color: #64748b; font-size: 12px; cursor: pointer;">Clear all</button>
          </div>
          <div class="notifications-list" id="notifications-list">
            <div class="notification-empty">No new notifications</div>
          </div>
        </div>
      </div>

      <!-- Main Navigation Tabs -->
      <div class="portal-nav main-nav">
        <button class="portal-nav-btn active" data-tab="overview" onclick="switchPortalTab('overview')"> Overview</button>
        <button class="portal-nav-btn" data-tab="children" onclick="switchPortalTab('children')"> Children</button>
        <button class="portal-nav-btn" data-tab="activity" onclick="switchPortalTab('activity')"> Activity</button>
      </div>

      <!-- Child Selector - Below main tabs, above management tabs -->
      <div class="child-selector" id="portal-child-selector"></div>

      <!-- Management Tabs (scrollable) -->
      <div class="portal-nav secondary-nav">
        <button class="portal-nav-btn secondary" data-tab="chores" onclick="switchPortalTab('chores')"> Chores</button>
        <button class="portal-nav-btn secondary" data-tab="assignments" onclick="switchPortalTab('assignments')"> Assign</button>
        <button class="portal-nav-btn secondary" data-tab="nightly" onclick="switchPortalTab('nightly')"> Nightly</button>
        <button class="portal-nav-btn secondary" data-tab="bonus" onclick="switchPortalTab('bonus')"> Rewards</button>
        <button class="portal-nav-btn secondary" data-tab="earnings" onclick="switchPortalTab('earnings')"> Earnings</button>
      </div>

      <!-- Overview Section (for selected child) -->
      <div class="portal-section active" id="portal-overview">
        <div class="child-stats-grid" id="selected-child-stats"></div>
        <!-- Pending Approvals Section -->
        <div class="section" id="pending-approvals-section" style="margin-top: 16px; display: none;">
          <div class="section-header">
            <span class="section-icon"></span>
            <span class="section-title">Pending Approvals</span>
            <span id="pending-approvals-count" style="background: #ef4444; color: white; border-radius: 12px; padding: 2px 8px; font-size: 12px; font-weight: 700; margin-left: 8px;"></span>
          </div>
          <div id="pending-approvals-list" class="item-list"></div>
        </div>
        <div class="section" style="margin-top: 16px;">
          <div class="section-header">
            <span class="section-icon"></span>
            <span class="section-title">This Week's Progress</span>
          </div>
          <div class="week-progress-grid" id="week-progress-grid"></div>
        </div>
      </div>

      <!-- Children Management Section -->
      <div class="portal-section" id="portal-children">
        <div class="section">
          <div class="section-header">
            <span class="section-icon"></span>
            <span class="section-title">Manage Children</span>
          </div>
          <div id="portal-children-list" class="item-list"></div>
          <div class="form-group" style="margin-top: 16px;">
            <label class="form-label">Add New Child</label>
            <input type="text" class="form-input" id="portal-new-child-name" placeholder="Child's name">
          </div>
          <button class="btn btn-primary" style="margin-top: 8px;" onclick="addChildFromPortal()">+ Add Child</button>
        </div>
        <div class="section" style="margin-top: 16px;">
          <div class="section-header">
            <span class="section-icon"></span>
            <span class="section-title">Device Linking</span>
          </div>
          <p style="color: #94a3b8; font-size: 12px; margin-bottom: 12px;">Generate a code to link a child's device to this family</p>
          <button class="btn btn-secondary" onclick="generateLinkCode()">Generate Link Code</button>
          <div id="portal-link-code-container" style="margin-top: 12px;"></div>
        </div>
      </div>

      <!-- Activity Section -->
      <div class="portal-section" id="portal-activity">
        <div class="section">
          <div class="section-header">
            <span class="section-icon"></span>
            <span class="section-title">Recent Activity</span>
          </div>
          <div class="activity-feed" id="portal-activity-feed"></div>
        </div>
      </div>

      <!-- Chores Section -->
      <div class="portal-section" id="portal-chores">
        <div class="section">
          <div class="section-header">
            <span class="section-icon"></span>
            <span class="section-title">Chore Templates</span>
          </div>
          <p style="font-size: 12px; color: #94a3b8; margin-bottom: 12px;">Create reusable chores that can be assigned to any child.</p>
          <div id="portal-chores-list" class="item-list"></div>
          <button class="btn btn-primary" style="margin-top: 12px;" onclick="showModal('add-chore-modal')">+ Add New Chore</button>
        </div>
        <div id="chores-earnings-tally" class="earnings-tally-container"></div>
      </div>

      <!-- Assignments Section (for selected child) -->
      <div class="portal-section" id="portal-assignments">
        <div class="section">
          <div class="section-header">
            <span class="section-icon"></span>
            <span class="section-title" id="assignments-title">Assigned Chores</span>
          </div>
          <div id="portal-assignments-list" class="item-list"></div>
          <button class="btn btn-primary" style="margin-top: 12px;" onclick="showAssignChoreModal()">+ Assign Chore</button>
        </div>

        <!-- Potential Earnings Summary -->
        <div class="section" style="margin-top: 16px;">
          <div class="section-header">
            <span class="section-icon"></span>
            <span class="section-title">Potential Weekly Earnings</span>
          </div>
          <div id="potential-earnings-summary" style="padding: 12px; background: rgba(34, 197, 94, 0.1); border-radius: 12px; border: 1px solid rgba(34, 197, 94, 0.3);">
            <!-- Filled by JS -->
          </div>
        </div>
      </div>

      <!-- Nightly Patrol Section -->
      <div class="portal-section" id="portal-nightly">
        <div class="section">
          <div class="section-header">
            <span class="section-icon"></span>
            <span class="section-title">Nightly Patrol Zones</span>
          </div>
          <p style="font-size: 12px; color: #94a3b8; margin-bottom: 12px;">Configure zones for nightly patrol. Kids check each zone before bed for a streak bonus.</p>
          <div id="portal-nightly-zones-list" class="item-list"></div>
          <div class="form-group" style="margin-top: 16px;">
            <label class="form-label">Add New Zone</label>
            <div style="display: flex; gap: 10px;">
              <select class="form-select" id="portal-new-zone-icon" style="width: 80px;">
                <option value=""></option>
                <option value=""></option>
                <option value=""></option>
                <option value=""></option>
                <option value=""></option>
                <option value=""></option>
                <option value=""></option>
                <option value=""></option>
                <option value=""></option>
                <option value=""></option>
                <option value=""></option>
              </select>
              <input type="text" class="form-input" id="portal-new-zone-name" placeholder="Zone name" style="flex: 1;">
            </div>
          </div>
          <button class="btn btn-primary" style="margin-top: 8px;" onclick="addNightlyZoneFromPortal()">+ Add Zone</button>
        </div>

        <!-- Bedtime Reminder Section -->
        <div class="section" style="margin-top: 24px;">
          <div class="section-header">
            <span class="section-icon"></span>
            <span class="section-title">Bedtime Reminder</span>
          </div>
          <p style="font-size: 12px; color: #94a3b8; margin-bottom: 12px;">Set a nightly reminder with a checklist of things to do before bed.</p>
          <div class="form-group">
            <label class="form-label">Reminder Time</label>
            <input type="time" class="form-input" id="bedtime-reminder-time" style="max-width: 150px;">
          </div>
          <div class="form-group">
            <label class="form-label">Bedtime Checklist</label>
            <textarea class="form-input" id="bedtime-reminder-message" rows="4" placeholder="Example:
 Brush teeth
 Put in rubberbands
 Set out clothes for tomorrow
 Plug in tablet"></textarea>
          </div>
          <div style="display: flex; gap: 10px;">
            <button class="btn btn-primary" onclick="saveBedtimeReminder()"> Save Reminder</button>
            <button class="btn btn-secondary" onclick="deleteBedtimeReminder()" id="delete-bedtime-btn" style="display: none;"> Remove</button>
          </div>
          <div id="bedtime-reminder-status" style="margin-top: 8px; font-size: 12px; color: #94a3b8;"></div>
        </div>

        <div id="nightly-earnings-tally" class="earnings-tally-container"></div>
      </div>

      <!-- Bonus/Rewards Section (Money Makers + Privileges) -->
      <div class="portal-section" id="portal-bonus">
        <div class="section">
          <div class="section-header">
            <span class="section-icon"></span>
            <span class="section-title">Money Makers</span>
          </div>
          <p style="font-size: 12px; color: #94a3b8; margin-bottom: 12px;">Extra tasks kids can complete anytime for bonus XP. These appear in the Wallet section.</p>
          <div id="portal-bonus-list" class="item-list"></div>
          <button class="btn btn-primary" style="margin-top: 12px;" onclick="showAddBonusModal()">+ Add Money Maker</button>
        </div>

        <div class="section" style="margin-top: 24px;">
          <div class="section-header">
            <span class="section-icon"></span>
            <span class="section-title">Privileges</span>
          </div>
          <p style="color: #94a3b8; font-size: 13px; margin-bottom: 16px;">
            Create special rewards children can unlock and redeem. Think: extra screen time, choose dinner, stay up late, etc.
          </p>
          <div id="portal-privileges-list" class="item-list"></div>
          <button class="btn btn-primary" style="margin-top: 12px;" onclick="showAddPrivilegeModal()">+ Add Privilege</button>
        </div>
        <div id="bonus-earnings-tally" class="earnings-tally-container"></div>

        <!-- Testing: Reset Achievements & Privileges -->
        <div class="section" style="margin-top: 24px; border-top: 1px solid rgba(239, 68, 68, 0.2); padding-top: 16px;">
          <div class="section-header">
            <span class="section-icon"></span>
            <span class="section-title">Testing Tools</span>
          </div>
          <p style="font-size: 12px; color: #94a3b8; margin-bottom: 12px;">Reset achievements and privilege unlocks for the selected child. Use when restarting for testing.</p>
          <div style="display: flex; gap: 10px; flex-wrap: wrap;">
            <button class="btn btn-secondary" style="background: rgba(239, 68, 68, 0.15); color: #f87171; border: 1px solid rgba(239, 68, 68, 0.3);" onclick="resetChildAchievements()"> Reset Achievements</button>
            <button class="btn btn-secondary" style="background: rgba(239, 68, 68, 0.15); color: #f87171; border: 1px solid rgba(239, 68, 68, 0.3);" onclick="resetChildPrivileges()"> Reset Privileges</button>
          </div>
        </div>
      </div>

      <!-- Earnings Section (for selected child) -->
      <div class="portal-section" id="portal-earnings">
        <div class="section">
          <div class="section-header">
            <span class="section-icon"></span>
            <span class="section-title" id="earnings-title">Weekly Earnings</span>
          </div>
          <div id="portal-earnings-display"></div>
        </div>
        <div id="earnings-earnings-tally" class="earnings-tally-container"></div>
        <div style="padding: 8px 0;">
          <button class="btn btn-primary" onclick="showModal('allowance-calc-modal')"> Allowance Calculator</button>
        </div>
      </div>
    </div>

    <!-- Main App -->
    <div id="main-app" style="display: none;">
      <!-- Notification Enable Banner -->
      <div id="notification-banner" style="display: none; background: linear-gradient(135deg, #3b82f6, #8b5cf6); padding: 12px 16px; text-align: center; cursor: pointer;" onclick="enableNotifications()">
        <span style="color: white; font-size: 14px;"> Tap to enable reminders on this device</span>
      </div>

      <div class="header">
        <button class="help-btn" onclick="showModal('help-modal')"></button>
        <button class="notification-btn" id="notification-toggle-btn" onclick="toggleNotifications()" style="position: absolute; top: 16px; right: 56px; background: rgba(255,255,255,0.1); border: none; border-radius: 50%; width: 40px; height: 40px; font-size: 20px; cursor: pointer;"></button>
        <button class="settings-btn" onclick="showModal('theme-modal')"></button>
        <div class="header-tag"> QUEST LOG </div>
        <h1 id="app-title" onclick="handleTitleTap()">MISSIONS</h1>
        <p>Complete quests. Earn XP. Get paid.</p>
      </div>

      <div class="tab-nav">
        <button class="tab-btn active" onclick="switchTab('quests')"> Quests</button>
        <button class="tab-btn" onclick="switchTab('wallet')"> Wallet</button>
        <button class="tab-btn" onclick="switchTab('trophies')"> Trophies</button>
      </div>

      <!-- QUESTS TAB -->
      <div class="tab-content active" id="tab-quests">
        <div class="stats-grid">
          <div class="stat-card level">
            <div class="stat-label">LEVEL</div>
            <div class="stat-value" id="level">1</div>
          </div>
          <div class="stat-card xp">
            <div class="stat-label">TOTAL XP</div>
            <div class="stat-value" id="xp">0</div>
            <div class="progress-bar">
              <div class="progress-fill" id="progress" style="width: 0%"></div>
            </div>
            <div class="progress-text" id="progress-text">0/100 to next level</div>
          </div>
          <div class="stat-card rank" id="rank-card">
            <div class="stat-label">RANK</div>
            <div class="stat-value" id="rank">F</div>
          </div>
        </div>

        <div class="section weekly">
          <div class="section-header">
            <span class="section-icon"></span>
            <span class="section-title">TODAY'S QUESTS</span>
            <span class="section-badge" id="xp-badge">+0 XP</span>
          </div>
          <div class="day-tabs" id="day-tabs"></div>
          <div class="quests-list" id="quests-list"></div>
        </div>

        <div class="section nightly">
          <div class="section-header">
            <span class="section-icon"></span>
            <span class="section-title">NIGHTLY PATROL</span>
            <span class="section-badge">+5 XP each</span>
          </div>
          <div class="nightly-info" style="border-left-color: #60a5fa; margin-bottom: 10px;">
             <strong>MISSION:</strong> Go around and put away all your items that are scattered around the house!
          </div>
          <div class="nightly-info">
             <strong>STREAK BONUS:</strong> Complete ALL nightly patrols for 7 days = 1.5x weekly pay!
          </div>
          <div class="nightly-grid" id="nightly-grid"></div>
        </div>

        <div class="actions">
          <button class="btn btn-primary" onclick="showModal('payday-modal')"> View Payday</button>
        </div>
      </div>

      <!-- WALLET TAB -->
      <div class="tab-content" id="tab-wallet">
        <div class="wallet-card">
          <div class="wallet-header">
            <span></span>
            <span class="wallet-title">THIS WEEK'S EARNINGS</span>
          </div>
          <div class="wallet-amount" id="wallet-amount">$0.00</div>
          <div class="wallet-breakdown">
            <div class="wallet-row">
              <span class="wallet-row-label">Base Pay (<span id="wallet-rank">F</span>)</span>
              <span class="wallet-row-value" id="wallet-base">$0.00</span>
            </div>
            <div class="wallet-row">
              <span class="wallet-row-label">Streak Bonus</span>
              <span class="wallet-row-value multiplier" id="wallet-streak"></span>
            </div>
            <div class="wallet-row" id="wallet-bonus-line" style="display: none;">
              <span class="wallet-row-label">Bonus Tasks</span>
              <span class="wallet-row-value bonus" id="wallet-bonus">$0.00</span>
            </div>
          </div>
          <div class="streak-indicator">
            <span class="streak-flames"></span>
            <span class="streak-text">Nightly Streak: <strong id="streak-count">0/7</strong></span>
            <div class="streak-days" id="streak-days"></div>
          </div>
        </div>

        <!-- Money Makers Section -->
        <div class="section" style="border: 1px solid rgba(234, 179, 8, 0.3); background: linear-gradient(135deg, rgba(234, 179, 8, 0.1) 0%, rgba(251, 191, 36, 0.05) 100%);">
          <div class="section-header">
            <span class="section-icon"></span>
            <span class="section-title">MONEY MAKERS</span>
            <span class="section-badge" style="background: rgba(234, 179, 8, 0.2); color: #fbbf24;">BONUS XP</span>
          </div>
          <p style="font-size: 12px; color: #94a3b8; margin-bottom: 14px;">Want to earn more? Complete these bonus tasks!</p>
          <div id="money-makers-list" class="quests-list"></div>
        </div>

        <div class="pay-scale">
          <div class="pay-scale-title"> PAY SCALE</div>
          <div class="pay-tiers" id="pay-tiers"></div>
        </div>

        <div class="section" style="border: 1px solid rgba(59, 130, 246, 0.2);">
          <div class="section-header">
            <span class="section-icon"></span>
            <span class="section-title">ALL-TIME STATS</span>
          </div>
          <div class="wallet-breakdown" style="border: none; padding: 0; margin: 0;">
            <div class="wallet-row">
              <span class="wallet-row-label">Total XP Earned</span>
              <span class="wallet-row-value" id="lifetime-xp">0</span>
            </div>
            <div class="wallet-row">
              <span class="wallet-row-label">Current Streak</span>
              <span class="wallet-row-value" id="lifetime-streak">0 days</span>
            </div>
          </div>
        </div>
      </div>

      <!-- TROPHIES TAB -->
      <div class="tab-content" id="tab-trophies">
        <!-- Trophy Rewards Summary -->
        <div class="trophy-summary" id="trophy-summary">
          <div class="trophy-summary-stat">
            <div class="trophy-summary-value" id="trophy-earned">$0.00</div>
            <div class="trophy-summary-label">Earned</div>
          </div>
          <div class="trophy-summary-divider"></div>
          <div class="trophy-summary-stat">
            <div class="trophy-summary-value unclaimed" id="trophy-unclaimed">$0.00</div>
            <div class="trophy-summary-label">Unclaimed</div>
          </div>
          <div class="trophy-summary-divider"></div>
          <div class="trophy-summary-stat">
            <div class="trophy-summary-value potential" id="trophy-potential">$0.00</div>
            <div class="trophy-summary-label">Potential</div>
          </div>
        </div>

        <!-- Unclaimed Rewards Alert -->
        <div class="unclaimed-alert" id="unclaimed-alert" style="display: none;">
          <span class="unclaimed-icon"></span>
          <span class="unclaimed-text">You have unclaimed rewards!</span>
        </div>

        <div class="section achievements">
          <div class="section-header">
            <span class="section-icon"></span>
            <span class="section-title">ACHIEVEMENTS</span>
            <span class="section-badge" style="background: rgba(234, 179, 8, 0.2); color: #fbbf24;" id="achievement-count">0/0</span>
          </div>
          <div class="achievements-grid" id="achievements-grid"></div>
        </div>

        <!-- Privileges Section -->
        <div class="section privileges" id="privileges-section" style="display: none;">
          <div class="section-header">
            <span class="section-icon"></span>
            <span class="section-title">PRIVILEGES</span>
            <span class="section-badge" style="background: rgba(168, 85, 247, 0.2); color: #a855f7;" id="privilege-count">0</span>
          </div>
          <div class="privileges-grid" id="privileges-grid"></div>
        </div>
      </div>
    </div>
  </div>

  <!-- PIN Modal -->
  <div class="modal-overlay" id="pin-modal">
    <div class="modal" style="max-width: 320px;">
      <div class="modal-title"> Parent Access</div>
      <div class="pin-container">
        <p style="color: #94a3b8; font-size: 13px; margin-bottom: 16px;">Enter your 4-digit PIN</p>
        <div class="pin-input" id="pin-inputs"></div>
        <div class="pin-error" id="pin-error">Incorrect PIN</div>
      </div>
      <button class="btn btn-secondary btn-lg" onclick="closeModal('pin-modal')">Cancel</button>
    </div>
  </div>

  <!-- Settings Modal -->
  <div class="modal-overlay" id="settings-modal">
    <div class="modal">
      <div class="modal-title"> Parent Settings</div>
      <div class="settings-tabs">
        <button class="settings-tab active" onclick="switchSettingsTab('family')"> Family</button>
        <button class="settings-tab" onclick="switchSettingsTab('chores')"> Chores</button>
        <button class="settings-tab" onclick="switchSettingsTab('assign')"> Assign</button>
        <button class="settings-tab" onclick="switchSettingsTab('nightly')"> Nightly</button>
        <button class="settings-tab" onclick="switchSettingsTab('bonus')"> Bonus</button>
      </div>

      <div class="settings-content active" id="settings-family">
        <h4 style="color: #f1f5f9; margin: 0 0 12px; font-size: 14px;">Children</h4>
        <div id="children-list" class="item-list"></div>
        <div class="form-group">
          <label class="form-label">Add New Child</label>
          <input type="text" class="form-input" id="new-child-name" placeholder="Child's name">
        </div>
        <button class="btn btn-primary btn-lg" onclick="addChild()">+ Add Child</button>

        <h4 style="color: #f1f5f9; margin: 20px 0 12px; font-size: 14px;">Device Linking</h4>
        <p style="color: #94a3b8; font-size: 12px; margin-bottom: 12px;">Generate a code to link another device</p>
        <button class="btn btn-secondary btn-lg" onclick="generateLinkCode()">Generate Link Code</button>
        <div id="link-code-container"></div>
      </div>

      <div class="settings-content" id="settings-chores">
        <div id="chores-list" class="item-list"></div>
        <h4 style="color: #f1f5f9; margin: 20px 0 12px; font-size: 14px;">Add New Chore</h4>
        <div class="form-group">
          <label class="form-label">Quick Templates</label>
          <div id="settings-chore-templates-picker" style="display: flex; flex-wrap: wrap; gap: 8px; margin-bottom: 8px;"></div>
        </div>
        <div class="form-group">
          <label class="form-label">Chore Name</label>
          <input type="text" class="form-input" id="new-chore-name" placeholder="Take out trash">
        </div>
        <div class="form-group">
          <label class="form-label">Expectations</label>
          <textarea class="form-input" id="new-chore-desc" placeholder="What exactly needs to be done? Be specific!" rows="3" style="resize: vertical;"></textarea>
        </div>
        <div style="display: flex; gap: 10px;">
          <div class="form-group" style="flex: 1;">
            <label class="form-label">Icon</label>
            <select class="form-select" id="new-chore-icon">
              <option value=""> Trash</option>
              <option value=""> Dishes</option>
              <option value=""> Bed/Room</option>
              <option value=""> Boxes</option>
              <option value=""> Sweep</option>
              <option value=""> Laundry</option>
              <option value=""> Pets</option>
              <option value=""> Yard</option>
              <option value=""> Office</option>
              <option value=""> Bathroom</option>
              <option value=""> Home</option>
              <option value=""> School</option>
              <option value=""> Other</option>
            </select>
          </div>
          <div class="form-group" style="flex: 1;">
            <label class="form-label">XP Value</label>
            <select class="form-select" id="new-chore-xp">
              <option value="5">5 XP</option>
              <option value="10" selected>10 XP</option>
              <option value="15">15 XP</option>
              <option value="20">20 XP</option>
              <option value="25">25 XP</option>
              <option value="30">30 XP</option>
              <option value="35">35 XP</option>
            </select>
          </div>
        </div>
        <button class="btn btn-primary btn-lg" onclick="addChore()">+ Add Chore</button>
      </div>

      <div class="settings-content" id="settings-assign">
        <div class="form-group">
          <label class="form-label">Child</label>
          <select class="form-select" id="settings-assign-child"></select>
        </div>
        <div class="form-group">
          <label class="form-label">Chore</label>
          <select class="form-select" id="settings-assign-chore"></select>
        </div>
        <div class="form-group">
          <label class="form-label">Schedule</label>
          <select class="form-select" id="settings-assign-schedule">
            <option value="daily">Daily</option>
            <option value="weekly-0">Weekly - Sunday</option>
            <option value="weekly-1">Weekly - Monday</option>
            <option value="weekly-2">Weekly - Tuesday</option>
            <option value="weekly-3">Weekly - Wednesday</option>
            <option value="weekly-4">Weekly - Thursday</option>
            <option value="weekly-5">Weekly - Friday</option>
            <option value="weekly-6">Weekly - Saturday</option>
          </select>
        </div>
        <div class="form-group">
          <label class="form-label">Reminder Time (optional)</label>
          <div style="display: flex; gap: 10px; align-items: center;">
            <input type="time" class="form-input" id="settings-assign-reminder-time" style="flex: 1;">
            <button type="button" class="btn btn-secondary" style="padding: 12px; flex: 0;" onclick="document.getElementById('settings-assign-reminder-time').value=''">Clear</button>
          </div>
          <p style="font-size: 13px; color: #64748b; margin-top: 4px;">Set a daily reminder notification for this chore</p>
        </div>
        <button class="btn btn-primary btn-lg" onclick="assignChoreFromSettings()">Assign Chore</button>
        <h4 style="color: #f1f5f9; margin: 20px 0 12px; font-size: 14px;">Current Assignments</h4>
        <div id="assignments-list" class="item-list"></div>
      </div>

      <div class="settings-content" id="settings-nightly">
        <p style="color: #94a3b8; font-size: 12px; margin-bottom: 16px;">Configure the zones for nightly patrol. Each zone is worth 5 XP.</p>
        <div id="nightly-zones-list" class="item-list"></div>
        <h4 style="color: #f1f5f9; margin: 20px 0 12px; font-size: 14px;">Add New Zone</h4>
        <div class="form-group">
          <label class="form-label">Zone Name</label>
          <input type="text" class="form-input" id="new-zone-name" placeholder="Kitchen">
        </div>
        <div class="form-group">
          <label class="form-label">Icon</label>
          <select class="form-select" id="new-zone-icon">
            <option value=""> Bedroom</option>
            <option value=""> Living Room</option>
            <option value=""> House</option>
            <option value=""> Kitchen</option>
            <option value=""> Bathroom</option>
            <option value=""> Garage</option>
            <option value=""> Yard</option>
            <option value=""> Office/Study</option>
            <option value=""> Game Room</option>
            <option value=""> Laundry</option>
          </select>
        </div>
        <button class="btn btn-primary btn-lg" onclick="addNightlyZone()">+ Add Zone</button>
      </div>

      <div class="settings-content" id="settings-bonus">
        <p style="color: #94a3b8; font-size: 13px; margin-bottom: 16px;">Money Makers are now managed in the Parent Portal's Bonus tab for better sync across devices.</p>
        <button class="btn btn-primary btn-lg" onclick="closeModal('settings-modal'); switchPortalTab('bonus');">Go to Bonus Tab</button>
      </div>

      <button class="btn btn-secondary btn-lg" style="margin-top: 20px;" onclick="closeModal('settings-modal')">Close</button>
    </div>
  </div>

  <!-- In-App Reminder Modal -->
  <div class="modal-overlay" id="reminder-popup-modal">
    <div class="modal" style="text-align: center;">
      <div style="font-size: 48px; margin-bottom: 16px;"></div>
      <div class="modal-title" id="reminder-popup-title">Bedtime Reminder</div>
      <div id="reminder-popup-message" style="background: rgba(30, 41, 59, 0.8); border-radius: 12px; padding: 16px; margin: 16px 0; text-align: left; white-space: pre-line; font-size: 15px; line-height: 1.6; color: #e2e8f0;"></div>
      <button class="btn btn-primary btn-lg" onclick="dismissReminder()" style="width: 100%;">Got it!</button>
    </div>
  </div>

  <!-- Help Modal -->
  <div class="modal-overlay" id="help-modal">
    <div class="modal">
      <div class="modal-title"> Help</div>
      <div class="help-content">
        <div class="help-section">
          <h3> Completing Quests</h3>
          <ul>
            <li>Tap a quest to mark it complete and earn XP</li>
            <li>Complete nightly patrol zones for streak bonuses</li>
          </ul>
        </div>
        <div class="help-section">
          <h3> Ranks & Pay</h3>
          <ul>
            <li><strong style="color: #ffd700;">S Rank</strong> - 500+ XP = $10</li>
            <li><strong style="color: #a855f7;">A Rank</strong> - 400+ XP = $8</li>
            <li><strong style="color: #3b82f6;">B Rank</strong> - 300+ XP = $6</li>
            <li><strong style="color: #22c55e;">C Rank</strong> - 200+ XP = $4</li>
            <li><strong style="color: #f59e0b;">D Rank</strong> - 100+ XP = $2</li>
            <li><strong style="color: #64748b;">F Rank</strong> - 0+ XP = $0</li>
          </ul>
        </div>
        <div class="help-section">
          <h3> Streak Bonus</h3>
          <p>Complete all nightly patrols for 7 days = 1.5x pay!</p>
        </div>
        <div class="help-section">
          <h3> Money Makers</h3>
          <p>Tap a Money Maker to request completion. A parent must approve it before XP and money are awarded.</p>
        </div>
        <div class="help-section">
          <h3> Parent Access</h3>
          <p>Parents: Tap the title "<strong>MISSIONS</strong>" 5 times quickly to access the Parent Portal.</p>
        </div>
      </div>
      <button class="btn btn-primary btn-lg" onclick="closeModal('help-modal')">Got it!</button>
    </div>
  </div>

  <!-- Achievement Unlocked Modal -->
  <div class="modal-overlay" id="achievement-unlocked-modal">
    <div class="modal" style="text-align: center;">
      <div style="font-size: 64px; margin-bottom: 16px;" id="unlocked-achievement-icon"></div>
      <div class="modal-title" style="color: #fbbf24;">Achievement Unlocked!</div>
      <div style="font-size: 20px; font-weight: 700; color: #e2e8f0; margin-bottom: 8px;" id="unlocked-achievement-name"></div>
      <div style="font-size: 14px; color: #94a3b8; margin-bottom: 16px;" id="unlocked-achievement-desc"></div>
      <div style="font-size: 18px; font-weight: 700; color: #22c55e; margin-bottom: 16px;" id="unlocked-achievement-reward"></div>
      <button class="btn btn-primary btn-lg" onclick="closeModal('achievement-unlocked-modal')">Awesome!</button>
    </div>
  </div>

  <!-- Expectations Modal -->
  <div class="modal-overlay" id="expectations-modal">
    <div class="modal">
      <div class="modal-title"> Expectations</div>
      <div style="text-align: center; margin-bottom: 16px;">
        <div style="font-size: 18px; font-weight: 700; color: #e2e8f0;" id="expectations-chore-name"></div>
      </div>
      <div style="background: rgba(30, 41, 59, 0.8); border-radius: 12px; padding: 16px; border: 1px solid rgba(59, 130, 246, 0.3);">
        <div style="font-size: 13px; font-weight: 600; color: #60a5fa; margin-bottom: 8px; text-transform: uppercase;">What's expected:</div>
        <div id="expectations-content" style="color: #e2e8f0; font-size: 14px; line-height: 1.6; white-space: pre-wrap;"></div>
      </div>
      <button class="btn btn-primary btn-lg" style="margin-top: 16px;" onclick="closeModal('expectations-modal')">Got it!</button>
    </div>
  </div>

  <!-- Allowance Calculator Modal -->
  <div class="modal-overlay" id="allowance-calc-modal">
    <div class="modal" style="max-width: 400px;">
      <div class="modal-title"> Allowance Calculator</div>
      <div style="color: #94a3b8; font-size: 13px; margin-bottom: 16px;">Enter your target max weekly allowance and we'll show you the best pay scale and XP breakdown.</div>

      <div class="form-group">
        <label class="form-label">Target Max Weekly Allowance ($)</label>
        <input type="number" class="form-input" id="calc-target-amount" placeholder="10.00" step="0.50" min="1" style="font-size: 20px; text-align: center;">
      </div>

      <button class="btn btn-primary btn-lg" onclick="runAllowanceCalc()">Calculate</button>

      <div id="calc-results" style="display: none; margin-top: 20px;">
        <div id="calc-breakdown" style="background: rgba(30, 41, 59, 0.5); border-radius: 12px; padding: 16px; margin-bottom: 16px;"></div>
        <div id="calc-suggested-scale" style="background: rgba(30, 41, 59, 0.5); border-radius: 12px; padding: 16px; margin-bottom: 16px;"></div>
        <button class="btn btn-primary btn-lg" onclick="applyCalcSuggestions()">Apply This Pay Scale</button>
      </div>

      <button class="btn btn-secondary btn-lg" style="margin-top: 12px;" onclick="closeModal('allowance-calc-modal')">Close</button>
    </div>
  </div>

  <!-- Quest Complete Confirmation Modal -->
  <div class="modal-overlay" id="quest-confirm-modal">
    <div class="modal" style="max-width: 340px; text-align: center;">
      <div style="font-size: 48px; margin-bottom: 12px;" id="quest-confirm-icon"></div>
      <div class="modal-title" style="font-size: 18px;">Quest Complete?</div>
      <div id="quest-confirm-name" style="color: #93c5fd; font-size: 16px; font-weight: 600; margin: 8px 0 4px;"></div>
      <div id="quest-confirm-xp" style="color: #4ade80; font-size: 14px; margin-bottom: 20px;"></div>
      <div style="display: flex; gap: 12px;">
        <button class="btn btn-secondary btn-lg" style="flex: 1;" onclick="resolveQuestConfirm(false)">Not Yet</button>
        <button class="btn btn-primary btn-lg" style="flex: 1;" onclick="resolveQuestConfirm(true)">Done! </button>
      </div>
    </div>
  </div>

  <!-- Edit Child Modal -->
  <div class="modal-overlay" id="edit-child-modal">
    <div class="modal">
      <div class="modal-title"> Edit Child</div>
      <input type="hidden" id="edit-child-id">
      <div class="form-group">
        <label class="form-label">Name</label>
        <input type="text" class="form-input" id="edit-child-name" placeholder="Child's name">
      </div>
      <div class="form-group">
        <label class="form-label">Avatar</label>
        <div class="avatar-picker" id="edit-child-avatar-picker">
          <button type="button" class="avatar-option" data-avatar=""></button>
          <button type="button" class="avatar-option" data-avatar=""></button>
          <button type="button" class="avatar-option" data-avatar=""></button>
          <button type="button" class="avatar-option" data-avatar=""></button>
          <button type="button" class="avatar-option" data-avatar=""></button>
          <button type="button" class="avatar-option" data-avatar=""></button>
          <button type="button" class="avatar-option" data-avatar=""></button>
          <button type="button" class="avatar-option" data-avatar=""></button>
          <button type="button" class="avatar-option" data-avatar=""></button>
          <button type="button" class="avatar-option" data-avatar=""></button>
          <button type="button" class="avatar-option" data-avatar=""></button>
          <button type="button" class="avatar-option" data-avatar=""></button>
        </div>
      </div>
      <div class="form-group">
        <label class="form-label">Venmo Username (optional)</label>
        <input type="text" class="form-input" id="edit-child-venmo" placeholder="@username">
        <p style="font-size: 11px; color: #64748b; margin-top: 4px;">Used for quick Venmo payments on payday</p>
      </div>
      <div class="form-group">
        <label class="form-label">Cash App $Cashtag (optional)</label>
        <input type="text" class="form-input" id="edit-child-cashapp" placeholder="$cashtag">
        <p style="font-size: 11px; color: #64748b; margin-top: 4px;">Used for quick Cash App payments on payday</p>
      </div>
      <div style="display: flex; gap: 10px; margin-top: 20px;">
        <button class="btn btn-secondary btn-lg" style="flex: 1;" onclick="closeModal('edit-child-modal')">Cancel</button>
        <button class="btn btn-primary btn-lg" style="flex: 1;" onclick="saveChildEdit()">Save</button>
      </div>
    </div>
  </div>

  <!-- Payday Modal -->
  <div class="modal-overlay" id="payday-modal">
    <div class="modal payday-modal">
      <div class="payday-icon"></div>
      <div class="payday-title">PAYDAY!</div>
      <div class="payday-subtitle">Here's what you've earned this week</div>
      <div class="payday-amount" id="payday-amount">$0.00</div>
      <div class="payday-details">
        <div class="payday-row">
          <span>Rank</span>
          <span id="payday-rank">F</span>
        </div>
        <div class="payday-row">
          <span>Base Pay</span>
          <span id="payday-base">$0.00</span>
        </div>
        <div class="payday-row">
          <span>Streak Multiplier</span>
          <span id="payday-multiplier">1x</span>
        </div>
        <div class="payday-row" id="payday-bonus-line" style="display: none; color: #22c55e;">
          <span>Bonus Tasks</span>
          <span id="payday-bonus-amount">$0.00</span>
        </div>
        <div class="payday-row" style="border-top: 1px solid rgba(255,255,255,0.1); padding-top: 8px; margin-top: 8px;">
          <span style="font-weight: 700;">TOTAL</span>
          <span id="payday-total" style="font-weight: 700; color: #22c55e;">$0.00</span>
        </div>
      </div>
      <div id="payday-bonus-section" style="margin-top: 16px; padding-top: 16px; border-top: 1px solid rgba(234, 179, 8, 0.3); display: none;">
        <div style="font-size: 12px; font-weight: 700; color: #fbbf24; margin-bottom: 10px;"> EARN MORE WITH BONUS TASKS:</div>
        <div id="payday-bonus-list" style="font-size: 12px; color: #94a3b8;"></div>
      </div>
      <button class="btn btn-primary btn-lg" onclick="closeModal('payday-modal')">Awesome! </button>
    </div>
  </div>

  <!-- Theme Selector Modal -->
  <div class="modal-overlay" id="theme-modal">
    <div class="modal">
      <div class="modal-title"> Choose Your Style</div>
      <p style="color: #94a3b8; font-size: 13px; margin-bottom: 20px; text-align: center;">Pick a theme that matches your vibe!</p>
      <div class="theme-grid">
        <div class="theme-card" data-theme="default" onclick="selectTheme('default')" style="background: linear-gradient(135deg, #1a1a2e, #16213e); border-color: rgba(59, 130, 246, 0.3);">
          <div class="theme-card-icon"></div>
          <div class="theme-card-name" style="color: #60a5fa;">Quest Log</div>
          <div class="theme-card-desc" style="color: #94a3b8;">Earn XP  Classic RPG</div>
        </div>
        <div class="theme-card" data-theme="roblox" onclick="selectTheme('roblox')" style="background: linear-gradient(135deg, #2d2d2d, #1a1a1a); border-color: rgba(0, 162, 255, 0.3);">
          <div class="theme-card-icon"></div>
          <div class="theme-card-name" style="color: #00a2ff;">Roblox</div>
          <div class="theme-card-desc" style="color: #00d4aa;">Earn R$  Obbies</div>
        </div>
        <div class="theme-card" data-theme="fortnite" onclick="selectTheme('fortnite')" style="background: linear-gradient(135deg, #1b263b, #0d1b2a); border-color: rgba(157, 78, 221, 0.3);">
          <div class="theme-card-icon"></div>
          <div class="theme-card-name" style="color: #e0aaff;">Battle Pass</div>
          <div class="theme-card-desc" style="color: #06ffa5;">Earn V-Bucks  Challenges</div>
        </div>
        <div class="theme-card" data-theme="minecraft" onclick="selectTheme('minecraft')" style="background: linear-gradient(135deg, #3d2914, #2d1f0f); border-color: rgba(93, 140, 46, 0.3);">
          <div class="theme-card-icon"></div>
          <div class="theme-card-name" style="color: #7cb342;">Minecraft</div>
          <div class="theme-card-desc" style="color: #c9b896;">Earn   Survival</div>
        </div>
        <div class="theme-card" data-theme="barbie" onclick="selectTheme('barbie')" style="background: linear-gradient(135deg, #ff69b4, #ff1493); border-color: rgba(255, 182, 193, 0.5);">
          <div class="theme-card-icon"></div>
          <div class="theme-card-name" style="color: #fff;">Barbie</div>
          <div class="theme-card-desc" style="color: #ffe4ec;">Earn   Dreamhouse</div>
        </div>
        <div class="theme-card" data-theme="animalcrossing" onclick="selectTheme('animalcrossing')" style="background: linear-gradient(135deg, #7ed6a5, #4db6ac); border-color: rgba(165, 214, 167, 0.5);">
          <div class="theme-card-icon"></div>
          <div class="theme-card-name" style="color: #fff;">Animal Crossing</div>
          <div class="theme-card-desc" style="color: #e8f5e9;">Earn   Island Life</div>
        </div>
        <div class="theme-card" data-theme="gacha" onclick="selectTheme('gacha')" style="background: linear-gradient(135deg, #e1bee7, #ce93d8); border-color: rgba(186, 104, 200, 0.5);">
          <div class="theme-card-icon"></div>
          <div class="theme-card-name" style="color: #4a148c;">Gacha Life</div>
          <div class="theme-card-desc" style="color: #6a1b9a;">Earn   Create OCs</div>
        </div>
        <div class="theme-card" data-theme="princess" onclick="selectTheme('princess')" style="background: linear-gradient(135deg, #9575cd, #7e57c2); border-color: rgba(179, 157, 219, 0.5);">
          <div class="theme-card-icon"></div>
          <div class="theme-card-name" style="color: #ffd700;">Princess</div>
          <div class="theme-card-desc" style="color: #e1bee7;">Earn   Royal Quest</div>
        </div>
      </div>
      <button class="btn btn-secondary btn-lg" style="margin-top: 20px;" onclick="closeModal('theme-modal')">Close</button>
    </div>
  </div>

  <!-- Weekly Reset Welcome Modal -->
  <div class="modal-overlay" id="weekly-welcome-modal">
    <div class="modal" style="text-align: center;">
      <div style="font-size: 60px; margin-bottom: 16px;"></div>
      <div class="modal-title" style="color: #fbbf24;">New Week, New Quests!</div>
      <p style="color: #94a3b8; font-size: 14px; margin-bottom: 20px;">
        Your weekly progress has been reset. Time to earn XP and climb the ranks!
      </p>

      <div style="background: rgba(59, 130, 246, 0.1); border: 1px solid rgba(59, 130, 246, 0.3); border-radius: 12px; padding: 16px; margin-bottom: 16px; text-align: left;">
        <div style="font-size: 12px; font-weight: 700; color: #60a5fa; margin-bottom: 10px;"> YOUR QUESTS THIS WEEK</div>
        <div id="weekly-chores-summary" style="font-size: 13px; color: #e2e8f0;"></div>
      </div>

      <div id="new-chores-section" style="display: none; background: rgba(34, 197, 94, 0.1); border: 1px solid rgba(34, 197, 94, 0.3); border-radius: 12px; padding: 16px; margin-bottom: 16px; text-align: left;">
        <div style="font-size: 12px; font-weight: 700; color: #4ade80; margin-bottom: 10px;"> NEW THIS WEEK</div>
        <div id="new-chores-list" style="font-size: 13px; color: #e2e8f0;"></div>
      </div>

      <div style="background: rgba(139, 92, 246, 0.1); border: 1px solid rgba(139, 92, 246, 0.3); border-radius: 12px; padding: 16px; margin-bottom: 20px; text-align: left;">
        <div style="font-size: 12px; font-weight: 700; color: #c4b5fd; margin-bottom: 8px;"> PRO TIPS</div>
        <ul style="font-size: 12px; color: #94a3b8; margin: 0; padding-left: 18px;">
          <li style="margin-bottom: 6px;">Complete <strong style="color: #c4b5fd;">all nightly patrols</strong> for 7 days to get <strong style="color: #fbbf24;">1.5x pay!</strong></li>
          <li style="margin-bottom: 6px;">Reach <strong style="color: #ffd700;">S Rank</strong> (500+ XP) for maximum earnings</li>
          <li>Don't miss a day - every quest counts!</li>
        </ul>
      </div>

      <div id="weekly-goal-section" style="background: rgba(234, 179, 8, 0.1); border: 1px solid rgba(234, 179, 8, 0.3); border-radius: 12px; padding: 16px; margin-bottom: 20px;">
        <div style="font-size: 12px; font-weight: 700; color: #fbbf24; margin-bottom: 4px;"> THIS WEEK'S GOAL</div>
        <div id="weekly-goal-text" style="font-size: 14px; color: #e2e8f0;"></div>
      </div>

      <button class="btn btn-primary btn-lg" onclick="closeModal('weekly-welcome-modal')" style="background: linear-gradient(135deg, #fbbf24, #f59e0b);">
        Let's Go! 
      </button>
    </div>
  </div>

  <!-- Edit Reminder Modal -->
  <div class="modal-overlay" id="edit-reminder-modal">
    <div class="modal" style="max-width: 340px;">
      <div class="modal-title"> Set Reminder</div>
      <input type="hidden" id="edit-reminder-assignment-id">
      <input type="hidden" id="edit-reminder-chore-name">
      <input type="hidden" id="edit-reminder-child-name">
      <input type="hidden" id="edit-reminder-chore-icon">
      <input type="hidden" id="edit-reminder-schedule">
      <p style="color: #94a3b8; font-size: 13px; margin-bottom: 16px; text-align: center;" id="edit-reminder-desc"></p>
      <div class="form-group">
        <label class="form-label">Reminder Time</label>
        <input type="time" class="form-input" id="edit-reminder-time" style="font-size: 18px; text-align: center;">
      </div>
      <p style="font-size: 13px; color: #64748b; margin-bottom: 16px; text-align: center;">
        A notification will be sent at this time to remind about the chore.
      </p>
      <button class="btn btn-primary btn-lg" onclick="saveReminder()">Save Reminder</button>
      <button class="btn btn-secondary btn-lg" onclick="clearReminder()" style="background: rgba(239, 68, 68, 0.1); color: #f87171; border-color: rgba(239, 68, 68, 0.3);">Remove Reminder</button>
      <button class="btn btn-secondary btn-lg" onclick="closeModal('edit-reminder-modal')">Cancel</button>
    </div>
  </div>

  <!-- Edit Zone Modal -->
  <div class="modal-overlay" id="edit-zone-modal">
    <div class="modal">
      <div class="modal-title"> Edit Zone</div>
      <input type="hidden" id="edit-zone-key">
      <div class="form-group">
        <label class="form-label">Zone Name</label>
        <input type="text" class="form-input" id="edit-zone-name" placeholder="Kitchen">
      </div>
      <div class="form-group">
        <label class="form-label">Icon</label>
        <select class="form-select" id="edit-zone-icon">
          <option value=""> Bedroom</option>
          <option value=""> Living Room</option>
          <option value=""> House</option>
          <option value=""> Kitchen</option>
          <option value=""> Bathroom</option>
          <option value=""> Garage</option>
          <option value=""> Yard</option>
          <option value=""> Office/Study</option>
          <option value=""> Game Room</option>
          <option value=""> Laundry</option>
        </select>
      </div>
      <button class="btn btn-primary btn-lg" onclick="saveZoneEdit()">Save Changes</button>
      <button class="btn btn-secondary btn-lg" onclick="closeModal('edit-zone-modal')">Cancel</button>
    </div>
  </div>

  <!-- Edit Chore Modal -->
  <div class="modal-overlay" id="edit-chore-modal">
    <div class="modal">
      <div class="modal-title"> Edit Chore</div>
      <input type="hidden" id="edit-chore-id">
      <div class="form-group">
        <label class="form-label">Chore Name</label>
        <input type="text" class="form-input" id="edit-chore-name" placeholder="Take out trash">
      </div>
      <div class="form-group">
        <label class="form-label">Expectations</label>
        <textarea class="form-input" id="edit-chore-desc" placeholder="What exactly needs to be done? Be specific!" rows="3" style="resize: vertical;"></textarea>
      </div>
      <div style="display: flex; gap: 10px;">
        <div class="form-group" style="flex: 1;">
          <label class="form-label">Icon</label>
          <select class="form-select" id="edit-chore-icon">
            <option value=""> Trash</option>
            <option value=""> Dishes</option>
            <option value=""> Bed/Room</option>
            <option value=""> Boxes</option>
            <option value=""> Sweep</option>
            <option value=""> Laundry</option>
            <option value=""> Pets</option>
            <option value=""> Yard</option>
            <option value=""> Office</option>
            <option value=""> Other</option>
          </select>
        </div>
        <div class="form-group" style="flex: 1;">
          <label class="form-label">XP Value</label>
          <select class="form-select" id="edit-chore-xp">
            <option value="5">5 XP</option>
            <option value="10">10 XP</option>
            <option value="15">15 XP</option>
            <option value="20">20 XP</option>
            <option value="25">25 XP</option>
            <option value="30">30 XP</option>
            <option value="35">35 XP</option>
          </select>
        </div>
      </div>
      <button class="btn btn-primary btn-lg" onclick="saveChoreEdit()">Save Changes</button>
      <button class="btn btn-secondary btn-lg" onclick="closeModal('edit-chore-modal')">Cancel</button>
    </div>
  </div>

  <!-- Add Chore Modal -->
  <div class="modal-overlay" id="add-chore-modal">
    <div class="modal">
      <div class="modal-title">+ Add New Chore</div>
      <div class="form-group">
        <label class="form-label">Quick Templates</label>
        <div id="chore-templates-picker" style="display: flex; flex-wrap: wrap; gap: 8px; margin-bottom: 8px;"></div>
      </div>
      <div class="form-group">
        <label class="form-label">Chore Name</label>
        <input type="text" class="form-input" id="add-chore-name" placeholder="Take out trash">
      </div>
      <div class="form-group">
        <label class="form-label">Expectations</label>
        <textarea class="form-input" id="add-chore-desc" placeholder="What exactly needs to be done? Be specific!" rows="3" style="resize: vertical;"></textarea>
      </div>
      <div style="display: flex; gap: 10px;">
        <div class="form-group" style="flex: 1;">
          <label class="form-label">Icon</label>
          <select class="form-select" id="add-chore-icon">
            <option value=""> Trash</option>
            <option value=""> Dishes</option>
            <option value=""> Bed/Room</option>
            <option value=""> Boxes</option>
            <option value=""> Sweep</option>
            <option value=""> Laundry</option>
            <option value=""> Pets</option>
            <option value=""> Yard</option>
            <option value=""> Office</option>
            <option value=""> Bathroom</option>
            <option value=""> Home</option>
            <option value=""> School</option>
            <option value=""> Other</option>
          </select>
        </div>
        <div class="form-group" style="flex: 1;">
          <label class="form-label">XP Value</label>
          <select class="form-select" id="add-chore-xp">
            <option value="5">5 XP</option>
            <option value="10" selected>10 XP</option>
            <option value="15">15 XP</option>
            <option value="20">20 XP</option>
            <option value="25">25 XP</option>
            <option value="30">30 XP</option>
          </select>
        </div>
      </div>
      <button class="btn btn-primary btn-lg" onclick="addChoreFromPortal()">Add Chore</button>
      <button class="btn btn-secondary btn-lg" onclick="closeModal('add-chore-modal')">Cancel</button>
    </div>
  </div>

  <!-- Assign Chore Modal -->
  <div class="modal-overlay" id="assign-modal">
    <div class="modal">
      <div class="modal-title"> Assign Chore</div>
      <div class="form-group">
        <label class="form-label">Child</label>
        <select class="form-select" id="assign-child"></select>
      </div>
      <div class="form-group">
        <label class="form-label">Chore</label>
        <select class="form-select" id="assign-chore"></select>
      </div>
      <div class="form-group">
        <label class="form-label">Schedule</label>
        <select class="form-select" id="assign-schedule" onchange="toggleDayPicker()">
          <option value="daily">Daily</option>
          <option value="weekly">Specific Day</option>
          <option value="multiple">Select Days</option>
        </select>
      </div>
      <div class="form-group" id="day-picker-group" style="display: none;">
        <label class="form-label">Day of Week</label>
        <select class="form-select" id="assign-day">
          <option value="0">Sunday</option>
          <option value="1">Monday</option>
          <option value="2">Tuesday</option>
          <option value="3">Wednesday</option>
          <option value="4">Thursday</option>
          <option value="5">Friday</option>
          <option value="6">Saturday</option>
        </select>
      </div>
      <div class="form-group" id="multi-day-picker-group" style="display: none;">
        <label class="form-label">Select Days</label>
        <div style="display: flex; flex-wrap: wrap; gap: 8px;">
          <label class="day-checkbox"><input type="checkbox" name="assign-days" value="0"> <span>Sun</span></label>
          <label class="day-checkbox"><input type="checkbox" name="assign-days" value="1"> <span>Mon</span></label>
          <label class="day-checkbox"><input type="checkbox" name="assign-days" value="2"> <span>Tue</span></label>
          <label class="day-checkbox"><input type="checkbox" name="assign-days" value="3"> <span>Wed</span></label>
          <label class="day-checkbox"><input type="checkbox" name="assign-days" value="4"> <span>Thu</span></label>
          <label class="day-checkbox"><input type="checkbox" name="assign-days" value="5"> <span>Fri</span></label>
          <label class="day-checkbox"><input type="checkbox" name="assign-days" value="6"> <span>Sat</span></label>
        </div>
      </div>
      <div class="form-group">
        <label style="display: flex; align-items: center; gap: 8px; color: #e2e8f0; font-size: 13px;">
          <input type="checkbox" id="assign-nightly"> Mark as Nightly Patrol
        </label>
      </div>
      <div class="form-group">
        <label class="form-label">Reminder Time (optional)</label>
        <input type="time" class="form-input" id="assign-reminder-time" placeholder="Leave blank for no reminder">
        <p style="font-size: 13px; color: #64748b; margin-top: 4px;">Set a daily reminder for this chore</p>
      </div>
      <button class="btn btn-primary btn-lg" onclick="saveAssignment()">Assign Chore</button>
      <button class="btn btn-secondary btn-lg" onclick="closeModal('assign-modal')">Cancel</button>
    </div>
  </div>

  <!-- Add Reminder Modal -->
  <div class="modal-overlay" id="add-reminder-modal">
    <div class="modal">
      <div class="modal-title"> Add Reminder</div>
      <div class="form-group">
        <label class="form-label">Reminder Time</label>
        <input type="time" class="form-input" id="add-reminder-time" value="20:00">
      </div>
      <div class="form-group">
        <label class="form-label">Type</label>
        <select class="form-select" id="add-reminder-type">
          <option value="nightly">Nightly Reminder</option>
          <option value="morning">Morning Reminder</option>
          <option value="custom">Custom</option>
        </select>
      </div>
      <div class="form-group">
        <label class="form-label">Message (optional)</label>
        <input type="text" class="form-input" id="add-reminder-message" placeholder="Time to do your chores!">
      </div>
      <button class="btn btn-primary btn-lg" onclick="saveNewReminder()">Add Reminder</button>
      <button class="btn btn-secondary btn-lg" onclick="closeModal('add-reminder-modal')">Cancel</button>
    </div>
  </div>

  <!-- Edit Assignment Modal -->
  <div class="modal-overlay" id="edit-assignment-modal">
    <div class="modal">
      <div class="modal-title"> Edit Assignment</div>
      <input type="hidden" id="edit-assignment-id">
      <div class="form-group">
        <label class="form-label">Chore</label>
        <div id="edit-assignment-chore-name" style="padding: 10px; background: rgba(30, 41, 59, 0.6); border-radius: 8px; color: #e2e8f0;"></div>
      </div>
      <div class="form-group">
        <label class="form-label">Schedule</label>
        <select class="form-select" id="edit-assignment-schedule" onchange="toggleEditDaySelect()">
          <option value="daily">Daily</option>
          <option value="weekly">Specific Day</option>
        </select>
      </div>
      <div class="form-group" id="edit-day-group" style="display: none;">
        <label class="form-label">Day of Week</label>
        <select class="form-select" id="edit-assignment-day">
          <option value="0">Sunday</option>
          <option value="1">Monday</option>
          <option value="2">Tuesday</option>
          <option value="3">Wednesday</option>
          <option value="4">Thursday</option>
          <option value="5">Friday</option>
          <option value="6">Saturday</option>
        </select>
      </div>
      <div class="form-group">
        <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
          <input type="checkbox" id="edit-assignment-nightly" style="width: 20px; height: 20px;">
          <span class="form-label" style="margin: 0;"> Nightly Patrol Chore</span>
        </label>
      </div>
      <div class="form-group">
        <label class="form-label">Reminder Time (optional)</label>
        <input type="time" class="form-input" id="edit-assignment-reminder-time">
        <input type="hidden" id="edit-assignment-reminder-id">
        <p style="font-size: 13px; color: #64748b; margin-top: 4px;">Set a daily reminder for this chore (leave blank for no reminder)</p>
      </div>
      <button class="btn btn-primary btn-lg" onclick="saveAssignmentEdit()">Save Changes</button>
      <button class="btn btn-secondary btn-lg" onclick="closeModal('edit-assignment-modal')">Cancel</button>
    </div>
  </div>

  <!-- Add Bonus/Money Maker Modal -->
  <div class="modal-overlay" id="add-bonus-modal">
    <div class="modal">
      <div class="modal-title"> Add Money Maker</div>
      <div class="form-group">
        <label class="form-label">Task Name</label>
        <input type="text" class="form-input" id="add-bonus-name" placeholder="Mow the lawn">
      </div>
      <div class="form-group">
        <label class="form-label">Description</label>
        <input type="text" class="form-input" id="add-bonus-desc" placeholder="Front and back yard">
      </div>
      <div style="display: flex; gap: 10px;">
        <div class="form-group" style="flex: 1;">
          <label class="form-label">Icon</label>
          <select class="form-select" id="add-bonus-icon">
            <option value=""> Cash</option>
            <option value=""> Yard</option>
            <option value=""> Car</option>
            <option value=""> Clean</option>
            <option value=""> Pets</option>
            <option value=""> Organize</option>
            <option value=""> Fix</option>
            <option value=""> Special</option>
          </select>
        </div>
        <div class="form-group" style="flex: 1;">
          <label class="form-label">Reward ($)</label>
          <select class="form-select" id="add-bonus-amount">
            <option value="1">$1.00</option>
            <option value="2">$2.00</option>
            <option value="3">$3.00</option>
            <option value="5" selected>$5.00</option>
            <option value="10">$10.00</option>
            <option value="15">$15.00</option>
            <option value="20">$20.00</option>
          </select>
        </div>
      </div>
      <button class="btn btn-primary btn-lg" onclick="saveNewBonus()">Add Money Maker</button>
      <button class="btn btn-secondary btn-lg" onclick="closeModal('add-bonus-modal')">Cancel</button>
    </div>
  </div>

  <!-- Add Privilege Modal -->
  <div class="modal-overlay" id="add-privilege-modal">
    <div class="modal">
      <div class="modal-title"> Add Privilege</div>
      <div class="form-group">
        <label class="form-label">Privilege Name</label>
        <input type="text" class="form-input" id="add-privilege-name" placeholder="Extra screen time">
      </div>
      <div class="form-group">
        <label class="form-label">Description</label>
        <input type="text" class="form-input" id="add-privilege-desc" placeholder="30 extra minutes of screen time">
      </div>
      <div style="display: flex; gap: 10px;">
        <div class="form-group" style="flex: 1;">
          <label class="form-label">Icon</label>
          <select class="form-select" id="add-privilege-icon">
            <option value=""> Gaming</option>
            <option value=""> TV</option>
            <option value=""> Food</option>
            <option value=""> Bedtime</option>
            <option value=""> Movie</option>
            <option value=""> Shopping</option>
            <option value=""> Party</option>
            <option value=""> Special</option>
          </select>
        </div>
        <div class="form-group" style="flex: 1;">
          <label class="form-label">Unlock When</label>
          <select class="form-select" id="add-privilege-unlock-type">
            <option value="manual">Manual (Parent grants)</option>
            <option value="xp_threshold">XP Threshold</option>
            <option value="achievement">With Achievement</option>
          </select>
        </div>
      </div>
      <div class="form-group" id="privilege-xp-group" style="display: none;">
        <label class="form-label">XP Required</label>
        <select class="form-select" id="add-privilege-xp">
          <option value="100">100 XP</option>
          <option value="250">250 XP</option>
          <option value="500">500 XP</option>
          <option value="1000">1000 XP</option>
          <option value="2500">2500 XP</option>
        </select>
      </div>
      <button class="btn btn-primary btn-lg" onclick="saveNewPrivilege()">Add Privilege</button>
      <button class="btn btn-secondary btn-lg" onclick="closeModal('add-privilege-modal')">Cancel</button>
    </div>
  </div>

  <!-- Toast -->
  <div class="toast" id="toast">+XP!</div>

  <script type="module">
    import {
      supabase,
      getDeviceId,
      getCurrentUser,
      setCurrentUser,
      getCurrentFamily,
      setCurrentFamily,
      getDeviceRole,
      setDeviceRole,
      createFamily,
      generateFamilyLinkCode,
      findFamilyByLinkCode,
      createUser,
      getUserById,
      getUserByDeviceId,
      linkDeviceToChild,
      getFamilyMembers,
      getChildren,
      updateUserXP,
      updateUser,
      deleteUser,
      resetChildProgress,
      createChoreTemplate,
      getChoreTemplates,
      deleteChoreTemplate,
      updateChoreTemplate,
      createChoreAssignment,
      getChildAssignments,
      deleteChoreAssignment,
      updateChoreAssignment,
      completeChore,
      getTodaysCompletions,
      getAchievements,
      getChildAchievementUnlocks,
      unlockAchievement,
      claimAchievementReward,
      getPrivileges,
      createPrivilege,
      getChildPrivilegeUnlocks,
      unlockPrivilege,
      usePrivilege,
      getWeeklyCompletions,
      getChildReminders,
      deleteReminder,
      createReminder,
      updateReminder,
      isPushSupported,
      getPushSubscription,
      subscribeToPush,
      unsubscribeFromPush,
      getBonusTasks as getBonusTasksFromDB,
      createBonusTask,
      updateBonusTask as updateBonusTaskInDB,
      deleteBonusTask as deleteBonusTaskFromDB,
      getBonusTaskCompletions,
      completeBonusTask,
      requestBonusTask,
      approveBonusTask,
      denyBonusTask,
      getPendingBonusTasks,
      resetAchievements,
      resetPrivileges,
      getNightlyZonesFromDB,
      createNightlyZone,
      updateNightlyZone as updateNightlyZoneInDB,
      deleteNightlyZone as deleteNightlyZoneFromDB,
      getNightlyCompletions,
      completeNightlyZone,
      loginParentWithPin
    } from './js/supabase-client.js';

    // Theme System with Game Vocabulary
    const THEME_KEY = 'chore_chart_theme';
    const AVAILABLE_THEMES = ['default', 'roblox', 'fortnite', 'minecraft', 'barbie', 'animalcrossing', 'gacha', 'princess'];

    // Game-specific vocabulary
    const THEME_VOCAB = {
      default: {
        appName: 'QUEST LOG',
        appTagline: 'Complete quests. Earn XP. Get paid.',
        xp: 'XP',
        xpFull: 'Experience Points',
        level: 'LEVEL',
        rank: 'RANK',
        quests: 'QUESTS',
        questsToday: "TODAY'S QUESTS",
        missions: 'MISSIONS',
        wallet: 'Wallet',
        walletTitle: "THIS WEEK'S EARNINGS",
        trophies: 'Trophies',
        achievements: 'ACHIEVEMENTS',
        nightly: 'NIGHTLY PATROL',
        nightlyDesc: 'Go around and put away all your items that are scattered around the house!',
        nightlyZones: 'zones',
        complete: 'Complete',
        completed: 'Completed',
        streak: 'STREAK',
        streakBonus: 'Complete ALL nightly patrols for 7 days = 1.5x weekly pay!',
        moneyMakers: 'MONEY MAKERS',
        bonusXP: 'BONUS XP',
        payday: 'PAYDAY!',
        paydayDesc: "Here's what you've earned this week",
        basePay: 'Base Pay',
        letsGo: "Let's Go!",
        awesome: 'Awesome!',
        proTips: 'PRO TIPS',
        weeklyGoal: "THIS WEEK'S GOAL",
        currency: '$'
      },
      roblox: {
        appName: 'ROBUX GRIND',
        appTagline: 'Complete obbies. Earn Robux. Level up!',
        xp: 'R$',
        xpFull: 'Robux',
        level: 'LEVEL',
        rank: 'BADGE',
        quests: 'OBBIES',
        questsToday: "TODAY'S OBBIES",
        missions: 'EXPERIENCES',
        wallet: 'Inventory',
        walletTitle: 'WEEKLY ROBUX EARNED',
        trophies: 'Badges',
        achievements: 'BADGES EARNED',
        nightly: 'CLEANUP OBBY',
        nightlyDesc: 'Complete the cleanup obby! Put away all your items around the house!',
        nightlyZones: 'checkpoints',
        complete: 'Beat it',
        completed: 'Beaten',
        streak: 'WIN STREAK',
        streakBonus: 'Beat ALL cleanup obbies for 7 days = 1.5x Robux bonus!',
        moneyMakers: 'ROBUX BOOSTERS',
        bonusXP: 'BONUS R$',
        payday: 'ROBUX DROP!',
        paydayDesc: "Here's your Robux haul this week",
        basePay: 'Base Robux',
        letsGo: 'Join Server!',
        awesome: 'GG!',
        proTips: 'PRO GAMER TIPS',
        weeklyGoal: 'GRIND GOAL',
        currency: 'R$'
      },
      fortnite: {
        appName: 'BATTLE PASS',
        appTagline: 'Complete challenges. Earn V-Bucks. Victory Royale!',
        xp: 'V',
        xpFull: 'V-Bucks',
        level: 'TIER',
        rank: 'DIVISION',
        quests: 'CHALLENGES',
        questsToday: 'DAILY CHALLENGES',
        missions: 'CHALLENGES',
        wallet: 'Locker',
        walletTitle: 'WEEKLY V-BUCKS',
        trophies: 'Victories',
        achievements: 'VICTORY ROYALES',
        nightly: 'STORM SWEEP',
        nightlyDesc: 'Survive the storm! Clear all zones before the circle closes!',
        nightlyZones: 'safe zones',
        complete: 'Eliminate',
        completed: 'Eliminated',
        streak: 'WIN STREAK',
        streakBonus: 'Survive ALL storm sweeps for 7 days = 1.5x V-Bucks!',
        moneyMakers: 'BOUNTIES',
        bonusXP: 'BONUS V-BUCKS',
        payday: 'VICTORY ROYALE!',
        paydayDesc: "You've secured this week's loot",
        basePay: 'Base Loot',
        letsGo: 'Drop In!',
        awesome: '#1 Victory Royale!',
        proTips: 'BATTLE TIPS',
        weeklyGoal: 'SEASON GOAL',
        currency: 'V'
      },
      minecraft: {
        appName: 'SURVIVAL MODE',
        appTagline: 'Mine resources. Earn emeralds. Survive the night!',
        xp: 'XP',
        xpFull: 'XP Orbs',
        level: 'LEVEL',
        rank: 'TIER',
        quests: 'TASKS',
        questsToday: 'DAILY TASKS',
        missions: 'SURVIVAL',
        wallet: 'Chest',
        walletTitle: 'WEEKLY EMERALDS',
        trophies: 'Advancements',
        achievements: 'ADVANCEMENTS',
        nightly: 'NIGHT WATCH',
        nightlyDesc: 'Secure your base! Make sure everything is stored before nightfall!',
        nightlyZones: 'biomes',
        complete: 'Mine',
        completed: 'Mined',
        streak: 'SURVIVAL',
        streakBonus: 'Survive ALL nights for 7 days = 1.5x emerald bonus!',
        moneyMakers: 'VILLAGER TRADES',
        bonusXP: 'BONUS EMERALDS',
        payday: 'LOOT CHEST!',
        paydayDesc: "Here's what you've gathered this week",
        basePay: 'Base Trade',
        letsGo: 'Start Mining!',
        awesome: 'Achievement Get!',
        proTips: 'CRAFTING TIPS',
        weeklyGoal: 'MINING GOAL',
        currency: ''
      },
      barbie: {
        appName: 'DREAMHOUSE',
        appTagline: 'Complete tasks. Earn sparkles. Live your best life!',
        xp: '',
        xpFull: 'Sparkle Points',
        level: 'STYLE',
        rank: 'ICON',
        quests: 'GOALS',
        questsToday: "TODAY'S GOALS",
        missions: 'DREAMS',
        wallet: 'Boutique',
        walletTitle: 'WEEKLY SPARKLES',
        trophies: 'Glam',
        achievements: 'GLAM MOMENTS',
        nightly: 'DREAMHOUSE CLEANUP',
        nightlyDesc: 'Keep your Dreamhouse fabulous! Put away everything before bedtime!',
        nightlyZones: 'rooms',
        complete: 'Slay',
        completed: 'Slayed',
        streak: 'FABULOUS',
        streakBonus: 'Stay fabulous for 7 days = 1.5x sparkle bonus!',
        moneyMakers: 'BONUS GLAM',
        bonusXP: 'EXTRA SPARKLES',
        payday: 'SHOPPING SPREE!',
        paydayDesc: "You've earned this week's sparkles",
        basePay: 'Base Glam',
        letsGo: "Let's Go Party!",
        awesome: 'Iconic!',
        proTips: 'STYLE TIPS',
        weeklyGoal: 'DREAM GOAL',
        currency: ''
      },
      animalcrossing: {
        appName: 'ISLAND LIFE',
        appTagline: 'Complete tasks. Earn bells. Make your island shine!',
        xp: '',
        xpFull: 'Bells',
        level: 'STAR',
        rank: 'ISLAND',
        quests: 'TASKS',
        questsToday: "TODAY'S TASKS",
        missions: 'ISLAND WORK',
        wallet: 'Nook Shop',
        walletTitle: 'WEEKLY BELLS',
        trophies: 'Stamps',
        achievements: 'NOOK MILES',
        nightly: 'ISLAND CLEANUP',
        nightlyDesc: 'Keep your island 5-star! Pick up items before Tom Nook visits!',
        nightlyZones: 'areas',
        complete: 'Done',
        completed: 'Complete',
        streak: 'STREAK',
        streakBonus: 'Complete ALL cleanups for 7 days = 1.5x bell bonus!',
        moneyMakers: 'HOT ITEMS',
        bonusXP: 'BONUS BELLS',
        payday: 'PAYDAY!',
        paydayDesc: "Here's your bell bag this week",
        basePay: 'Base Bells',
        letsGo: "Let's Do This!",
        awesome: 'Yay!',
        proTips: 'ISLAND TIPS',
        weeklyGoal: 'ISLAND GOAL',
        currency: ''
      },
      gacha: {
        appName: 'GACHA STUDIO',
        appTagline: 'Complete missions. Earn gems. Create your story!',
        xp: '',
        xpFull: 'Gems',
        level: 'STAR',
        rank: 'RANK',
        quests: 'MISSIONS',
        questsToday: "TODAY'S MISSIONS",
        missions: 'STORY MODE',
        wallet: 'Gacha',
        walletTitle: 'WEEKLY GEMS',
        trophies: 'OCs',
        achievements: 'UNLOCKED OCs',
        nightly: 'STUDIO CLEANUP',
        nightlyDesc: 'Keep your studio organized! Put away props before filming!',
        nightlyZones: 'sets',
        complete: 'Clear',
        completed: 'Cleared',
        streak: 'COMBO',
        streakBonus: 'Keep your combo for 7 days = 1.5x gem bonus!',
        moneyMakers: 'RARE PULLS',
        bonusXP: 'BONUS GEMS',
        payday: 'GACHA PULL!',
        paydayDesc: "Here's your gem stash this week",
        basePay: 'Base Gems',
        letsGo: 'Start Story!',
        awesome: 'UwU Amazing!',
        proTips: 'OC TIPS',
        weeklyGoal: 'STORY GOAL',
        currency: ''
      },
      princess: {
        appName: 'ROYAL QUEST',
        appTagline: 'Complete quests. Earn crowns. Rule your kingdom!',
        xp: '',
        xpFull: 'Royal Crowns',
        level: 'ROYAL',
        rank: 'TITLE',
        quests: 'ROYAL DUTIES',
        questsToday: "TODAY'S DUTIES",
        missions: 'KINGDOM',
        wallet: 'Treasury',
        walletTitle: 'WEEKLY CROWNS',
        trophies: 'Treasures',
        achievements: 'ROYAL TREASURES',
        nightly: 'CASTLE CLEANUP',
        nightlyDesc: 'Keep your castle sparkling! A true royal tidies their kingdom!',
        nightlyZones: 'chambers',
        complete: 'Grant',
        completed: 'Granted',
        streak: 'REIGN',
        streakBonus: 'Reign for 7 days = 1.5x crown bonus!',
        moneyMakers: 'ROYAL FAVORS',
        bonusXP: 'BONUS CROWNS',
        payday: 'ROYAL TREASURE!',
        paydayDesc: "The kingdom rewards your service",
        basePay: 'Base Treasure',
        letsGo: 'To the Castle!',
        awesome: 'Magnificent!',
        proTips: 'ROYAL WISDOM',
        weeklyGoal: 'KINGDOM GOAL',
        currency: ''
      }
    };

    function getVocab(key) {
      const theme = getCurrentTheme();
      return THEME_VOCAB[theme]?.[key] || THEME_VOCAB.default[key];
    }

    function getCurrentTheme() {
      return localStorage.getItem(THEME_KEY) || 'default';
    }

    function applyTheme(themeName) {
      // Remove all theme classes
      AVAILABLE_THEMES.forEach(t => {
        document.documentElement.classList.remove(`theme-${t}`);
      });
      // Apply new theme
      document.documentElement.classList.add(`theme-${themeName}`);
      // Update theme card selection
      document.querySelectorAll('.theme-card').forEach(card => {
        card.classList.toggle('selected', card.dataset.theme === themeName);
      });
      // Update vocabulary throughout the app
      updateThemeVocabulary();
    }

    function updateThemeVocabulary() {
      const vocab = THEME_VOCAB[getCurrentTheme()] || THEME_VOCAB.default;

      // Update header
      const headerTag = document.querySelector('.header-tag');
      if (headerTag) headerTag.innerHTML = ` ${vocab.appName} `;

      const headerP = document.querySelector('.header p');
      if (headerP) headerP.textContent = vocab.appTagline;

      // Update tab buttons
      const tabBtns = document.querySelectorAll('.tab-btn');
      if (tabBtns.length >= 3) {
        tabBtns[0].innerHTML = ` ${vocab.quests}`;
        tabBtns[1].innerHTML = ` ${vocab.wallet}`;
        tabBtns[2].innerHTML = ` ${vocab.trophies}`;
      }

      // Update stat labels
      const levelLabel = document.querySelector('.stat-card.level .stat-label');
      if (levelLabel) levelLabel.textContent = vocab.level;

      const xpLabel = document.querySelector('.stat-card.xp .stat-label');
      if (xpLabel) xpLabel.textContent = `TOTAL ${vocab.xp}`;

      const rankLabel = document.querySelector('.stat-card.rank .stat-label');
      if (rankLabel) rankLabel.textContent = vocab.rank;

      // Update section titles
      const questsTitle = document.querySelector('.section.weekly .section-title');
      if (questsTitle) questsTitle.textContent = vocab.questsToday;

      const nightlyTitle = document.querySelector('.section.nightly .section-title');
      if (nightlyTitle) nightlyTitle.textContent = vocab.nightly;

      // Update nightly info
      const nightlyMission = document.querySelector('.section.nightly .nightly-info');
      if (nightlyMission && nightlyMission.innerHTML.includes('MISSION')) {
        nightlyMission.innerHTML = ` <strong>MISSION:</strong> ${vocab.nightlyDesc}`;
      }

      const nightlyStreak = document.querySelectorAll('.section.nightly .nightly-info')[1];
      if (nightlyStreak) {
        nightlyStreak.innerHTML = ` <strong>${vocab.streak} BONUS:</strong> ${vocab.streakBonus}`;
      }

      // Update wallet section
      const walletTitle = document.querySelector('.wallet-title');
      if (walletTitle) walletTitle.textContent = vocab.walletTitle;

      // Update achievements title
      const achieveTitle = document.querySelector('.section.achievements .section-title');
      if (achieveTitle) achieveTitle.textContent = vocab.achievements;

      // Update money makers
      const moneyTitle = document.querySelector('#tab-wallet .section-title');
      if (moneyTitle && moneyTitle.textContent.includes('MONEY')) {
        moneyTitle.textContent = vocab.moneyMakers;
      }

      const moneyBadge = document.querySelector('#tab-wallet .section-badge');
      if (moneyBadge && moneyBadge.textContent.includes('BONUS')) {
        moneyBadge.textContent = vocab.bonusXP;
      }
    }

    window.selectTheme = function(themeName) {
      localStorage.setItem(THEME_KEY, themeName);
      applyTheme(themeName);
      // Re-render components that use vocab
      if (currentUser) {
        renderQuests();
        renderNightly();
        renderMoneyMakersList();
        updateStats();
      }
      showToast(`${getThemeEmoji(themeName)} ${getVocab('awesome')}`);
    };

    function getThemeEmoji(theme) {
      switch(theme) {
        case 'roblox': return '';
        case 'fortnite': return '';
        case 'minecraft': return '';
        case 'barbie': return '';
        case 'animalcrossing': return '';
        case 'gacha': return '';
        case 'princess': return '';
        default: return '';
      }
    }

    // Apply saved theme on load
    applyTheme(getCurrentTheme());

    // Hidden parent access (tap title 5 times)
    let titleTapCount = 0;
    let titleTapTimer = null;

    window.handleTitleTap = function() {
      titleTapCount++;

      if (titleTapTimer) clearTimeout(titleTapTimer);

      titleTapTimer = setTimeout(() => {
        titleTapCount = 0;
      }, 2000); // Reset after 2 seconds of no taps

      if (titleTapCount >= 5) {
        titleTapCount = 0;
        showModal('pin-modal');
      }
    };

    // Pay scale
    const DEFAULT_PAY_SCALE = [
      { name: 'F', minXP: 0, maxXP: 99, pay: 0, color: '#64748b' },
      { name: 'D', minXP: 100, maxXP: 199, pay: 2, color: '#f59e0b' },
      { name: 'C', minXP: 200, maxXP: 299, pay: 4, color: '#22c55e' },
      { name: 'B', minXP: 300, maxXP: 399, pay: 6, color: '#3b82f6' },
      { name: 'A', minXP: 400, maxXP: 499, pay: 8, color: '#a855f7' },
      { name: 'S', minXP: 500, maxXP: 9999, pay: 10, color: '#ffd700' }
    ];

    // Load saved pay scale or use defaults
    const savedPayScale = localStorage.getItem('chore_chart_pay_scale');
    const PAY_SCALE = savedPayScale ? JSON.parse(savedPayScale) : [...DEFAULT_PAY_SCALE];

    const AVATARS = ['', '', '', '', '', '', '', ''];
    const DAY_NAMES = ['SUN', 'MON', 'TUE', 'WED', 'THU', 'FRI', 'SAT'];
    const DEFAULT_ZONES = [
      { key: 'bedroom', icon: '', label: 'YOUR ROOM' },
      { key: 'living', icon: '', label: 'LIVING ROOM' },
      { key: 'other', icon: '', label: 'ELSEWHERE' }
    ];

    function getNightlyZones() {
      if (!currentFamily) return DEFAULT_ZONES;
      // Use database zones if available, otherwise use defaults
      if (nightlyZonesDB.length > 0) {
        return nightlyZonesDB.map(z => ({
          key: z.zone_key,
          name: z.name,
          label: z.name.toUpperCase(),
          icon: z.icon,
          id: z.id
        }));
      }
      return DEFAULT_ZONES;
    }

    async function loadNightlyZonesFromDB() {
      if (!currentFamily) return;
      try {
        nightlyZonesDB = await getNightlyZonesFromDB(currentFamily.id);
      } catch (e) {
        console.log('Nightly zones table may not exist yet:', e);
        nightlyZonesDB = [];
      }
    }

    async function loadNightlyCompletionsFromDB() {
      if (!currentUser) return;
      try {
        nightlyCompletionsDB = await getNightlyCompletions(currentUser.id, getWeekStart());
      } catch (e) {
        console.log('Nightly completions table may not exist yet:', e);
        nightlyCompletionsDB = [];
      }
    }

    // Legacy function - now just refreshes from database
    async function saveNightlyZones(zones) {
      // Zones are now saved directly to database via createNightlyZone/deleteNightlyZoneFromDB
      await loadNightlyZonesFromDB();
    }

    // State
    let currentUser = null;
    let currentFamily = null;
    let parentPinHash = null;
    let children = [];
    let choreTemplates = [];
    let assignments = [];
    let completions = [];
    let achievements = [];
    let achievementUnlocks = []; // Full unlock data with reward_paid status
    let privileges = [];
    let privilegeUnlocks = [];
    let bonusTasks = []; // Money Makers from database
    let bonusTaskCompletions = []; // This week's bonus task completions
    let nightlyZonesDB = []; // Nightly zones from database
    let nightlyCompletionsDB = []; // This week's nightly completions
    let userReminders = []; // Current child's reminders (for sort order)
    let selectedAvatar = '';
    let currentDay = new Date().getDay();

    // Weekly Reset System
    const RESET_HOUR = 20; // 8pm
    const RESET_DAY = 0; // Sunday

    function getLastResetKey() {
      return `last_weekly_reset_${currentFamily?.id || 'unknown'}`;
    }

    function getNewChoresKey() {
      return `new_chores_${currentFamily?.id || 'unknown'}_${getWeekStart()}`;
    }

    function shouldShowWeeklyReset() {
      if (!currentUser || !currentFamily) return false;

      const now = new Date();
      const lastReset = localStorage.getItem(getLastResetKey());
      const currentWeekStart = getWeekStart();

      // Check if we've already shown reset for this week
      if (lastReset === currentWeekStart) return false;

      // Check if it's past Sunday 8pm OR if it's a new week (Mon-Sat)
      const dayOfWeek = now.getDay();
      const hour = now.getHours();

      // If it's Sunday after 8pm, or any day Mon-Sat of a new week
      if (dayOfWeek === RESET_DAY && hour >= RESET_HOUR) {
        return true;
      }

      // If it's Mon-Sat and we haven't shown reset for this week yet
      if (dayOfWeek !== RESET_DAY && !lastReset) {
        return true;
      }

      // If the last reset was from a previous week
      if (lastReset && lastReset < currentWeekStart) {
        return true;
      }

      return false;
    }

    function performWeeklyReset() {
      if (!currentUser || !currentFamily) return;

      const previousWeekStart = getPreviousWeekStart();
      const zones = getNightlyZones();

      // Clear previous week's nightly patrol data
      for (let i = 0; i < 7; i++) {
        const key = `nightly_${currentUser.id}_${previousWeekStart}_${i}`;
        localStorage.removeItem(key);
      }

      // Clear previous week's new chores tracking
      const prevNewChoresKey = `new_chores_${currentFamily.id}_${previousWeekStart}`;
      localStorage.removeItem(prevNewChoresKey);

      // Mark reset as done for this week
      localStorage.setItem(getLastResetKey(), getWeekStart());
    }

    function getPreviousWeekStart() {
      const d = new Date();
      d.setDate(d.getDate() - d.getDay() - 7);
      return d.toISOString().split('T')[0];
    }

    async function showWeeklyWelcome() {
      // Get all chores summary
      const dailyChores = assignments.filter(a => a.recurrence_type === 'daily' && a.chore_templates?.is_active);
      const weeklyChores = assignments.filter(a => a.recurrence_type === 'weekly' && a.chore_templates?.is_active);

      let summaryHTML = '';

      if (dailyChores.length > 0) {
        summaryHTML += `<div style="margin-bottom: 8px;"><strong>Daily:</strong> ${dailyChores.map(a => `${a.chore_templates.icon} ${a.chore_templates.name}`).join(', ')}</div>`;
      }

      if (weeklyChores.length > 0) {
        const groupedByDay = {};
        weeklyChores.forEach(a => {
          const day = DAY_NAMES[a.day_of_week];
          if (!groupedByDay[day]) groupedByDay[day] = [];
          groupedByDay[day].push(`${a.chore_templates.icon} ${a.chore_templates.name}`);
        });

        Object.entries(groupedByDay).forEach(([day, chores]) => {
          summaryHTML += `<div style="margin-bottom: 4px;"><strong>${day}:</strong> ${chores.join(', ')}</div>`;
        });
      }

      if (!summaryHTML) {
        summaryHTML = '<div style="color: #64748b;">No quests assigned yet. Ask a parent to add some!</div>';
      }

      document.getElementById('weekly-chores-summary').innerHTML = summaryHTML;

      // Check for new chores (added this week)
      const newChoresData = localStorage.getItem(getNewChoresKey());
      const newChoreIds = newChoresData ? JSON.parse(newChoresData) : [];

      if (newChoreIds.length > 0) {
        const newSection = document.getElementById('new-chores-section');
        const newList = document.getElementById('new-chores-list');

        const newChoresHTML = assignments
          .filter(a => newChoreIds.includes(a.id))
          .map(a => `<div style="margin-bottom: 4px;">${a.chore_templates?.icon || ''} <strong>${a.chore_templates?.name || 'New chore'}</strong> - ${a.chore_templates?.xp_value || 0} XP</div>`)
          .join('');

        if (newChoresHTML) {
          newList.innerHTML = newChoresHTML;
          newSection.style.display = 'block';
        }
      }

      // Calculate potential earnings
      const totalDailyXP = dailyChores.reduce((sum, a) => sum + (a.chore_templates?.xp_value || 0), 0) * 7;
      const totalWeeklyXP = weeklyChores.reduce((sum, a) => sum + (a.chore_templates?.xp_value || 0), 0);
      const zones = getNightlyZones();
      const nightlyXP = zones.length * 5 * 7;
      const potentialXP = totalDailyXP + totalWeeklyXP + nightlyXP;
      const potentialRank = PAY_SCALE.find(r => potentialXP >= r.minXP) || PAY_SCALE[PAY_SCALE.length - 1];

      document.getElementById('weekly-goal-text').innerHTML = `
        Complete everything to earn up to <strong style="color: #fbbf24;">${potentialXP} XP</strong>
        and reach <strong style="color: ${potentialRank.color};">${potentialRank.name} Rank</strong>
        ($${potentialRank.pay})!
      `;

      showModal('weekly-welcome-modal');
    }

    // Track new chore assignments
    function trackNewChoreAssignment(assignmentId) {
      const key = getNewChoresKey();
      const existing = localStorage.getItem(key);
      const ids = existing ? JSON.parse(existing) : [];
      if (!ids.includes(assignmentId)) {
        ids.push(assignmentId);
        localStorage.setItem(key, JSON.stringify(ids));
      }
    }

    // ============================================
    // Reminder System
    // ============================================

    function getRemindersKey() {
      return `chore_reminders_${currentFamily?.id || 'unknown'}`;
    }

    function getReminders() {
      const data = localStorage.getItem(getRemindersKey());
      return data ? JSON.parse(data) : [];
    }

    function saveReminders(reminders) {
      localStorage.setItem(getRemindersKey(), JSON.stringify(reminders));
    }

    function addReminder(assignmentId, childId, childName, choreName, choreIcon, time, schedule) {
      const reminders = getReminders();
      // Remove existing reminder for this assignment if any
      const filtered = reminders.filter(r => r.assignmentId !== assignmentId);
      filtered.push({
        assignmentId,
        childId,
        childName,
        choreName,
        choreIcon,
        time,
        schedule, // 'daily' or 'weekly-X'
        enabled: true
      });
      saveReminders(filtered);
    }

    function removeReminder(assignmentId) {
      const reminders = getReminders();
      const filtered = reminders.filter(r => r.assignmentId !== assignmentId);
      saveReminders(filtered);
    }

    function getReminderForAssignment(assignmentId) {
      const reminders = getReminders();
      return reminders.find(r => r.assignmentId === assignmentId);
    }

    // Check and send reminders
    let lastReminderCheck = '';

    function checkReminders() {
      const now = new Date();
      const currentTime = now.toTimeString().slice(0, 5); // HH:MM format
      const currentDay = now.getDay();

      // Only check once per minute
      if (currentTime === lastReminderCheck) return;
      lastReminderCheck = currentTime;

      const reminders = getReminders();

      reminders.forEach(reminder => {
        if (!reminder.enabled || reminder.time !== currentTime) return;

        // Check if this reminder should fire today
        let shouldFire = false;
        if (reminder.schedule === 'daily') {
          shouldFire = true;
        } else if (reminder.schedule.startsWith('weekly-')) {
          const reminderDay = parseInt(reminder.schedule.split('-')[1]);
          shouldFire = reminderDay === currentDay;
        }

        if (shouldFire) {
          sendChoreReminder(reminder);
        }
      });
    }

    function sendChoreReminder(reminder) {
      // Check if we already sent this reminder today
      const sentKey = `reminder_sent_${reminder.assignmentId}_${new Date().toISOString().split('T')[0]}`;
      if (localStorage.getItem(sentKey)) return;

      // Mark as sent
      localStorage.setItem(sentKey, 'true');

      // Send browser notification
      if ('Notification' in window && Notification.permission === 'granted') {
        new Notification(`${reminder.choreIcon} Time for: ${reminder.choreName}!`, {
          body: `Hey ${reminder.childName}, don't forget to complete your quest!`,
          icon: '/icons/icon-192.svg',
          tag: `chore-reminder-${reminder.assignmentId}`
        });
      }

      // Also show in-app toast if the app is open
      showToast(` Reminder: ${reminder.choreName}`);
    }

    // Start reminder checker (runs every 30 seconds)
    setInterval(checkReminders, 30000);

    // Request notification permission on load if not already granted
    function requestNotificationPermission() {
      if ('Notification' in window && Notification.permission === 'default') {
        // Don't auto-request, let user trigger it
      }
    }

    // ============================================
    // Money Makers System
    // ============================================
    // Money Makers - All functions now use database via bonusTasks array
    // Old localStorage functions removed - use parent portal Bonus tab to manage
    // ============================================

    function renderMoneyMakersList() {
      const list = document.getElementById('money-makers-list');
      const xpSymbol = getVocab('xp');
      const completedText = getVocab('completed');
      const today = new Date().toISOString().split('T')[0];

      // Use database-backed bonus tasks
      const makers = bonusTasks;

      // Build a map of TODAY's completion status per task
      const todayCompletionMap = {};
      bonusTaskCompletions.forEach(c => {
        const compDate = c.completion_date || (c.completed_at ? c.completed_at.split('T')[0] : '');
        if (compDate === today) {
          todayCompletionMap[c.bonus_task_id] = c.status || 'approved';
        }
      });

      // Weekly tally: count approved completions per task this week
      const weeklyCountMap = {};
      const weeklyEarningsMap = {};
      bonusTaskCompletions.forEach(c => {
        if ((c.status || 'approved') === 'approved') {
          weeklyCountMap[c.bonus_task_id] = (weeklyCountMap[c.bonus_task_id] || 0) + 1;
          weeklyEarningsMap[c.bonus_task_id] = (weeklyEarningsMap[c.bonus_task_id] || 0) + (parseFloat(c.amount_earned) || 0);
        }
      });

      if (makers.length === 0) {
        list.innerHTML = `<div class="empty-state" style="padding: 20px;"><div class="empty-icon"></div><div class="empty-text">No bonus tasks available right now.<br>Check back later!</div></div>`;
        return;
      }

      // Weekly totals summary
      const totalApproved = bonusTaskCompletions.filter(c => (c.status || 'approved') === 'approved').length;
      const totalEarned = bonusTaskCompletions.filter(c => (c.status || 'approved') === 'approved').reduce((sum, c) => sum + (parseFloat(c.amount_earned) || 0), 0);
      let summaryHtml = '';
      if (totalApproved > 0) {
        summaryHtml = `<div style="padding: 10px 14px; margin-bottom: 8px; background: rgba(34, 197, 94, 0.1); border: 1px solid rgba(34, 197, 94, 0.3); border-radius: 10px; font-size: 13px; color: #86efac; display: flex; justify-content: space-between; align-items: center;">
          <span>This week: ${totalApproved} completed</span>
          <span style="font-weight: 700; color: #4ade80;">${totalEarned > 0 ? '+$' + totalEarned.toFixed(2) : ''}</span>
        </div>`;
      }

      list.innerHTML = summaryHtml + makers.map(m => {
        const todayStatus = todayCompletionMap[m.id]; // 'pending', 'approved', or undefined
        const isDoneToday = todayStatus === 'approved';
        const isPending = todayStatus === 'pending';
        const weekCount = weeklyCountMap[m.id] || 0;
        const xpValue = m.xp_value || 10;
        const amount = m.amount || 0;
        const rewardText = amount > 0 ? `$${amount.toFixed(2)}` : `+${xpValue} ${xpSymbol}`;

        let icon = m.icon;
        let statusText = rewardText;
        let itemClass = '';
        if (isDoneToday) {
          icon = '';
          statusText = completedText + '!';
          itemClass = 'completed';
        } else if (isPending) {
          icon = '';
          statusText = 'Pending approval';
          itemClass = 'pending';
        }

        const weeklyBadge = weekCount > 0 ? `<span style="font-size: 11px; color: #94a3b8; margin-left: 4px;">(${weekCount}x this week)</span>` : '';

        return `
          <div class="money-maker-item ${itemClass}" onclick="completeMoneyMaker('${m.id}', ${xpValue}, ${amount})">
            <div class="money-maker-icon">${icon}</div>
            <div class="money-maker-info">
              <div class="money-maker-name">${m.name}${weeklyBadge}</div>
              <div class="money-maker-desc">${m.description || 'Complete for bonus!'}</div>
            </div>
            <div class="money-maker-xp" ${isPending ? 'style="color: #fbbf24;"' : ''}>${statusText}</div>
          </div>
        `;
      }).join('');
    }

    window.completeMoneyMaker = async function(id, xpValue, amount) {
      const today = new Date().toISOString().split('T')[0];

      // Check TODAY's completions only  each Money Maker can be done once per day
      const todayCompletion = bonusTaskCompletions.find(c => {
        const compDate = c.completion_date || (c.completed_at ? c.completed_at.split('T')[0] : '');
        return c.bonus_task_id === id && compDate === today;
      });

      if (todayCompletion) {
        if (todayCompletion.status === 'pending') {
          showToast('Already requested today  waiting for parent approval', 'error');
        } else {
          showToast('Already completed today! Try again tomorrow.', 'error');
        }
        return;
      }

      try {
        // Submit as pending request  parent must approve
        const completion = await requestBonusTask({
          taskId: id,
          childId: currentUser.id,
          weekStart: getWeekStart()
        });

        if (!completion) {
          showToast('Already requested today!', 'error');
          return;
        }

        // Add to local state
        bonusTaskCompletions.push(completion);

        showToast('Requested! Waiting for parent approval ');
        renderMoneyMakersList();
      } catch (e) {
        console.error('Error requesting money maker:', e);
        showToast('Failed to request', 'error');
      }
    };

    window.editReminder = function(assignmentId, choreName, childName, choreIcon, schedule) {
      document.getElementById('edit-reminder-assignment-id').value = assignmentId;
      document.getElementById('edit-reminder-chore-name').value = choreName;
      document.getElementById('edit-reminder-child-name').value = childName;
      document.getElementById('edit-reminder-chore-icon').value = choreIcon;
      document.getElementById('edit-reminder-schedule').value = schedule;
      document.getElementById('edit-reminder-desc').textContent = `${choreIcon} ${choreName} for ${childName}`;

      // Load existing reminder time if any
      const existing = getReminderForAssignment(assignmentId);
      document.getElementById('edit-reminder-time').value = existing?.time || '';

      showModal('edit-reminder-modal');

      // Request notification permission when opening reminder settings
      if ('Notification' in window && Notification.permission === 'default') {
        Notification.requestPermission();
      }
    };

    window.saveReminder = async function() {
      const assignmentId = document.getElementById('edit-reminder-assignment-id').value;
      const choreName = document.getElementById('edit-reminder-chore-name').value;
      const childName = document.getElementById('edit-reminder-child-name').value;
      const choreIcon = document.getElementById('edit-reminder-chore-icon').value;
      const schedule = document.getElementById('edit-reminder-schedule').value;
      const time = document.getElementById('edit-reminder-time').value;

      if (!time) {
        showToast('Select a time', 'error');
        return;
      }

      // Find child ID
      const child = children.find(c => c.name === childName);
      if (!child) {
        showToast('Child not found', 'error');
        return;
      }

      addReminder(assignmentId, child.id, childName, choreName, choreIcon, time, schedule);
      closeModal('edit-reminder-modal');
      await renderAssignments();
      showToast(`Reminder set for ${formatTime12Hour(time)}`);
    };

    window.clearReminder = async function() {
      const assignmentId = document.getElementById('edit-reminder-assignment-id').value;
      removeReminder(assignmentId);
      closeModal('edit-reminder-modal');
      await renderAssignments();
      showToast('Reminder removed');
    };

    // Initialize
    async function init() {
      try {
        const deviceRole = getDeviceRole();
        const cachedFamily = getCurrentFamily();
        const cachedUser = getCurrentUser();

        // If device has a role and family, load accordingly
        if (deviceRole && cachedFamily) {
          currentFamily = cachedFamily;

          if (deviceRole === 'parent') {
            // Parent device - go straight to portal
            try {
              await loadAppData();
            } catch (e) {
              console.error('Parent loadAppData error (using cached):', e);
            }
            try {
              await showParentPortalDirect();
            } catch (e) {
              console.error('showParentPortalDirect error:', e);
              // Still show the portal even if some data failed to load
              document.getElementById('loading-state').style.display = 'none';
              document.getElementById('setup-wizard').style.display = 'none';
              document.getElementById('main-app').style.display = 'none';
              document.getElementById('parent-portal').style.display = 'block';
              document.getElementById('family-name-display').textContent = currentFamily?.name || 'Family Dashboard';
            }
            return;
          } else if (deviceRole === 'child') {
            // Child device - try to load fresh user data, fall back to cached
            let user = null;
            try {
              const deviceId = getDeviceId();
              user = await getUserByDeviceId(deviceId);
            } catch (e) {
              console.error('getUserByDeviceId error (using cached):', e);
            }

            // If device ID lookup failed but we have a cached user ID, try fetching by ID
            if (!user && cachedUser?.id) {
              try {
                user = await getUserById(cachedUser.id);
                if (user) {
                  // Re-link device to this child so future lookups work
                  await linkDeviceToChild(user.id);
                  console.log('Re-linked device to child:', user.name);
                }
              } catch (e) {
                console.error('getUserById fallback error:', e);
              }
            }

            if (user) {
              currentUser = user;
              currentFamily = user.families || cachedFamily;
              setCurrentUser(user);
              setCurrentFamily(currentFamily);
            } else if (cachedUser) {
              // Network failed but we have cached user data - use it
              currentUser = cachedUser;
              console.log('Using cached user data');
            }

            if (currentUser) {
              try {
                await loadAppData();
              } catch (e) {
                console.error('Child loadAppData error (using cached):', e);
              }
              showMainApp();
              return;
            }
          }
        }

        // Fallback: check for existing user by device ID
        const deviceId = getDeviceId();
        let user = null;
        try {
          user = await getUserByDeviceId(deviceId);
        } catch (e) {
          console.error('Fallback getUserByDeviceId error:', e);
        }

        // If device ID lookup failed, try by cached user ID
        if (!user && cachedUser?.id) {
          try {
            user = await getUserById(cachedUser.id);
            if (user) {
              await linkDeviceToChild(user.id);
              console.log('Fallback: re-linked device to child:', user.name);
            }
          } catch (e) {
            console.error('Fallback getUserById error:', e);
          }
        }

        if (user) {
          currentUser = user;
          currentFamily = user.families;
          setCurrentUser(user);
          setCurrentFamily(user.families);
          setDeviceRole('child'); // This device is linked to a child
          await loadAppData();
          showMainApp();
        } else if (cachedFamily && cachedUser) {
          // We have cached data but couldn't reach the server
          currentUser = cachedUser;
          currentFamily = cachedFamily;
          setDeviceRole('child');
          try {
            await loadAppData();
          } catch (e) {
            console.error('Cached fallback loadAppData error:', e);
          }
          showMainApp();
        } else {
          showSetup();
        }
      } catch (error) {
        console.error('Init error:', error);
        // Only show setup if we truly have NO cached data
        const cachedFamily = getCurrentFamily();
        const cachedUser = getCurrentUser();
        const deviceRole = getDeviceRole();
        if (deviceRole && cachedFamily) {
          // We have cached session data - don't wipe it, try to recover
          currentFamily = cachedFamily;
          if (deviceRole === 'parent') {
            document.getElementById('loading-state').style.display = 'none';
            document.getElementById('setup-wizard').style.display = 'none';
            document.getElementById('parent-portal').style.display = 'block';
            document.getElementById('family-name-display').textContent = currentFamily?.name || 'Family Dashboard';
          } else if (cachedUser) {
            currentUser = cachedUser;
            showMainApp();
          } else {
            showSetup();
          }
        } else {
          showSetup();
        }
      }
    }

    // Show parent portal directly (for parent devices)
    async function showParentPortalDirect() {
      document.getElementById('loading-state').style.display = 'none';
      document.getElementById('setup-wizard').style.display = 'none';
      document.getElementById('main-app').style.display = 'none';
      document.getElementById('parent-portal').style.display = 'block';
      document.getElementById('family-name-display').textContent = currentFamily?.name || 'Family Dashboard';
      try {
        await loadSettingsData();
      } catch (e) {
        console.error('loadSettingsData error:', e);
      }
      renderPortalChildSelector();
      if (children.length > 0 && !selectedPortalChildId) {
        selectedPortalChildId = children[0].id;
      }
      try {
        await renderPortalOverview();
      } catch (e) {
        console.error('renderPortalOverview error:', e);
      }
      setupRealtimeNotifications();
    }

    async function loadAppData() {
      if (!currentFamily) return;
      try {
        children = await getChildren(currentFamily.id);
        choreTemplates = await getChoreTemplates(currentFamily.id);
        if (currentUser) {
          assignments = await getChildAssignments(currentUser.id);
          // Load full week's completions instead of just today
          completions = await getWeeklyCompletions(currentUser.id, getWeekStart());
          // Load reminders for sort order
          try {
            userReminders = await getChildReminders(currentUser.id);
          } catch (e) {
            userReminders = [];
          }
        }
        achievements = await getAchievements(currentFamily.id);
        privileges = await getPrivileges(currentFamily.id);
        // Load bonus tasks (Money Makers) from database
        try {
          bonusTasks = await getBonusTasksFromDB(currentFamily.id);
        } catch (e) {
          console.log('Bonus tasks table may not exist yet:', e);
          bonusTasks = [];
        }
        // Load nightly zones from database
        await loadNightlyZonesFromDB();

        if (currentUser) {
          achievementUnlocks = await getChildAchievementUnlocks(currentUser.id);
          privilegeUnlocks = await getChildPrivilegeUnlocks(currentUser.id);
          // Load bonus task completions for this week
          try {
            bonusTaskCompletions = await getBonusTaskCompletions(currentUser.id, getWeekStart());
          } catch (e) {
            console.log('Bonus task completions table may not exist yet:', e);
            bonusTaskCompletions = [];
          }
          // Load nightly completions for this week
          await loadNightlyCompletionsFromDB();
        }
        const members = await getFamilyMembers(currentFamily.id);
        const parent = members.find(m => m.type === 'parent');
        if (parent) parentPinHash = parent.pin_hash;

        // Check for any pending achievements on load
        if (currentUser) {
          setTimeout(() => checkAndUnlockAchievements(), 2000);
        }
      } catch (error) {
        console.error('Load data error:', error);
      }
    }

    function showLoading() {
      document.getElementById('loading-state').style.display = 'block';
      document.getElementById('setup-wizard').style.display = 'none';
      document.getElementById('main-app').style.display = 'none';
    }

    function showSetup() {
      document.getElementById('loading-state').style.display = 'none';
      document.getElementById('setup-wizard').style.display = 'block';
      document.getElementById('main-app').style.display = 'none';
      renderAvatarGrid();
    }

    function showMainApp() {
      document.getElementById('loading-state').style.display = 'none';
      document.getElementById('setup-wizard').style.display = 'none';
      document.getElementById('main-app').style.display = 'block';
      renderApp();

      // Check for weekly reset after a short delay to let UI settle
      setTimeout(() => {
        if (shouldShowWeeklyReset()) {
          performWeeklyReset();
          showWeeklyWelcome();
        }
      }, 500);

      // Start polling for bonus task approval changes (child side)
      startBonusApprovalPoll();
    }

    let bonusApprovalPollInterval = null;
    function startBonusApprovalPoll() {
      if (bonusApprovalPollInterval) clearInterval(bonusApprovalPollInterval);
      bonusApprovalPollInterval = setInterval(checkBonusApprovals, 15000);
    }

    async function checkBonusApprovals() {
      if (!currentUser || !currentFamily) return;
      try {
        const freshCompletions = await getBonusTaskCompletions(currentUser.id, getWeekStart());

        for (const fresh of freshCompletions) {
          const existing = bonusTaskCompletions.find(c => c.id === fresh.id);
          // Detect pending  approved transition
          if (existing && (existing.status === 'pending') && (fresh.status === 'approved')) {
            const taskName = fresh.bonus_tasks?.name || 'a bonus task';
            const amount = parseFloat(fresh.amount_earned) || 0;
            const xp = fresh.xp_earned || 0;
            const rewardMsg = amount > 0 ? ` +$${amount.toFixed(2)} & +${xp} XP!` : ` +${xp} XP Bonus!`;
            showToast(`${taskName} approved! ${rewardMsg}`);
          }
          // Detect denied (existing was pending, now gone from fresh list)
        }

        // Check for denied items (were pending locally but no longer in DB)
        for (const existing of bonusTaskCompletions) {
          if (existing.status === 'pending') {
            const stillExists = freshCompletions.find(c => c.id === existing.id);
            if (!stillExists) {
              const taskName = existing.bonus_tasks?.name || 'a bonus task';
              showToast(`${taskName} request was denied`, 'error');
            }
          }
        }

        // Update local state
        bonusTaskCompletions = freshCompletions;
        renderMoneyMakersList();
        updateStats();
      } catch (e) {
        console.log('Error polling bonus approvals:', e);
      }
    }

    // Setup functions
    window.goToStep = function(step) {
      document.querySelectorAll('.setup-step').forEach(el => el.classList.remove('active'));
      document.querySelector(`.setup-step[data-step="${step}"]`)?.classList.add('active');
    };

    window.choosePath = function(path) {
      if (path === 'new') goToStep('create');
      else if (path === 'login') goToStep('login');
      else goToStep('join');
    };

    window.createNewFamily = async function() {
      const name = document.getElementById('setup-family-name').value.trim();
      const pin = document.getElementById('setup-parent-pin').value.trim();
      if (!name) { showToast('Enter family name', 'error'); return; }
      if (!pin || pin.length !== 4) { showToast('Enter 4-digit PIN', 'error'); return; }

      try {
        currentFamily = await createFamily(name);
        setCurrentFamily(currentFamily);
        setDeviceRole('parent'); // Mark this device as parent device
        await createUser({ familyId: currentFamily.id, type: 'parent', name: 'Parent', pinHash: pin });
        parentPinHash = pin;
        goToStep('add-child');
      } catch (error) {
        console.error('Create family error:', error);
        showToast('Failed to create family', 'error');
      }
    };

    window.joinWithCode = async function() {
      const code = document.getElementById('setup-link-code').value.trim();
      if (!code || code.length !== 6) { showToast('Enter 6-digit code', 'error'); return; }

      try {
        const family = await findFamilyByLinkCode(code);
        if (!family) { showToast('Invalid or expired code', 'error'); return; }

        currentFamily = family;
        setCurrentFamily(family);
        children = await getChildren(family.id);

        if (children.length === 0) {
          showToast('No children in family yet', 'error');
          return;
        }

        document.getElementById('child-select-list').innerHTML = children.map(c => `
          <div class="item-card" style="cursor: pointer;" onclick="selectChild('${c.id}')">
            <div class="item-icon">${c.avatar || ''}</div>
            <div class="item-info"><div class="item-name">${c.name}</div></div>
          </div>
        `).join('');
        goToStep('select-child');
      } catch (error) {
        console.error('Join error:', error);
        showToast('Failed to join family', 'error');
      }
    };

    window.loginWithPin = async function() {
      const familyName = document.getElementById('setup-login-family').value.trim();
      const pin = document.getElementById('setup-login-pin').value.trim();
      if (!familyName) { showToast('Enter family name', 'error'); return; }
      if (!pin || pin.length !== 4) { showToast('Enter 4-digit PIN', 'error'); return; }

      try {
        const family = await loginParentWithPin(familyName, pin);
        if (!family) {
          showToast('Family not found or incorrect PIN', 'error');
          return;
        }
        currentFamily = family;
        setCurrentFamily(family);
        setDeviceRole('parent');
        parentPinHash = pin;
        children = await getChildren(family.id);
        await showParentPortalDirect();
        showToast('Welcome back!');
      } catch (error) {
        console.error('Login error:', error);
        showToast('Login failed. Please try again.', 'error');
      }
    };

    window.selectChild = async function(childId) {
      try {
        currentUser = await linkDeviceToChild(childId);
        setCurrentUser(currentUser);
        setDeviceRole('child'); // Mark this device as child device
        await loadAppData();
        showMainApp();
      } catch (error) {
        console.error('Select child error:', error);
        showToast('Failed to link device', 'error');
      }
    };

    window.addFirstChild = async function() {
      const name = document.getElementById('setup-child-name').value.trim();
      if (!name) { showToast('Enter child name', 'error'); return; }

      try {
        const child = await createUser({
          familyId: currentFamily.id,
          type: 'child',
          name,
          avatar: selectedAvatar
        });
        // Don't set as current user yet - parent is still setting up
        await loadAppData();
        // Take parent to portal to finish setup
        goToStep('parent-setup-complete');
      } catch (error) {
        console.error('Add child error:', error);
        showToast('Failed to add child', 'error');
      }
    };

    function renderAvatarGrid() {
      const grid = document.getElementById('avatar-grid');
      if (!grid) return;
      grid.innerHTML = AVATARS.map(a => `
        <button type="button" class="avatar-btn ${a === selectedAvatar ? 'selected' : ''}" onclick="selectAvatar('${a}')">${a}</button>
      `).join('');
    }

    window.selectAvatar = function(avatar) {
      selectedAvatar = avatar;
      renderAvatarGrid();
    };

    window.enterParentPortalFromSetup = async function() {
      document.getElementById('setup-wizard').style.display = 'none';
      document.getElementById('parent-portal').style.display = 'block';
      document.getElementById('family-name-display').textContent = currentFamily?.name || 'Family Dashboard';
      await loadSettingsData();
      renderPortalChildSelector();
      if (children.length > 0 && !selectedPortalChildId) {
        selectedPortalChildId = children[0].id;
      }
      await renderPortalOverview();
      setupRealtimeNotifications();
      showToast('Welcome! Start by adding chores.');
    };

    // Main app rendering
    function renderApp() {
      if (currentUser) {
        document.getElementById('app-title').textContent = `${currentUser.name.toUpperCase()}'S MISSIONS`;
      }
      renderDayTabs();
      renderQuests();
      renderNightly();
      updateStats();
      renderPayScale();
      renderAchievements();
      renderMoneyMakersList();
      initPinInputs();
      checkNotificationStatus();
      checkInAppReminders();
    }

    // Check and update notification UI state
    async function checkNotificationStatus() {
      const banner = document.getElementById('notification-banner');
      const toggleBtn = document.getElementById('notification-toggle-btn');

      if (!banner || !toggleBtn) return;

      if (!isPushSupported()) {
        // Push not supported on this device
        banner.style.display = 'none';
        toggleBtn.style.display = 'none';
        return;
      }

      const subscription = await getPushSubscription();

      if (subscription) {
        // Notifications enabled
        banner.style.display = 'none';
        toggleBtn.textContent = '';
        toggleBtn.title = 'Notifications enabled';
      } else {
        // Notifications not enabled - show banner
        banner.style.display = 'block';
        toggleBtn.textContent = '';
        toggleBtn.title = 'Enable notifications';
      }
    }

    // Enable notifications
    window.enableNotifications = async function() {
      if (!currentUser) {
        showToast('Please link device first', 'error');
        return;
      }

      try {
        await subscribeToPush(currentUser.id);
        showToast(' Reminders enabled!');
        await checkNotificationStatus();
      } catch (e) {
        console.error('Error enabling notifications:', e);
        if (e.message === 'Notification permission denied') {
          showToast('Permission denied. Enable in browser settings.', 'error');
        } else {
          showToast('Could not enable notifications', 'error');
        }
      }
    };

    // Toggle notifications on/off
    window.toggleNotifications = async function() {
      if (!currentUser) {
        showToast('Please link device first', 'error');
        return;
      }

      const subscription = await getPushSubscription();

      if (subscription) {
        // Currently enabled - disable
        if (confirm('Disable reminders on this device?')) {
          try {
            await unsubscribeFromPush(currentUser.id);
            showToast('Reminders disabled');
            await checkNotificationStatus();
          } catch (e) {
            console.error('Error disabling notifications:', e);
            showToast('Error disabling notifications', 'error');
          }
        }
      } else {
        // Currently disabled - enable
        await enableNotifications();
      }
    };

    // Check for in-app reminders when app opens
    async function checkInAppReminders() {
      if (!currentUser) return;

      try {
        const reminders = await getChildReminders(currentUser.id);
        if (!reminders || reminders.length === 0) return;

        const now = new Date();
        const currentMinutes = now.getHours() * 60 + now.getMinutes();

        for (const reminder of reminders) {
          if (!reminder.reminder_time) continue;

          // Parse reminder time
          const [hours, mins] = reminder.reminder_time.split(':').map(Number);
          const reminderMinutes = hours * 60 + mins;

          // Check if within 30 minute window (before or after)
          const diff = Math.abs(currentMinutes - reminderMinutes);
          if (diff <= 30 || diff >= (24 * 60 - 30)) {
            // Check if we already showed this reminder today
            const today = now.toDateString();
            const shownKey = `reminder_shown_${reminder.id}_${today}`;
            if (localStorage.getItem(shownKey)) continue;

            // Show the reminder
            const title = reminder.reminder_type === 'nightly' ? ' Bedtime Reminder' : ' Reminder';
            document.getElementById('reminder-popup-title').textContent = title;
            document.getElementById('reminder-popup-message').textContent = reminder.message || 'Time to check your tasks!';
            showModal('reminder-popup-modal');

            // Mark as shown for today
            localStorage.setItem(shownKey, 'true');
            break; // Only show one reminder at a time
          }
        }
      } catch (e) {
        console.error('Error checking reminders:', e);
      }
    }

    window.dismissReminder = function() {
      closeModal('reminder-popup-modal');
    };

    function renderDayTabs() {
      const container = document.getElementById('day-tabs');
      container.innerHTML = DAY_NAMES.map((name, i) => `
        <button class="day-tab ${i >= 5 || i === 0 ? 'weekend' : ''} ${i === currentDay ? 'active' : ''}" onclick="selectDay(${i})">${name}</button>
      `).join('');
    }

    window.selectDay = function(day) {
      currentDay = day;
      renderDayTabs();
      renderQuests();
      renderNightly();
    };

    function getDateForDay(dayOfWeek) {
      // Get the date for a specific day of the current week
      const weekStart = new Date(getWeekStart());
      const date = new Date(weekStart);
      date.setDate(weekStart.getDate() + dayOfWeek);
      return date.toISOString().split('T')[0];
    }

    function renderQuests() {
      const container = document.getElementById('quests-list');
      const selectedDate = getDateForDay(currentDay);

      const todayAssignments = assignments.filter(a => {
        if (!a.chore_templates?.is_active) return false;
        if (a.recurrence_type === 'daily') return true;
        if (a.recurrence_type === 'weekly' && a.day_of_week === currentDay) return true;
        return false;
      });

      // Sort by reminder time (earliest first, no-reminder last)
      todayAssignments.sort((a, b) => {
        const getName = (x) => x.chore_templates?.name || '';
        const getTime = (x) => {
          const r = userReminders.find(r =>
            r.message && r.message.startsWith('Time to do:') && r.message.includes(getName(x))
          );
          return r ? r.reminder_time : null;
        };
        const tA = getTime(a);
        const tB = getTime(b);
        if (tA && tB) return tA.localeCompare(tB);
        if (tA) return -1;
        if (tB) return 1;
        return 0;
      });

      if (todayAssignments.length === 0) {
        container.innerHTML = `<div class="empty-state"><div class="empty-icon"></div><div class="empty-text">No quests for this day.<br>Parents: tap  to add chores!</div></div>`;
        document.getElementById('xp-badge').textContent = '+0 XP';
        return;
      }

      const totalXP = todayAssignments.reduce((sum, a) => sum + (a.chore_templates?.xp_value || 0), 0);
      const xpSymbol = getVocab('xp');
      document.getElementById('xp-badge').textContent = `+${totalXP} ${xpSymbol}`;

      container.innerHTML = todayAssignments.map(a => {
        const chore = a.chore_templates;
        // Check if this assignment was completed on the selected day
        const done = completions.some(c => c.assignment_id === a.id && c.completion_date === selectedDate);
        const hasExpectations = chore.description && chore.description.trim();
        return `
          <div class="quest-item ${done ? 'completed' : ''}" onclick="toggleQuest('${a.id}', ${chore.xp_value})">
            <div class="quest-icon">${done ? '' : chore.icon}</div>
            <div class="quest-info">
              <div class="quest-name">${chore.name}</div>
            </div>
            <div class="quest-help-slot">
              ${hasExpectations ? `
                <button class="quest-help-btn" onclick="event.stopPropagation(); showExpectations('${chore.name.replace(/'/g, "\\'")}', '${chore.description.replace(/'/g, "\\'").replace(/\n/g, '\\n')}')">?</button>
              ` : ''}
            </div>
            <div class="quest-xp">+${chore.xp_value} ${xpSymbol}</div>
          </div>
        `;
      }).join('');
    }

    window.showExpectations = function(name, expectations) {
      document.getElementById('expectations-chore-name').textContent = name;
      document.getElementById('expectations-content').textContent = expectations.replace(/\\n/g, '\n');
      showModal('expectations-modal');
    };

    // Quest completion confirmation modal
    let questConfirmResolver = null;

    window.resolveQuestConfirm = function(result) {
      closeModal('quest-confirm-modal');
      if (questConfirmResolver) {
        questConfirmResolver(result);
        questConfirmResolver = null;
      }
    };

    function showQuestConfirm(choreName, choreIcon, xpValue) {
      document.getElementById('quest-confirm-icon').textContent = choreIcon || '';
      document.getElementById('quest-confirm-name').textContent = choreName;
      document.getElementById('quest-confirm-xp').textContent = `+${xpValue} ${getVocab('xp')}`;
      showModal('quest-confirm-modal');
      return new Promise(resolve => { questConfirmResolver = resolve; });
    }

    window.toggleQuest = async function(assignmentId, xpValue) {
      const actualToday = new Date().getDay();
      const selectedDate = getDateForDay(currentDay);
      const todayDate = new Date().toISOString().split('T')[0];

      // Check if already completed for this day
      if (completions.some(c => c.assignment_id === assignmentId && c.completion_date === selectedDate)) {
        return;
      }

      // Only allow completing chores for the actual current day
      if (currentDay !== actualToday) {
        showToast('Can only complete today\'s quests!', 'error');
        return;
      }

      // Find the chore for the confirmation
      const assignment = assignments.find(a => a.id === assignmentId);
      const choreName = assignment?.chore_templates?.name || 'this quest';
      const choreIcon = assignment?.chore_templates?.icon || '';

      // Show themed confirmation modal
      const confirmed = await showQuestConfirm(choreName, choreIcon, xpValue);
      if (!confirmed) return;

      try {
        const result = await completeChore({
          assignmentId,
          childId: currentUser.id,
          xpEarned: xpValue
        });
        if (result) {
          completions.push(result);
          showToast(`+${xpValue} ${getVocab('xp')}!`);
          renderQuests();
          updateStats();

          // Check for achievement unlocks
          setTimeout(() => checkAndUnlockAchievements(), 1000);
        }
      } catch (error) {
        console.error('Complete error:', error);
      }
    };

    function renderNightly() {
      const container = document.getElementById('nightly-grid');
      const nightlyKey = `nightly_${currentUser?.id}_${getWeekStart()}_${currentDay}`;
      const localState = JSON.parse(localStorage.getItem(nightlyKey) || '{}');
      const zones = getNightlyZones();

      container.innerHTML = zones.map(z => {
        // Check database first, fall back to localStorage
        let isCompleted = false;
        if (z.id) {
          isCompleted = nightlyCompletionsDB.some(c =>
            c.zone_id === z.id && c.day_of_week === currentDay
          );
        } else {
          isCompleted = !!localState[z.key];
        }

        return `
          <div class="nightly-item ${isCompleted ? 'completed' : ''}" onclick="toggleNightly('${z.key}')">
            <div class="nightly-icon">${isCompleted ? '' : z.icon}</div>
            <div class="nightly-label">${z.label || z.name}</div>
          </div>
        `;
      }).join('');
    }

    window.toggleNightly = async function(zoneKey) {
      // Only allow completing nightly for the actual current day
      const actualToday = new Date().getDay();
      if (currentDay !== actualToday) {
        showToast('Can only complete today\'s patrol!', 'error');
        return;
      }

      const zones = getNightlyZones();
      const zone = zones.find(z => z.key === zoneKey);

      // Check if already completed (using database if available, localStorage as fallback)
      let isCompleted = false;
      if (zone?.id && nightlyCompletionsDB.length > 0) {
        isCompleted = nightlyCompletionsDB.some(c =>
          c.zone_id === zone.id && c.day_of_week === currentDay
        );
      } else {
        // Fallback to localStorage for zones not in database
        const nightlyKey = `nightly_${currentUser?.id}_${getWeekStart()}_${currentDay}`;
        const state = JSON.parse(localStorage.getItem(nightlyKey) || '{}');
        isCompleted = !!state[zoneKey];
      }

      if (!isCompleted) {
        try {
          // Save to database if zone has ID
          if (zone?.id) {
            await completeNightlyZone({
              childId: currentUser.id,
              zoneId: zone.id,
              weekStart: getWeekStart(),
              dayOfWeek: currentDay
            });
            await loadNightlyCompletionsFromDB();
          } else {
            // Fallback to localStorage for default zones not in database
            const nightlyKey = `nightly_${currentUser?.id}_${getWeekStart()}_${currentDay}`;
            const state = JSON.parse(localStorage.getItem(nightlyKey) || '{}');
            state[zoneKey] = true;
            localStorage.setItem(nightlyKey, JSON.stringify(state));
          }

          await updateUserXP(currentUser.id, 5);
          showToast(`+5 ${getVocab('xp')}!`);

          // Check if all zones complete
          const allComplete = zones.every(z => {
            if (z.id && nightlyCompletionsDB.length > 0) {
              return nightlyCompletionsDB.some(c => c.zone_id === z.id && c.day_of_week === currentDay);
            }
            const key = `nightly_${currentUser?.id}_${getWeekStart()}_${currentDay}`;
            const s = JSON.parse(localStorage.getItem(key) || '{}');
            return !!s[z.key];
          });
          if (allComplete) {
            setTimeout(() => showToast(` ${getVocab('completed')}!`), 800);
            // Check for streak achievements
            setTimeout(() => checkAndUnlockAchievements(), 1500);
          }
        } catch (e) { console.error(e); }
      }
      renderNightly();
      updateStats();
    };

    function getWeekStart() {
      const d = new Date();
      d.setDate(d.getDate() - d.getDay());
      return d.toISOString().split('T')[0];
    }

    function getNightlyStreak() {
      let streak = 0;
      const ws = getWeekStart();
      const zones = getNightlyZones();
      for (let i = 0; i < 7; i++) {
        // Check database first, fall back to localStorage
        const allComplete = zones.every(z => {
          if (z.id) {
            return nightlyCompletionsDB.some(c =>
              c.zone_id === z.id && c.day_of_week === i
            );
          }
          // Fallback to localStorage
          const key = `nightly_${currentUser?.id}_${ws}_${i}`;
          const s = JSON.parse(localStorage.getItem(key) || '{}');
          return !!s[z.key];
        });
        if (allComplete) streak++;
      }
      return streak;
    }

    // Achievement checking and unlocking
    async function checkAndUnlockAchievements() {
      if (!currentUser || !currentFamily || !achievements.length) return;

      let anyUnlocked = false;

      try {
        // Get current stats
        const members = await getFamilyMembers(currentFamily.id);
        const user = members.find(m => m.id === currentUser.id);
        if (!user) return;

        const totalXP = user.current_xp || 0;
        const totalCompletions = completions.length; // This week's completions
        const nightlyStreak = getNightlyStreak();
        const weeklyCompletions = await getWeeklyCompletions(currentUser.id, getWeekStart());
        const weeklyXP = weeklyCompletions.reduce((sum, c) => sum + (c.xp_earned || 0), 0);
        const currentRank = PAY_SCALE.find(r => weeklyXP >= r.minXP && weeklyXP <= r.maxXP) || PAY_SCALE[0];

        // Get all-time completion count (estimate from total XP if not tracked separately)
        // For now, use weekly completions count - in production you'd track lifetime completions
        const lifetimeCompletions = weeklyCompletions.length;

        // Already unlocked achievement IDs
        const unlockedIds = new Set(achievementUnlocks.map(u => u.achievement_id));

        for (const achievement of achievements) {
          // Skip if already unlocked
          if (unlockedIds.has(achievement.id)) continue;

          let shouldUnlock = false;
          const criteria = achievement.criteria_value || {};

          switch (achievement.criteria_type) {
            case 'xp_threshold':
              // Check if total XP meets threshold
              const xpThreshold = criteria.xp || criteria.threshold || 0;
              if (totalXP >= xpThreshold) shouldUnlock = true;
              break;

            case 'streak':
              // Check nightly patrol streak
              const streakRequired = criteria.days || criteria.streak || 0;
              if (nightlyStreak >= streakRequired) shouldUnlock = true;
              break;

            case 'completion_count':
              // Check total completions
              const countRequired = criteria.count || 0;
              if (lifetimeCompletions >= countRequired) shouldUnlock = true;
              break;

            case 'custom':
              // Handle custom achievement types
              const customType = criteria.type;

              if (customType === 'first_quest' || achievement.name === 'First Quest') {
                // First chore completion
                if (weeklyCompletions.length >= 1) shouldUnlock = true;
              }
              else if (customType === 'getting_started' || achievement.name === 'Getting Started') {
                // Started using the app (has at least one completion)
                if (weeklyCompletions.length >= 1) shouldUnlock = true;
              }
              else if (customType === 'nightly_streak') {
                const daysRequired = criteria.days || 7;
                if (nightlyStreak >= daysRequired) shouldUnlock = true;
              }
              else if (customType === 'reach_rank') {
                const rankRequired = criteria.rank;
                if (currentRank.name === rankRequired) shouldUnlock = true;
              }
              else if (customType === 'perfect_week') {
                // Check if all assigned chores were completed this week
                const totalAssigned = assignments.length * 7; // Rough estimate
                if (weeklyCompletions.length >= totalAssigned && totalAssigned > 0) shouldUnlock = true;
              }
              break;
          }

          // Unlock the achievement if criteria met
          if (shouldUnlock) {
            try {
              const unlock = await unlockAchievement(currentUser.id, achievement.id);
              if (unlock) {
                anyUnlocked = true;
                // Add to local state
                achievementUnlocks.push(unlock);

                // Show celebration
                showToast(` Achievement Unlocked: ${achievement.name}!`);

                // Show achievement modal
                setTimeout(() => {
                  showAchievementUnlockedModal(achievement);
                }, 500);
              }
            } catch (e) {
              console.log('Achievement already unlocked or error:', e);
            }
          }
        }

        // Refresh wallet/payday if anything changed
        if (anyUnlocked) {
          await updateStats();
          renderQuests();
        }
      } catch (e) {
        console.error('Error checking achievements:', e);
      }
    }

    function showAchievementUnlockedModal(achievement) {
      document.getElementById('unlocked-achievement-icon').textContent = achievement.icon || '';
      document.getElementById('unlocked-achievement-name').textContent = achievement.name;
      document.getElementById('unlocked-achievement-desc').textContent = achievement.description || '';
      const rewardEl = document.getElementById('unlocked-achievement-reward');
      if (achievement.reward_amount && parseFloat(achievement.reward_amount) > 0) {
        rewardEl.textContent = `+$${parseFloat(achievement.reward_amount).toFixed(2)} reward!`;
        rewardEl.style.display = 'block';
      } else {
        rewardEl.style.display = 'none';
      }
      showModal('achievement-unlocked-modal');
    }

    async function updateStats() {
      if (!currentUser || !currentFamily) return;

      try {
        const members = await getFamilyMembers(currentFamily.id);
        const user = members.find(m => m.id === currentUser.id);
        if (!user) return;

        // Total XP is cumulative (for Level display)
        const totalXP = user.current_xp || 0;
        const level = Math.floor(totalXP / 100) + 1;
        const progress = totalXP % 100;

        // Weekly XP is from this week's completions (for Rank and Pay)
        const weeklyCompletions = await getWeeklyCompletions(currentUser.id, getWeekStart());
        const weeklyXP = weeklyCompletions.reduce((sum, c) => sum + (c.xp_earned || 0), 0);
        const rank = PAY_SCALE.find(r => weeklyXP >= r.minXP && weeklyXP <= r.maxXP) || PAY_SCALE[0];

        // Level uses total XP
        document.getElementById('level').textContent = level;
        document.getElementById('xp').textContent = totalXP;
        document.getElementById('progress').style.width = progress + '%';
        document.getElementById('progress-text').textContent = `${progress}/100 to next level`;

        // Rank uses weekly XP
        document.getElementById('rank').textContent = rank.name;
        document.getElementById('rank').style.color = rank.color;

        const rankCard = document.getElementById('rank-card');
        rankCard.style.background = `linear-gradient(135deg, ${rank.color}22 0%, ${rank.color}11 100%)`;
        rankCard.style.border = `1px solid ${rank.color}44`;

        // Wallet - uses weekly XP for rank/pay + bonus earnings
        const streak = getNightlyStreak();
        const multiplier = streak === 7 ? 1.5 : 1;
        const basePay = rank.pay * multiplier;

        // Add bonus task earnings for this week (only approved ones)
        const bonusEarnings = bonusTaskCompletions
          .filter(c => (c.status || 'approved') === 'approved')
          .reduce((sum, c) => sum + (parseFloat(c.amount_earned) || 0), 0);

        // Add claimed achievement rewards (if any this week - optional enhancement)
        const total = basePay + bonusEarnings;

        document.getElementById('wallet-amount').textContent = `$${total.toFixed(2)}`;
        document.getElementById('wallet-rank').textContent = rank.name;
        document.getElementById('wallet-base').textContent = `$${rank.pay.toFixed(2)}`;
        document.getElementById('wallet-streak').textContent = multiplier > 1 ? `${multiplier}` : '';

        // Show bonus earnings in wallet if any
        const walletBonusLine = document.getElementById('wallet-bonus-line');
        if (walletBonusLine) {
          if (bonusEarnings > 0) {
            walletBonusLine.style.display = 'flex';
            document.getElementById('wallet-bonus').textContent = `+$${bonusEarnings.toFixed(2)}`;
          } else {
            walletBonusLine.style.display = 'none';
          }
        }
        document.getElementById('streak-count').textContent = `${streak}/7`;
        document.getElementById('lifetime-xp').textContent = totalXP;
        document.getElementById('lifetime-streak').textContent = `${user.current_streak || 0} days`;

        // Streak days
        const streakDays = document.getElementById('streak-days');
        const ws = getWeekStart();
        const zones = getNightlyZones();
        streakDays.innerHTML = '';
        for (let i = 0; i < 7; i++) {
          // Check database first, fall back to localStorage
          const complete = zones.every(z => {
            if (z.id) {
              return nightlyCompletionsDB.some(c =>
                c.zone_id === z.id && c.day_of_week === i
              );
            }
            const key = `nightly_${currentUser?.id}_${ws}_${i}`;
            const s = JSON.parse(localStorage.getItem(key) || '{}');
            return !!s[z.key];
          });
          streakDays.innerHTML += `<div class="streak-day ${complete ? 'complete' : ''}">${complete ? '' : ''}</div>`;
        }

        // Payday - includes base pay + bonus earnings
        document.getElementById('payday-amount').textContent = `$${total.toFixed(2)}`;
        document.getElementById('payday-rank').textContent = rank.name;
        document.getElementById('payday-base').textContent = `$${rank.pay.toFixed(2)}`;
        document.getElementById('payday-multiplier').textContent = multiplier > 1 ? `${multiplier}` : '1';
        document.getElementById('payday-total').textContent = `$${total.toFixed(2)}`;

        // Show bonus earnings breakdown if any
        const bonusLine = document.getElementById('payday-bonus-line');
        if (bonusLine) {
          if (bonusEarnings > 0) {
            bonusLine.style.display = 'flex';
            document.getElementById('payday-bonus-amount').textContent = `$${bonusEarnings.toFixed(2)}`;
          } else {
            bonusLine.style.display = 'none';
          }
        }
      } catch (e) { console.error('Update stats error:', e); }
    }

    function renderPayScale() {
      const xp = parseInt(document.getElementById('xp')?.textContent) || 0;
      document.getElementById('pay-tiers').innerHTML = PAY_SCALE.map(t => `
        <div class="pay-tier ${xp >= t.minXP && xp <= t.maxXP ? 'current' : ''}">
          <div>
            <span class="pay-tier-name" style="color: ${t.color}">${t.name}</span>
            <span class="pay-tier-range">${t.minXP}-${t.maxXP === 9999 ? '' : t.maxXP} XP</span>
          </div>
          <span class="pay-tier-amount">$${t.pay}</span>
        </div>
      `).join('');
    }

    function renderAchievements() {
      const grid = document.getElementById('achievements-grid');
      if (achievements.length === 0) {
        grid.innerHTML = `<div class="empty-state"><div class="empty-icon"></div><div class="empty-text">No achievements yet</div></div>`;
        document.getElementById('achievement-count').textContent = '0/0';
        updateTrophySummary();
        return;
      }

      // Calculate stats
      const unlockedIds = achievementUnlocks.map(u => u.achievement_id);
      const claimedUnlocks = achievementUnlocks.filter(u => u.reward_paid);
      const unclaimedUnlocks = achievementUnlocks.filter(u => !u.reward_paid);

      document.getElementById('achievement-count').textContent = `${unlockedIds.length}/${achievements.length}`;

      // Update summary
      updateTrophySummary();

      // Show unclaimed alert if needed
      const unclaimedAlert = document.getElementById('unclaimed-alert');
      if (unclaimedUnlocks.length > 0) {
        unclaimedAlert.style.display = 'flex';
      } else {
        unclaimedAlert.style.display = 'none';
      }

      grid.innerHTML = achievements.map(a => {
        const unlock = achievementUnlocks.find(u => u.achievement_id === a.id);
        const unlocked = !!unlock;
        const claimed = unlock?.reward_paid;
        const reward = a.reward_amount || 0;

        let rewardHtml;
        if (!unlocked) {
          rewardHtml = `<div class="achievement-reward">+$${reward.toFixed(2)}</div>`;
        } else if (!claimed && reward > 0) {
          rewardHtml = `<button class="achievement-claim-btn" onclick="claimReward('${unlock.id}', '${a.name}', ${reward})">Claim $${reward.toFixed(2)}</button>`;
        } else if (claimed && reward > 0) {
          rewardHtml = `<span class="achievement-claimed-badge"> $${reward.toFixed(2)}</span>`;
        } else {
          rewardHtml = `<span class="achievement-claimed-badge"></span>`;
        }

        return `
          <div class="achievement-card ${unlocked ? 'unlocked' : ''} ${unlocked && !claimed && reward > 0 ? 'claimable' : ''}">
            <div class="achievement-icon">${unlocked ? a.icon : ''}</div>
            <div class="achievement-info">
              <div class="achievement-name">${a.name}</div>
              <div class="achievement-desc">${a.description}</div>
            </div>
            ${rewardHtml}
          </div>
        `;
      }).join('');

      // Render privileges
      renderPrivileges();
    }

    function updateTrophySummary() {
      // Calculate earnings
      let earnedTotal = 0;
      let unclaimedTotal = 0;
      let potentialTotal = 0;

      achievements.forEach(a => {
        const reward = a.reward_amount || 0;
        const unlock = achievementUnlocks.find(u => u.achievement_id === a.id);

        if (unlock?.reward_paid) {
          earnedTotal += reward;
        } else if (unlock) {
          unclaimedTotal += reward;
        } else {
          potentialTotal += reward;
        }
      });

      document.getElementById('trophy-earned').textContent = `$${earnedTotal.toFixed(2)}`;
      document.getElementById('trophy-unclaimed').textContent = `$${unclaimedTotal.toFixed(2)}`;
      document.getElementById('trophy-potential').textContent = `$${potentialTotal.toFixed(2)}`;
    }

    window.claimReward = async function(unlockId, achievementName, amount) {
      try {
        await claimAchievementReward(unlockId);
        // Update local state
        const unlock = achievementUnlocks.find(u => u.id === unlockId);
        if (unlock) unlock.reward_paid = true;

        // Show success animation
        showToast(` Claimed $${amount.toFixed(2)} for "${achievementName}"!`);

        // Re-render
        renderAchievements();
      } catch (error) {
        console.error('Error claiming reward:', error);
        showToast('Error claiming reward', 'error');
      }
    };

    function renderPrivileges() {
      const section = document.getElementById('privileges-section');
      const grid = document.getElementById('privileges-grid');

      if (privileges.length === 0) {
        section.style.display = 'none';
        return;
      }

      section.style.display = 'block';
      const unlockedIds = privilegeUnlocks.map(u => u.privilege_id);
      document.getElementById('privilege-count').textContent = unlockedIds.length;

      grid.innerHTML = privileges.map(p => {
        const unlock = privilegeUnlocks.find(u => u.privilege_id === p.id);
        const unlocked = !!unlock;
        const used = !!unlock?.used_at;

        let actionHtml;
        if (!unlocked) {
          actionHtml = `<span style="color: #64748b; font-size: 12px;"> Locked</span>`;
        } else if (used) {
          actionHtml = `<span class="privilege-used-badge"> Used</span>`;
        } else {
          actionHtml = `<button class="privilege-use-btn" onclick="usePrivilegeReward('${unlock.id}', '${p.name}')">Use</button>`;
        }

        return `
          <div class="privilege-card ${unlocked ? 'unlocked' : ''} ${used ? 'used' : ''}">
            <div class="privilege-icon">${unlocked ? p.icon : ''}</div>
            <div class="privilege-info">
              <div class="privilege-name">${p.name}</div>
              <div class="privilege-desc">${p.description || ''}</div>
            </div>
            ${actionHtml}
          </div>
        `;
      }).join('');
    }

    window.usePrivilegeReward = async function(unlockId, privilegeName) {
      try {
        await usePrivilege(unlockId);
        // Update local state
        const unlock = privilegeUnlocks.find(u => u.id === unlockId);
        if (unlock) unlock.used_at = new Date().toISOString();

        showToast(` Used "${privilegeName}"!`);
        renderPrivileges();
      } catch (error) {
        console.error('Error using privilege:', error);
        showToast('Error using privilege', 'error');
      }
    };

    // Tab switching
    window.switchTab = function(tab) {
      document.querySelectorAll('.tab-btn').forEach((btn, i) => {
        btn.classList.toggle('active', ['quests', 'wallet', 'trophies'][i] === tab);
      });
      document.querySelectorAll('.tab-content').forEach(c => {
        c.classList.toggle('active', c.id === `tab-${tab}`);
      });
      if (tab === 'trophies') renderAchievements();
      if (tab === 'wallet') {
        renderPayScale();
        renderMoneyMakersList();
      }
    };

    // Modal functions
    window.showModal = function(id) {
      document.getElementById(id).classList.add('show');
      if (id === 'pin-modal') {
        document.getElementById('pin-error').classList.remove('show');
        document.querySelectorAll('.pin-digit').forEach(i => i.value = '');
        document.querySelector('.pin-digit')?.focus();
      }
      if (id === 'theme-modal') {
        // Highlight current theme
        const current = getCurrentTheme();
        document.querySelectorAll('.theme-card').forEach(card => {
          card.classList.toggle('selected', card.dataset.theme === current);
        });
      }
      if (id === 'add-chore-modal') {
        renderChoreTemplates('chore-templates-picker', 'add-chore');
      }
      if (id === 'payday-modal') {
        // Show available bonus tasks (not yet done or requested today)
        const today = new Date().toISOString().split('T')[0];
        const todayCompletedIds = bonusTaskCompletions
          .filter(c => {
            const compDate = c.completion_date || (c.completed_at ? c.completed_at.split('T')[0] : '');
            return compDate === today;
          })
          .map(c => c.bonus_task_id);
        const available = bonusTasks.filter(m => !todayCompletedIds.includes(m.id));

        const section = document.getElementById('payday-bonus-section');
        const list = document.getElementById('payday-bonus-list');

        if (available.length > 0) {
          section.style.display = 'block';
          list.innerHTML = available.map(m =>
            `<div style="margin-bottom: 6px;">${m.icon} ${m.name} <span style="color: #fbbf24;">+${m.xp_value || 10} XP</span></div>`
          ).join('');
        } else {
          section.style.display = 'none';
        }
      }
    };

    window.closeModal = function(id) {
      document.getElementById(id).classList.remove('show');
    };

    // PIN handling
    function initPinInputs() {
      const container = document.getElementById('pin-inputs');
      container.innerHTML = [0, 1, 2, 3].map(() => `<input type="password" class="pin-digit" maxlength="1" inputmode="numeric">`).join('');

      const inputs = container.querySelectorAll('.pin-digit');
      inputs.forEach((input, i) => {
        input.addEventListener('input', e => {
          if (e.target.value && i < 3) inputs[i + 1].focus();
          const pin = Array.from(inputs).map(x => x.value).join('');
          if (pin.length === 4) verifyPin(pin);
        });
        input.addEventListener('keydown', e => {
          if (e.key === 'Backspace' && !e.target.value && i > 0) inputs[i - 1].focus();
        });
      });
    }

    function verifyPin(pin) {
      if (pin === parentPinHash) {
        closeModal('pin-modal');
        openParentPortal();
      } else {
        document.getElementById('pin-error').classList.add('show');
        document.querySelectorAll('.pin-digit').forEach(i => i.value = '');
        document.querySelector('.pin-digit')?.focus();
      }
    }

    // Parent Portal
    async function openParentPortal() {
      document.getElementById('main-app').style.display = 'none';
      document.getElementById('parent-portal').style.display = 'block';
      document.getElementById('family-name-display').textContent = currentFamily?.name || 'Family Dashboard';
      await loadSettingsData();
      renderPortalChildSelector();
      if (children.length > 0 && !selectedPortalChildId) {
        selectedPortalChildId = children[0].id;
      }
      await renderPortalOverview();
      setupRealtimeNotifications();
    }

    window.exitParentPortal = async function() {
      // Clean up subscription
      if (completionSubscription) {
        completionSubscription.unsubscribe();
        completionSubscription = null;
      }

      const deviceRole = getDeviceRole();

      // If this is a parent device, show message (parents stay in portal)
      if (deviceRole === 'parent') {
        showToast('This is your parent device - you\'re home!');
        return;
      }

      // If no current user (shouldn't happen but just in case)
      if (!currentUser) {
        document.getElementById('parent-portal').style.display = 'none';
        goToStep('setup-link-instructions');
        document.getElementById('setup-wizard').style.display = 'block';
        return;
      }

      // Normal exit to child view (for child devices accessing portal via PIN)
      document.getElementById('parent-portal').style.display = 'none';
      document.getElementById('main-app').style.display = 'block';
      assignments = await getChildAssignments(currentUser.id);
      completions = await getWeeklyCompletions(currentUser.id, getWeekStart());
      renderQuests();
      updateStats();
    };

    // Selected child in portal
    let selectedPortalChildId = null;

    function getSelectedPortalChild() {
      if (!selectedPortalChildId) return null;
      return children.find(c => c.id === selectedPortalChildId);
    }

    window.switchPortalTab = function(tab) {
      document.querySelectorAll('.portal-nav-btn').forEach(b => {
        b.classList.toggle('active', b.dataset.tab === tab);
      });
      document.querySelectorAll('.portal-section').forEach(s => {
        s.classList.toggle('active', s.id === `portal-${tab}`);
      });

      // Load data for the selected tab
      // Child-specific tabs
      if (selectedPortalChildId) {
        if (tab === 'overview') renderPortalOverview();
        if (tab === 'assignments') renderPortalAssignments();
        if (tab === 'earnings') renderPortalEarnings();
      }
      // Family-wide tabs (don't require child selection)
      if (tab === 'children') renderPortalChildren();
      if (tab === 'activity') renderPortalActivity();
      if (tab === 'chores') renderPortalChores();
      if (tab === 'nightly') renderPortalNightly();
      if (tab === 'bonus') {
        renderPortalBonus();
        renderPortalPrivileges();
      }
    };

    function renderPortalChildSelector() {
      const container = document.getElementById('portal-child-selector');
      if (!container || children.length === 0) return;

      // Auto-select first child if none selected
      if (!selectedPortalChildId && children.length > 0) {
        selectedPortalChildId = children[0].id;
      }

      container.innerHTML = children.map(child => `
        <div class="child-select-card ${child.id === selectedPortalChildId ? 'selected' : ''}" onclick="selectPortalChild('${child.id}')">
          <div class="child-select-avatar">${child.avatar || ''}</div>
          <div class="child-select-name">${child.name}</div>
        </div>
      `).join('');
    }

    window.selectPortalChild = async function(childId) {
      selectedPortalChildId = childId;
      renderPortalChildSelector();
      await renderPortalOverview();
      await loadBedtimeReminder();
      // Update section titles
      const child = children.find(c => c.id === childId);
      if (child) {
        const assignTitle = document.getElementById('assignments-title');
        const earnTitle = document.getElementById('earnings-title');
        if (assignTitle) assignTitle.textContent = `${child.name}'s Chores`;
        if (earnTitle) earnTitle.textContent = `${child.name}'s Earnings`;
      }
    };

    async function renderPortalOverview() {
      if (!selectedPortalChildId) return;

      // Refresh children data to get latest XP/streak
      try {
        children = await getChildren(currentFamily.id);
        renderPortalChildSelector();
      } catch (e) {
        console.error('Error refreshing children:', e);
      }

      const child = children.find(c => c.id === selectedPortalChildId);
      if (!child) return;

      let childCompletions = [];
      try {
        childCompletions = await getWeeklyCompletions(child.id, getWeekStart());
      } catch (e) {
        console.error('Error loading completions:', e);
      }
      const weeklyXP = childCompletions.reduce((sum, c) => sum + (c.xp_earned || 0), 0);
      const rank = PAY_SCALE.find(r => weeklyXP >= r.minXP && weeklyXP <= r.maxXP) || PAY_SCALE[0];

      // Stats - show both weekly XP and total XP
      const statsHtml = `
        <div class="child-stat-card highlight">
          <div class="child-stat-value">${weeklyXP}</div>
          <div class="child-stat-label">WEEKLY XP</div>
        </div>
        <div class="child-stat-card">
          <div class="child-stat-value">${child.current_xp || 0}</div>
          <div class="child-stat-label">TOTAL XP</div>
        </div>
        <div class="child-stat-card">
          <div class="child-stat-value" style="color: ${rank.color};">${rank.name}</div>
          <div class="child-stat-label">CURRENT RANK</div>
        </div>
        <div class="child-stat-card">
          <div class="child-stat-value">${child.current_streak || 0}</div>
          <div class="child-stat-label">DAY STREAK</div>
        </div>
      `;
      document.getElementById('selected-child-stats').innerHTML = statsHtml;

      // Week progress
      const today = new Date().getDay();
      const completionsByDay = {};
      childCompletions.forEach(c => {
        const d = new Date(c.completion_date).getDay();
        completionsByDay[d] = (completionsByDay[d] || 0) + 1;
      });

      const weekHtml = DAY_NAMES.map((day, i) => `
        <div class="week-day-card ${i === today ? 'today' : ''}">
          <div class="week-day-name">${day}</div>
          <div class="week-day-count">${completionsByDay[i] || 0}</div>
        </div>
      `).join('');
      document.getElementById('week-progress-grid').innerHTML = weekHtml;

      // Load bedtime reminder for this child
      await loadBedtimeReminder();

      // Load and render pending approvals
      await renderPendingApprovals();
    }

    async function renderPendingApprovals() {
      const section = document.getElementById('pending-approvals-section');
      const list = document.getElementById('pending-approvals-list');
      const countBadge = document.getElementById('pending-approvals-count');
      if (!section || !list) return;

      try {
        const pending = await getPendingBonusTasks(currentFamily.id);
        if (pending.length === 0) {
          section.style.display = 'none';
          return;
        }

        section.style.display = 'block';
        countBadge.textContent = pending.length;

        list.innerHTML = pending.map(p => {
          const taskName = p.bonus_tasks?.name || 'Unknown Task';
          const taskIcon = p.bonus_tasks?.icon || '';
          const amount = parseFloat(p.bonus_tasks?.amount) || 0;
          const xpValue = p.bonus_tasks?.xp_value || 10;
          const childName = p.users?.name || 'Unknown';
          const childAvatar = p.users?.avatar || '';
          const rewardText = amount > 0 ? `$${amount.toFixed(2)} + ${xpValue} XP` : `${xpValue} XP`;
          const timeAgo = getTimeAgo(new Date(p.completed_at));

          return `
            <div class="item-card" style="padding: 12px;">
              <div class="item-icon">${childAvatar}</div>
              <div class="item-info" style="flex: 1;">
                <div class="item-name">${childName}  ${taskIcon} ${taskName}</div>
                <div class="item-desc">${rewardText}  ${timeAgo}</div>
              </div>
              <button class="item-btn" style="background: rgba(34, 197, 94, 0.2); color: #4ade80; min-width: 44px; min-height: 44px;" onclick="approveMoneyMaker('${p.id}', ${xpValue}, ${amount})" title="Approve"></button>
              <button class="item-btn" style="background: rgba(239, 68, 68, 0.2); color: #f87171; min-width: 44px; min-height: 44px;" onclick="denyMoneyMaker('${p.id}')" title="Deny"></button>
            </div>
          `;
        }).join('');
      } catch (e) {
        console.error('Error loading pending approvals:', e);
        section.style.display = 'none';
      }
    }

    window.approveMoneyMaker = async function(completionId, xpEarned, amountEarned) {
      try {
        await approveBonusTask(completionId, xpEarned, amountEarned);
        showToast('Approved! XP & reward granted ');
        await renderPendingApprovals();
        await renderPortalOverview();
      } catch (e) {
        console.error('Error approving money maker:', e);
        showToast('Failed to approve', 'error');
      }
    };

    window.denyMoneyMaker = async function(completionId) {
      try {
        await denyBonusTask(completionId);
        showToast('Request denied ');
        await renderPendingApprovals();
      } catch (e) {
        console.error('Error denying money maker:', e);
        showToast('Failed to deny', 'error');
      }
    };

    // Render children management list - fetches fresh data from DB
    async function renderPortalChildren() {
      const container = document.getElementById('portal-children-list');
      if (!container) return;

      // Refresh children data from database to get latest XP/streak
      try {
        children = await getChildren(currentFamily.id);
      } catch (e) {
        console.error('Error refreshing children:', e);
      }

      if (children.length === 0) {
        container.innerHTML = '<div class="empty-state"><div class="empty-text">No children added yet</div></div>';
        return;
      }

      container.innerHTML = children.map(child => `
        <div class="item-card">
          <div class="item-icon">${child.avatar || ''}</div>
          <div class="item-info">
            <div class="item-name">${child.name}</div>
            <div class="item-desc">XP: ${child.current_xp || 0}  Streak: ${child.current_streak || 0} days</div>
          </div>
          <button class="item-btn" style="background: rgba(59, 130, 246, 0.2); color: #93c5fd;" onclick="editChild('${child.id}')" title="Edit"></button>
          <button class="item-btn" style="background: rgba(234, 179, 8, 0.2); color: #fbbf24;" onclick="resetChild('${child.id}')" title="Reset Progress"></button>
          <button class="item-btn" onclick="deleteChild('${child.id}')" title="Delete"></button>
        </div>
      `).join('');

      // Also update child selector
      renderPortalChildSelector();
    }

    window.addChildFromPortal = async function() {
      const name = document.getElementById('portal-new-child-name').value.trim();
      if (!name) {
        showToast('Enter child name', 'error');
        return;
      }
      try {
        await createUser({
          familyId: currentFamily.id,
          type: 'child',
          name,
          avatar: ''
        });
        document.getElementById('portal-new-child-name').value = '';
        children = await getChildren(currentFamily.id);
        renderPortalChildren();
        renderPortalChildSelector();
        showToast('Child added!');
      } catch (e) {
        console.error(e);
        showToast('Failed to add child', 'error');
      }
    };

    // Render activity for all children
    async function renderPortalActivity() {
      const feed = document.getElementById('portal-activity-feed');
      if (!feed) return;

      // Get completions for all children
      let allCompletions = [];
      for (const child of children) {
        const completions = await getWeeklyCompletions(child.id, getWeekStart());
        completions.forEach(c => {
          c._childName = child.name;
          c._childAvatar = child.avatar || '';
        });
        allCompletions = allCompletions.concat(completions);
      }

      if (allCompletions.length === 0) {
        feed.innerHTML = `
          <div class="empty-activity">
            <div class="empty-activity-icon"></div>
            <div>No activity yet this week</div>
          </div>
        `;
        return;
      }

      const todayDate = new Date().toISOString().split('T')[0];
      const sorted = [...allCompletions].sort((a, b) => new Date(b.completed_at) - new Date(a.completed_at));

      feed.innerHTML = sorted.slice(0, 20).map(completion => {
        const chore = completion.chore_assignments?.chore_templates;
        const isToday = completion.completion_date === todayDate;
        const time = new Date(completion.completed_at);
        const timeStr = isToday ? getTimeAgo(time) : time.toLocaleString();
        return `
          <div class="activity-item">
            <div class="activity-icon">${completion._childAvatar}</div>
            <div class="activity-content">
              <div class="activity-text"><strong>${completion._childName}</strong> completed ${chore?.name || 'Task'}</div>
              <div class="activity-time">${timeStr}</div>
            </div>
            <div class="activity-xp">+${completion.xp_earned} XP</div>
          </div>
        `;
      }).join('');
    }

    // Render nightly zones config
    function renderPortalNightly() {
      const container = document.getElementById('portal-nightly-zones-list');
      if (!container) return;

      const zones = getNightlyZones();

      if (zones.length === 0) {
        container.innerHTML = '<div class="empty-state"><div class="empty-text">No zones configured. Add zones for nightly patrol!</div></div>';
        renderNightlyTally();
        return;
      }

      container.innerHTML = zones.map((z, i) => `
        <div class="item-card">
          <div class="item-icon">${z.icon}</div>
          <div class="item-info">
            <div class="item-name">${z.name || z.label}</div>
            <div class="item-desc">${z.id ? '5 XP per check' : '5 XP (default zone)'}</div>
          </div>
          ${z.id ? `<button class="item-btn" onclick="deleteNightlyZoneFromPortal('${z.id}')"></button>` : ''}
        </div>
      `).join('');

      renderNightlyTally();
    }

    window.addNightlyZoneFromPortal = async function() {
      const icon = document.getElementById('portal-new-zone-icon').value;
      const name = document.getElementById('portal-new-zone-name').value.trim();
      if (!name) {
        showToast('Enter zone name', 'error');
        return;
      }
      const key = name.toLowerCase().replace(/\s+/g, '_') + '_' + Date.now();
      try {
        await createNightlyZone({
          familyId: currentFamily.id,
          zoneKey: key,
          name: name.toUpperCase(),
          icon,
          sortOrder: nightlyZonesDB.length
        });
        await loadNightlyZonesFromDB();
        document.getElementById('portal-new-zone-name').value = '';
        renderPortalNightly();
        renderNightly();
        showToast('Zone added!');
      } catch (e) {
        console.error('Error adding zone:', e);
        showToast('Error adding zone', 'error');
      }
    };

    window.deleteNightlyZoneFromPortal = async function(zoneId) {
      if (!confirm('Delete this zone?')) return;
      try {
        await deleteNightlyZoneFromDB(zoneId);
        await loadNightlyZonesFromDB();
        renderPortalNightly();
        renderNightly();
        showToast('Zone deleted');
      } catch (e) {
        console.error('Error deleting zone:', e);
        showToast('Error deleting zone', 'error');
      }
    };

    // Bedtime Reminder functions
    let currentBedtimeReminder = null;

    async function loadBedtimeReminder() {
      if (!selectedPortalChildId) return;
      try {
        const reminders = await getChildReminders(selectedPortalChildId);
        currentBedtimeReminder = reminders.find(r => r.reminder_type === 'nightly');

        const timeInput = document.getElementById('bedtime-reminder-time');
        const messageInput = document.getElementById('bedtime-reminder-message');
        const deleteBtn = document.getElementById('delete-bedtime-btn');
        const statusDiv = document.getElementById('bedtime-reminder-status');

        if (currentBedtimeReminder) {
          timeInput.value = currentBedtimeReminder.reminder_time || '';
          messageInput.value = currentBedtimeReminder.message || '';
          deleteBtn.style.display = 'inline-block';
          const time = currentBedtimeReminder.reminder_time;
          if (time) {
            const [h, m] = time.split(':');
            const hour = parseInt(h);
            const ampm = hour >= 12 ? 'PM' : 'AM';
            const h12 = hour % 12 || 12;
            statusDiv.textContent = ` Active - reminds at ${h12}:${m} ${ampm}`;
            statusDiv.style.color = '#4ade80';
          }
        } else {
          timeInput.value = '';
          messageInput.value = '';
          deleteBtn.style.display = 'none';
          statusDiv.textContent = 'No bedtime reminder set';
          statusDiv.style.color = '#94a3b8';
        }
      } catch (e) {
        console.error('Error loading bedtime reminder:', e);
      }
    }

    window.saveBedtimeReminder = async function() {
      if (!selectedPortalChildId) {
        showToast('Select a child first', 'error');
        return;
      }

      const time = document.getElementById('bedtime-reminder-time').value;
      const message = document.getElementById('bedtime-reminder-message').value.trim();

      if (!time) {
        showToast('Set a reminder time', 'error');
        return;
      }

      try {
        if (currentBedtimeReminder) {
          // Update existing
          await updateReminder(currentBedtimeReminder.id, {
            reminder_time: time,
            message: message || 'Time for bed!'
          });
        } else {
          // Create new
          await createReminder({
            childId: selectedPortalChildId,
            reminderTime: time,
            reminderType: 'nightly',
            message: message || 'Time for bed!'
          });
        }
        await loadBedtimeReminder();
        showToast('Bedtime reminder saved!');
      } catch (e) {
        console.error('Error saving bedtime reminder:', e);
        showToast('Error saving reminder', 'error');
      }
    };

    window.deleteBedtimeReminder = async function() {
      if (!currentBedtimeReminder) return;
      if (!confirm('Remove bedtime reminder?')) return;

      try {
        await deleteReminder(currentBedtimeReminder.id);
        currentBedtimeReminder = null;
        await loadBedtimeReminder();
        showToast('Bedtime reminder removed');
      } catch (e) {
        console.error('Error deleting bedtime reminder:', e);
        showToast('Error removing reminder', 'error');
      }
    };

    function renderPortalChores() {
      const container = document.getElementById('portal-chores-list');
      if (choreTemplates.length === 0) {
        container.innerHTML = '<div class="empty-state"><div class="empty-text">No chores created yet</div></div>';
        renderChoresTally();
        return;
      }

      container.innerHTML = choreTemplates.map(c => `
        <div class="item-card">
          <div class="item-icon">${c.icon}</div>
          <div class="item-info">
            <div class="item-name">${c.name}</div>
            <div class="item-desc">${c.xp_value} XP${c.description ? '  ' + c.description : ''}</div>
          </div>
          <button class="item-btn" style="background: rgba(59, 130, 246, 0.2); color: #93c5fd;" onclick="editChore('${c.id}')"></button>
          <button class="item-btn" onclick="deleteChore('${c.id}')"></button>
        </div>
      `).join('');

      renderChoresTally();
    }

    async function renderPortalAssignments() {
      if (!selectedPortalChildId) return;

      const container = document.getElementById('portal-assignments-list');
      const childAssignments = await getChildAssignments(selectedPortalChildId);

      if (childAssignments.length === 0) {
        container.innerHTML = '<div class="empty-state"><div class="empty-text">No chores assigned yet</div></div>';
        updatePotentialEarnings(0);
        return;
      }

      // Fetch reminders to show on cards
      const childReminders = await getChildReminders(selectedPortalChildId);

      // Helper to format time
      const formatTime = (timeStr) => {
        if (!timeStr) return '';
        const [hour, minute] = timeStr.split(':');
        const h = parseInt(hour);
        const ampm = h >= 12 ? 'PM' : 'AM';
        const h12 = h % 12 || 12;
        return `${h12}:${minute} ${ampm}`;
      };

      // Calculate potential XP
      let totalPotentialXP = 0;
      let dailyXP = 0;
      let weeklyXP = 0;

      // Attach reminder info and sort by reminder time (earliest first, no-reminder last)
      const assignmentsWithReminders = childAssignments.map(a => {
        const choreName = a.chore_templates?.name || 'Unknown';
        const reminder = childReminders.find(r =>
          r.message && r.message.startsWith('Time to do:') && r.message.includes(choreName)
        );
        return { ...a, _reminderTime: reminder ? reminder.reminder_time : null };
      });

      assignmentsWithReminders.sort((a, b) => {
        if (a._reminderTime && b._reminderTime) return a._reminderTime.localeCompare(b._reminderTime);
        if (a._reminderTime) return -1;
        if (b._reminderTime) return 1;
        return 0;
      });

      container.innerHTML = assignmentsWithReminders.map(a => {
        const chore = a.chore_templates;
        const xpValue = chore?.xp_value || 0;
        const choreName = chore?.name || 'Unknown';

        const reminderTime = a._reminderTime ? formatTime(a._reminderTime) : '';

        // Calculate weekly potential for this assignment
        if (a.recurrence_type === 'daily') {
          totalPotentialXP += xpValue * 7;
          dailyXP += xpValue;
        } else {
          totalPotentialXP += xpValue;
          weeklyXP += xpValue;
        }

        const schedule = a.recurrence_type === 'daily' ? 'Daily' :
          a.day_of_week !== null ? DAY_NAMES[a.day_of_week] : 'One-time';
        return `
          <div class="item-card">
            <div class="item-icon">${chore?.icon || ''}</div>
            <div class="item-info">
              <div class="item-name">${choreName}</div>
              <div class="item-desc">${schedule}  ${xpValue} XP${a.is_nightly ? '   Nightly' : ''}${reminderTime ? `   ${reminderTime}` : ''}</div>
            </div>
            <button class="item-btn" style="background: rgba(59, 130, 246, 0.2); color: #93c5fd;" onclick="editAssignment('${a.id}')"></button>
            <button class="item-btn" onclick="deleteAssignment('${a.id}')"></button>
          </div>
        `;
      }).join('');

      // Add nightly patrol XP
      const zones = getNightlyZones();
      const nightlyXP = zones.length * 5 * 7;
      totalPotentialXP += nightlyXP;

      updatePotentialEarnings(totalPotentialXP, dailyXP, weeklyXP, nightlyXP, zones.length);
    }

    function updatePotentialEarnings() {
      // Redirect to assignments tally
      renderAssignmentsTally();
    }

    // Chores tab tally - shows total XP available from all chore templates
    function renderChoresTally() {
      const container = document.getElementById('chores-earnings-tally');
      if (!container) return;

      if (choreTemplates.length === 0) {
        container.innerHTML = '';
        return;
      }

      const totalXP = choreTemplates.reduce((sum, c) => sum + (c.xp_value || 0), 0);

      container.innerHTML = `
        <div class="earnings-tally-title"> Chore Templates Summary</div>
        <div class="earnings-tally-total">
          <div class="earnings-tally-total-label">
            <div>${choreTemplates.length} chore template${choreTemplates.length !== 1 ? 's' : ''} available</div>
          </div>
          <div class="earnings-tally-total-values">
            <div class="earnings-tally-xp">${totalXP} XP total</div>
          </div>
        </div>
      `;
    }

    // Nightly tab tally - shows XP from nightly patrol zones
    function renderNightlyTally() {
      const container = document.getElementById('nightly-earnings-tally');
      if (!container) return;

      const zones = getNightlyZones();
      if (zones.length === 0) {
        container.innerHTML = '';
        return;
      }

      const xpPerDay = zones.length * 5;
      const xpPerWeek = xpPerDay * 7;

      container.innerHTML = `
        <div class="earnings-tally-title"> Nightly Patrol Summary</div>
        <div class="earnings-tally-grid" style="grid-template-columns: 1fr 1fr 1fr;">
          <div class="earnings-tally-item">
            <span class="earnings-tally-label">${zones.length} zone${zones.length !== 1 ? 's' : ''}</span>
            <span class="earnings-tally-value"> 5 XP each</span>
          </div>
          <div class="earnings-tally-item">
            <span class="earnings-tally-label">Per night</span>
            <span class="earnings-tally-value">${xpPerDay} XP</span>
          </div>
          <div class="earnings-tally-item">
            <span class="earnings-tally-label">Per week</span>
            <span class="earnings-tally-value">${xpPerWeek} XP</span>
          </div>
        </div>
        <div class="earnings-tally-total">
          <div class="earnings-tally-total-label">
            <div> Complete all 7 nights = 1.5 pay multiplier!</div>
          </div>
        </div>
      `;
    }

    // Rewards/Bonus tab tally - shows total cash from Money Makers
    function renderBonusTally() {
      const container = document.getElementById('bonus-earnings-tally');
      if (!container) return;

      const totalCash = bonusTasks.reduce((sum, b) => sum + (parseFloat(b.amount) || 0), 0);
      const totalXP = bonusTasks.reduce((sum, b) => sum + (b.xp_value || 0), 0);

      if (bonusTasks.length === 0 && privileges.length === 0) {
        container.innerHTML = '';
        return;
      }

      container.innerHTML = `
        <div class="earnings-tally-title"> Rewards Summary</div>
        <div class="earnings-tally-grid">
          <div class="earnings-tally-item">
            <span class="earnings-tally-label"> Money Makers (${bonusTasks.length})</span>
            <span class="earnings-tally-value" style="color: #22c55e;">$${totalCash.toFixed(2)}</span>
          </div>
          <div class="earnings-tally-item">
            <span class="earnings-tally-label"> Bonus XP</span>
            <span class="earnings-tally-value">${totalXP} XP</span>
          </div>
          <div class="earnings-tally-item">
            <span class="earnings-tally-label"> Privileges</span>
            <span class="earnings-tally-value">${privileges.length} available</span>
          </div>
        </div>
        <div class="earnings-tally-total">
          <div class="earnings-tally-total-label">
            <div>Total bonus cash available</div>
          </div>
          <div class="earnings-tally-total-values">
            <div class="earnings-tally-pay">$${totalCash.toFixed(2)}</div>
          </div>
        </div>
      `;
    }

    // Assignments tab tally - comprehensive breakdown for selected child
    async function renderAssignmentsTally() {
      const container = document.getElementById('potential-earnings-summary');
      if (!container) return;

      if (!selectedPortalChildId) {
        container.innerHTML = '<div style="text-align: center; color: #64748b; padding: 8px;">Select a child to see potential earnings</div>';
        return;
      }

      const childAssignments = await getChildAssignments(selectedPortalChildId);

      let dailyXP = 0, weeklyXP = 0, dailyCount = 0, weeklyCount = 0;
      childAssignments.forEach(a => {
        const xp = a.chore_templates?.xp_value || 0;
        if (a.recurrence_type === 'daily') { dailyXP += xp; dailyCount++; }
        else { weeklyXP += xp; weeklyCount++; }
      });

      const zones = getNightlyZones();
      const nightlyXP = zones.length * 5 * 7;
      const totalXP = (dailyXP * 7) + weeklyXP + nightlyXP;
      const bonusCash = bonusTasks.reduce((sum, b) => sum + (parseFloat(b.amount) || 0), 0);

      const rank = PAY_SCALE.find(r => totalXP >= r.minXP && totalXP <= r.maxXP) ||
        PAY_SCALE.find(r => totalXP >= r.minXP) || PAY_SCALE[PAY_SCALE.length - 1];

      container.innerHTML = `
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px; font-size: 12px; margin-bottom: 12px;">
          <div style="color: #94a3b8;"> Daily (${dailyCount}): ${dailyXP}  7 = <span style="color: #fbbf24;">${dailyXP * 7} XP</span></div>
          <div style="color: #94a3b8;"> Weekly (${weeklyCount}): <span style="color: #fbbf24;">${weeklyXP} XP</span></div>
          <div style="color: #94a3b8;"> Nightly (${zones.length} zones): <span style="color: #fbbf24;">${nightlyXP} XP</span></div>
          <div style="color: #94a3b8;"> Bonus tasks: <span style="color: #22c55e;">$${bonusCash.toFixed(2)}</span></div>
        </div>
        <div style="display: flex; justify-content: space-between; align-items: center; padding-top: 12px; border-top: 1px solid rgba(148, 163, 184, 0.2);">
          <div>
            <div style="font-size: 13px; color: #64748b;">MAX WEEKLY</div>
            <div style="font-size: 20px; font-weight: 700; color: #fbbf24;">${totalXP} XP  ${rank.name}</div>
          </div>
          <div style="text-align: right;">
            <div style="font-size: 13px; color: #64748b;">POTENTIAL PAY</div>
            <div style="font-size: 20px; font-weight: 700; color: #22c55e;">$${(rank.pay * 1.5 + bonusCash).toFixed(2)}</div>
          </div>
        </div>
      `;
    }

    // Earnings tab tally - not needed, that tab already shows current earnings
    function renderEarningsTally() {
      const container = document.getElementById('earnings-earnings-tally');
      if (!container) return;
      container.innerHTML = ''; // Earnings tab already has full breakdown above
    }

    async function renderPortalReminders() {
      if (!selectedPortalChildId) return;

      const container = document.getElementById('portal-reminders-list');
      if (!container) return; // Element not in current view

      const childReminders = await getChildReminders(selectedPortalChildId);

      if (childReminders.length === 0) {
        container.innerHTML = '<div class="empty-state"><div class="empty-text">No reminders set</div></div>';
        return;
      }

      container.innerHTML = childReminders.map(r => {
        const time = r.reminder_time.split(':');
        const hour = parseInt(time[0]);
        const ampm = hour >= 12 ? 'PM' : 'AM';
        const hour12 = hour % 12 || 12;
        const timeStr = `${hour12}:${time[1]} ${ampm}`;

        return `
          <div class="item-card">
            <div class="item-icon"></div>
            <div class="item-info">
              <div class="item-name">${timeStr}</div>
              <div class="item-desc">${r.reminder_type}  ${r.message || 'Time to do your chores!'}</div>
            </div>
            <button class="item-btn" onclick="deleteReminderById('${r.id}')"></button>
          </div>
        `;
      }).join('');
    }

    async function renderPortalEarnings() {
      if (!selectedPortalChildId) return;

      const container = document.getElementById('portal-earnings-display');
      const child = children.find(c => c.id === selectedPortalChildId);
      if (!child) return;

      const childCompletions = await getWeeklyCompletions(selectedPortalChildId, getWeekStart());
      const weeklyXP = childCompletions.reduce((sum, c) => sum + (c.xp_earned || 0), 0);
      const rank = PAY_SCALE.find(r => weeklyXP >= r.minXP && weeklyXP <= r.maxXP) || PAY_SCALE[0];

      // Get nightly streak - fetch completions for this child
      const zones = getNightlyZones();
      let childNightlyCompletions = [];
      try {
        childNightlyCompletions = await getNightlyCompletions(selectedPortalChildId, getWeekStart());
      } catch (e) {
        console.log('Could not fetch nightly completions:', e);
      }

      let nightlyStreak = 0;
      for (let i = 0; i < 7; i++) {
        const allComplete = zones.every(z => {
          if (z.id) {
            return childNightlyCompletions.some(c =>
              c.zone_id === z.id && c.day_of_week === i
            );
          }
          const key = `nightly_${selectedPortalChildId}_${getWeekStart()}_${i}`;
          const s = JSON.parse(localStorage.getItem(key) || '{}');
          return !!s[z.key];
        });
        if (allComplete) nightlyStreak++;
      }
      const multiplier = nightlyStreak === 7 ? 1.5 : 1;
      const basePay = rank.pay * multiplier;

      // Get bonus task earnings for this child
      let childBonusCompletions = [];
      try {
        childBonusCompletions = await getBonusTaskCompletions(selectedPortalChildId, getWeekStart());
      } catch (e) {
        console.log('Could not fetch bonus completions:', e);
      }
      const bonusEarnings = childBonusCompletions
        .filter(c => (c.status || 'approved') === 'approved')
        .reduce((sum, c) => sum + (parseFloat(c.amount_earned) || 0), 0);
      const bonusCount = childBonusCompletions.filter(c => (c.status || 'approved') === 'approved').length;

      const total = basePay + bonusEarnings;

      // Payment deep links
      const venmoUsername = getVenmoUsername(selectedPortalChildId);
      const cashAppTag = getCashAppTag(selectedPortalChildId);
      const weekLabel = new Date().toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
      const payNote = `Quest Log - Week of ${weekLabel} allowance`;

      let payButtonsHtml = '';
      const hasAnyPayment = venmoUsername || cashAppTag;

      if (venmoUsername) {
        const venmoLink = `venmo://paycharge?txn=pay&recipients=${encodeURIComponent(venmoUsername)}&amount=${total.toFixed(2)}&note=${encodeURIComponent(payNote)}`;
        payButtonsHtml += `
          <a href="${venmoLink}" style="display: block; margin-top: 16px; padding: 14px; background: linear-gradient(135deg, #008CFF, #0074D9); color: white; text-align: center; border-radius: 12px; font-weight: 700; font-size: 16px; text-decoration: none; min-height: 44px; line-height: 20px;">
             Pay $${total.toFixed(2)} via Venmo
          </a>
          <div style="text-align: center; font-size: 11px; color: #64748b; margin-top: 4px;">Opens Venmo  @${venmoUsername}</div>`;
      }

      if (cashAppTag) {
        const cashAppLink = `https://cash.app/$${cashAppTag}/${total.toFixed(2)}`;
        payButtonsHtml += `
          <a href="${cashAppLink}" style="display: block; margin-top: ${venmoUsername ? '10' : '16'}px; padding: 14px; background: linear-gradient(135deg, #00D632, #00B82E); color: white; text-align: center; border-radius: 12px; font-weight: 700; font-size: 16px; text-decoration: none; min-height: 44px; line-height: 20px;">
             Pay $${total.toFixed(2)} via Cash App
          </a>
          <div style="text-align: center; font-size: 11px; color: #64748b; margin-top: 4px;">Opens Cash App  $${cashAppTag}</div>`;
      }

      if (!hasAnyPayment) {
        payButtonsHtml = `<div style="margin-top: 16px; padding: 12px; background: rgba(100, 116, 139, 0.1); border-radius: 10px; text-align: center; font-size: 12px; color: #64748b;">
            Set Venmo or Cash App in Edit Child () to enable quick pay
          </div>`;
      }

      container.innerHTML = `
        <div style="text-align: center; padding: 20px;">
          <div style="font-size: 48px; font-weight: 900; color: #22c55e; margin-bottom: 8px;">$${total.toFixed(2)}</div>
          <div style="font-size: 12px; color: #94a3b8; margin-bottom: 20px;">This week's earnings</div>

          <div style="display: flex; justify-content: space-around; margin-bottom: 20px;">
            <div>
              <div style="font-size: 24px; font-weight: 700; color: ${rank.color};">${rank.name}</div>
              <div style="font-size: 13px; color: #64748b;">RANK</div>
            </div>
            <div>
              <div style="font-size: 24px; font-weight: 700; color: #e2e8f0;">${weeklyXP}</div>
              <div style="font-size: 13px; color: #64748b;">WEEKLY XP</div>
            </div>
            <div>
              <div style="font-size: 24px; font-weight: 700; color: #e2e8f0;">${multiplier > 1 ? '1.5x' : '1x'}</div>
              <div style="font-size: 13px; color: #64748b;">MULTIPLIER</div>
            </div>
          </div>

          <div style="background: rgba(30, 41, 59, 0.5); border-radius: 12px; padding: 16px; text-align: left;">
            <div style="font-size: 13px; font-weight: 700; color: #64748b; margin-bottom: 10px;">BREAKDOWN</div>
            <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
              <span style="color: #94a3b8;">Base Pay (${rank.name} Rank)</span>
              <span style="color: #e2e8f0;">$${rank.pay.toFixed(2)}</span>
            </div>
            <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
              <span style="color: #94a3b8;">Streak Bonus (${nightlyStreak}/7 nights)</span>
              <span style="color: #e2e8f0;">${multiplier > 1 ? '1.5' : ''}</span>
            </div>
            ${bonusEarnings > 0 ? `
            <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
              <span style="color: #94a3b8;">Money Makers (${bonusCount}x)</span>
              <span style="color: #fbbf24;">+$${bonusEarnings.toFixed(2)}</span>
            </div>
            ` : ''}
            <div style="display: flex; justify-content: space-between; padding-top: 10px; border-top: 1px solid rgba(255,255,255,0.1);">
              <span style="color: #22c55e; font-weight: 700;">TOTAL</span>
              <span style="color: #22c55e; font-weight: 700;">$${total.toFixed(2)}</span>
            </div>
          </div>

          ${payButtonsHtml}
        </div>
      `;

      renderEarningsTally();
    }

    // Allowance Calculator
    let suggestedPayScale = null;

    window.runAllowanceCalc = async function() {
      const targetInput = document.getElementById('calc-target-amount').value;
      const target = parseFloat(targetInput);
      if (!target || target <= 0) {
        showToast('Enter a valid dollar amount', 'error');
        return;
      }

      // Get current child's assignments
      const childId = selectedPortalChildId;
      if (!childId) {
        showToast('Select a child first', 'error');
        return;
      }

      const childAssigns = await getChildAssignments(childId);
      const zones = getNightlyZones();

      // Calculate total possible weekly XP
      let dailyChoreXP = 0;
      let weeklyChoreXP = 0;
      const dailyChores = [];
      const weeklyChores = [];

      childAssigns.forEach(a => {
        const xp = a.chore_templates?.xp_value || 0;
        const name = a.chore_templates?.name || 'Unknown';
        if (a.recurrence_type === 'daily') {
          dailyChoreXP += xp;
          if (!dailyChores.find(d => d.name === name)) {
            dailyChores.push({ name, xp, perWeek: xp * 7 });
          }
        } else {
          weeklyChoreXP += xp;
          weeklyChores.push({ name, xp, day: DAY_NAMES[a.day_of_week] || '?', perWeek: xp });
        }
      });

      const totalChoreXP = (dailyChoreXP * 7) + weeklyChoreXP;
      const nightlyXPPerDay = zones.length * 5;
      const totalNightlyXP = nightlyXPPerDay * 7;
      const grandTotalXP = totalChoreXP + totalNightlyXP;

      // Work backwards from target
      // Max = S-rank pay  1.5 (streak bonus)
      // So S-rank pay = target / 1.5
      const sPay = Math.round((target / 1.5) * 100) / 100;

      // Build proportional pay scale
      // S = 100%, A = 80%, B = 60%, C = 40%, D = 20%
      const round50 = (v) => Math.round(v * 2) / 2; // round to nearest $0.50
      suggestedPayScale = [
        { name: 'F', minXP: 0, maxXP: Math.round(grandTotalXP * 0.19), pay: 0, color: '#64748b' },
        { name: 'D', minXP: Math.round(grandTotalXP * 0.20), maxXP: Math.round(grandTotalXP * 0.39), pay: round50(sPay * 0.20), color: '#f59e0b' },
        { name: 'C', minXP: Math.round(grandTotalXP * 0.40), maxXP: Math.round(grandTotalXP * 0.59), pay: round50(sPay * 0.40), color: '#22c55e' },
        { name: 'B', minXP: Math.round(grandTotalXP * 0.60), maxXP: Math.round(grandTotalXP * 0.79), pay: round50(sPay * 0.60), color: '#3b82f6' },
        { name: 'A', minXP: Math.round(grandTotalXP * 0.80), maxXP: Math.round(grandTotalXP * 0.89), pay: round50(sPay * 0.80), color: '#a855f7' },
        { name: 'S', minXP: Math.round(grandTotalXP * 0.90), maxXP: 9999, pay: round50(sPay), color: '#ffd700' }
      ];

      // Build breakdown HTML
      let breakdownHTML = `
        <div style="font-size: 13px; font-weight: 700; color: #60a5fa; margin-bottom: 12px;"> XP BREAKDOWN FOR ${children.find(c => c.id === childId)?.name?.toUpperCase() || 'CHILD'}</div>
      `;

      if (dailyChores.length > 0) {
        breakdownHTML += `<div style="font-size: 12px; color: #64748b; margin-bottom: 4px;">DAILY CHORES (7 days)</div>`;
        dailyChores.forEach(c => {
          breakdownHTML += `<div style="display:flex;justify-content:space-between;margin-bottom:4px;"><span style="color:#94a3b8;">${c.name} (${c.xp}/day)</span><span style="color:#e2e8f0;">${c.perWeek} XP</span></div>`;
        });
      }

      if (weeklyChores.length > 0) {
        breakdownHTML += `<div style="font-size: 12px; color: #64748b; margin: 8px 0 4px;">WEEKLY CHORES</div>`;
        weeklyChores.forEach(c => {
          breakdownHTML += `<div style="display:flex;justify-content:space-between;margin-bottom:4px;"><span style="color:#94a3b8;">${c.name} (${c.day})</span><span style="color:#e2e8f0;">${c.perWeek} XP</span></div>`;
        });
      }

      breakdownHTML += `<div style="font-size: 12px; color: #64748b; margin: 8px 0 4px;">NIGHTLY PATROL (${zones.length} zones  5 XP  7 days)</div>`;
      breakdownHTML += `<div style="display:flex;justify-content:space-between;margin-bottom:4px;"><span style="color:#94a3b8;">Nightly zones</span><span style="color:#e2e8f0;">${totalNightlyXP} XP</span></div>`;

      breakdownHTML += `
        <div style="display:flex;justify-content:space-between;padding-top:10px;border-top:1px solid rgba(255,255,255,0.1);margin-top:8px;">
          <span style="color:#22c55e;font-weight:700;">MAX POSSIBLE XP</span>
          <span style="color:#22c55e;font-weight:700;">${grandTotalXP} XP</span>
        </div>
      `;

      document.getElementById('calc-breakdown').innerHTML = breakdownHTML;

      // Build suggested pay scale HTML
      let scaleHTML = `
        <div style="font-size: 13px; font-weight: 700; color: #fbbf24; margin-bottom: 12px;"> SUGGESTED PAY SCALE</div>
        <div style="font-size: 12px; color: #94a3b8; margin-bottom: 12px;">Target: <strong style="color: #22c55e;">$${target.toFixed(2)}</strong> max (S-rank + nightly streak)</div>
      `;

      suggestedPayScale.forEach(tier => {
        const maxLabel = tier.maxXP === 9999 ? '+' : `-${tier.maxXP}`;
        scaleHTML += `
          <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:6px;padding:8px;border-radius:8px;background:rgba(255,255,255,0.03);">
            <div>
              <span style="color:${tier.color};font-weight:800;font-size:18px;margin-right:8px;">${tier.name}</span>
              <span style="color:#64748b;font-size:12px;">${tier.minXP}${maxLabel} XP</span>
            </div>
            <span style="color:#e2e8f0;font-weight:700;">$${tier.pay.toFixed(2)}</span>
          </div>
        `;
      });

      scaleHTML += `
        <div style="margin-top:12px;padding:10px;border-radius:8px;background:rgba(34,197,94,0.1);border:1px solid rgba(34,197,94,0.3);">
          <div style="display:flex;justify-content:space-between;">
            <span style="color:#94a3b8;">S-rank base</span>
            <span style="color:#e2e8f0;">$${round50(sPay).toFixed(2)}</span>
          </div>
          <div style="display:flex;justify-content:space-between;">
            <span style="color:#94a3b8;"> 1.5 streak bonus</span>
            <span style="color:#22c55e;font-weight:700;">$${(round50(sPay) * 1.5).toFixed(2)}</span>
          </div>
        </div>
      `;

      document.getElementById('calc-suggested-scale').innerHTML = scaleHTML;
      document.getElementById('calc-results').style.display = 'block';
    };

    window.applyCalcSuggestions = function() {
      if (!suggestedPayScale) return;

      // Update PAY_SCALE in memory
      PAY_SCALE.length = 0;
      suggestedPayScale.forEach(t => PAY_SCALE.push({...t}));

      // Persist to localStorage
      localStorage.setItem('chore_chart_pay_scale', JSON.stringify(PAY_SCALE));

      closeModal('allowance-calc-modal');
      showToast('Pay scale updated!');

      // Re-render earnings
      renderPortalEarnings();
    };

    // Money Makers / Bonus - Database-backed
    function renderPortalBonus() {
      const container = document.getElementById('portal-bonus-list');

      if (bonusTasks.length === 0) {
        container.innerHTML = '<div class="empty-state"><div class="empty-text">No money makers yet. Add some bonus tasks kids can do for extra cash!</div></div>';
        renderBonusTally();
        return;
      }

      container.innerHTML = bonusTasks.map(t => `
        <div class="item-card">
          <div class="item-icon">${t.icon}</div>
          <div class="item-info">
            <div class="item-name">${t.name}</div>
            <div class="item-desc">${t.description || 'Extra task'}  $${(t.amount || 0).toFixed(2)}  ${t.xp_value || 10} XP</div>
          </div>
          <button class="item-btn" style="background: rgba(59, 130, 246, 0.2); color: #93c5fd;" onclick="editBonusTaskDB('${t.id}')"></button>
          <button class="item-btn" onclick="deleteBonusTaskDB('${t.id}')"></button>
        </div>
      `).join('');

      renderBonusTally();
    }

    window.showAddBonusModal = function() {
      document.getElementById('add-bonus-name').value = '';
      document.getElementById('add-bonus-desc').value = '';
      document.getElementById('add-bonus-icon').value = '';
      document.getElementById('add-bonus-amount').value = '5';
      showModal('add-bonus-modal');
    };

    window.saveNewBonus = async function() {
      const name = document.getElementById('add-bonus-name').value.trim();
      const description = document.getElementById('add-bonus-desc').value.trim();
      const icon = document.getElementById('add-bonus-icon').value;
      const amount = parseFloat(document.getElementById('add-bonus-amount').value);

      if (!name) {
        showToast('Enter task name', 'error');
        return;
      }

      try {
        const newTask = await createBonusTask({
          familyId: currentFamily.id,
          name,
          description,
          icon,
          amount,
          xpValue: Math.round(amount * 2), // XP = 2x the dollar amount
          createdBy: currentUser?.id
        });
        bonusTasks.unshift(newTask);
        closeModal('add-bonus-modal');
        renderPortalBonus();
        showToast('Money maker added!');
      } catch (error) {
        console.error('Error creating bonus task:', error);
        showToast('Error creating task', 'error');
      }
    };

    window.deleteBonusTaskDB = async function(taskId) {
      if (!confirm('Delete this money maker?')) return;
      try {
        await deleteBonusTaskFromDB(taskId);
        bonusTasks = bonusTasks.filter(t => t.id !== taskId);
        renderPortalBonus();
        showToast('Deleted');
      } catch (error) {
        console.error('Error deleting bonus task:', error);
        showToast('Error deleting task', 'error');
      }
    };

    window.editBonusTaskDB = async function(taskId) {
      const task = bonusTasks.find(t => t.id === taskId);
      if (!task) return;

      const newName = prompt('Task name:', task.name);
      if (newName === null) return;

      const newAmount = prompt('Amount ($):', task.amount || 0);
      if (newAmount === null) return;

      try {
        const updated = await updateBonusTaskInDB(taskId, {
          name: newName || task.name,
          amount: parseFloat(newAmount) || task.amount,
          xp_value: Math.round((parseFloat(newAmount) || task.amount) * 2)
        });
        const idx = bonusTasks.findIndex(t => t.id === taskId);
        if (idx >= 0) bonusTasks[idx] = updated;
        renderPortalBonus();
        showToast('Updated');
      } catch (error) {
        console.error('Error updating bonus task:', error);
        showToast('Error updating task', 'error');
      }
    };

    // ============================================
    // Privileges Management
    // ============================================

    function renderPortalPrivileges() {
      const list = document.getElementById('portal-privileges-list');
      if (!list) return;

      if (privileges.length === 0) {
        list.innerHTML = `<div class="empty-state"><div class="empty-icon"></div><div class="empty-text">No privileges yet</div></div>`;
        return;
      }

      list.innerHTML = privileges.map((p, i) => {
        const unlockText = p.unlock_type === 'manual' ? 'Parent grants' :
          p.unlock_type === 'xp_threshold' ? `${p.unlock_value?.xp || 0} XP` :
          'Achievement';
        return `
          <div class="item-row">
            <span class="item-icon">${p.icon}</span>
            <div class="item-info">
              <div class="item-name">${p.name}</div>
              <div class="item-meta">Unlock: ${unlockText}</div>
            </div>
            <button class="item-btn" onclick="grantPrivilegeToChild('${p.id}')"></button>
            <button class="item-btn" onclick="deletePrivilege('${p.id}')"></button>
          </div>
        `;
      }).join('');
    }

    window.showAddPrivilegeModal = function() {
      document.getElementById('add-privilege-name').value = '';
      document.getElementById('add-privilege-desc').value = '';
      document.getElementById('add-privilege-icon').value = '';
      document.getElementById('add-privilege-unlock-type').value = 'manual';
      document.getElementById('privilege-xp-group').style.display = 'none';
      showModal('add-privilege-modal');
    };

    // Handle unlock type change to show/hide XP input
    document.getElementById('add-privilege-unlock-type')?.addEventListener('change', function(e) {
      const xpGroup = document.getElementById('privilege-xp-group');
      xpGroup.style.display = e.target.value === 'xp_threshold' ? 'block' : 'none';
    });

    window.saveNewPrivilege = async function() {
      const name = document.getElementById('add-privilege-name').value.trim();
      const description = document.getElementById('add-privilege-desc').value.trim();
      const icon = document.getElementById('add-privilege-icon').value;
      const unlockType = document.getElementById('add-privilege-unlock-type').value;

      if (!name) {
        showToast('Enter privilege name', 'error');
        return;
      }

      let unlockValue = null;
      if (unlockType === 'xp_threshold') {
        unlockValue = { xp: parseInt(document.getElementById('add-privilege-xp').value) };
      }

      try {
        const newPrivilege = await createPrivilege({
          family_id: currentFamily.id,
          name,
          description,
          icon,
          unlock_type: unlockType,
          unlock_value: unlockValue
        });
        privileges.push(newPrivilege);
        closeModal('add-privilege-modal');
        renderPortalPrivileges();
        showToast('Privilege added!');
      } catch (error) {
        console.error('Error creating privilege:', error);
        showToast('Error creating privilege', 'error');
      }
    };

    window.deletePrivilege = async function(privilegeId) {
      if (!confirm('Delete this privilege?')) return;

      try {
        const { error } = await supabase
          .from('privileges')
          .delete()
          .eq('id', privilegeId);
        if (error) throw error;

        privileges = privileges.filter(p => p.id !== privilegeId);
        renderPortalPrivileges();
        showToast('Deleted');
      } catch (error) {
        console.error('Error deleting privilege:', error);
        showToast('Error deleting privilege', 'error');
      }
    };

    window.grantPrivilegeToChild = async function(privilegeId) {
      const selectedChild = getSelectedPortalChild();
      if (!selectedChild) {
        showToast('Select a child first', 'error');
        return;
      }

      try {
        await unlockPrivilege(selectedChild.id, privilegeId);
        showToast(`Granted privilege to ${selectedChild.name}!`);
      } catch (error) {
        if (error?.code === '23505') {
          showToast('Already unlocked!', 'error');
        } else {
          console.error('Error granting privilege:', error);
          showToast('Error granting privilege', 'error');
        }
      }
    };

    // Helper functions for portal
    // Note: showAssignChoreModal is defined below with dropdown population

    window.showAddReminderModal = function() {
      if (!selectedPortalChildId) {
        showToast('Select a child first', 'error');
        return;
      }
      showModal('add-reminder-modal');
    };

    // Note: deleteAssignment is defined later in settings section and handles both contexts

    // Edit assignment
    window.editAssignment = async function(id) {
      const childAssignments = await getChildAssignments(selectedPortalChildId);
      const assignment = childAssignments.find(a => a.id === id);
      if (!assignment) return;

      const choreName = assignment.chore_templates?.name || 'Unknown';

      document.getElementById('edit-assignment-id').value = id;
      document.getElementById('edit-assignment-chore-name').textContent =
        `${assignment.chore_templates?.icon || ''} ${choreName} (${assignment.chore_templates?.xp_value || 0} XP)`;
      document.getElementById('edit-assignment-schedule').value = assignment.recurrence_type === 'daily' ? 'daily' : 'weekly';
      document.getElementById('edit-assignment-day').value = assignment.day_of_week ?? 0;
      document.getElementById('edit-assignment-nightly').checked = assignment.is_nightly || false;
      toggleEditDaySelect();

      // Find existing reminder for this chore
      const childReminders = await getChildReminders(selectedPortalChildId);
      const choreReminder = childReminders.find(r =>
        r.message && r.message.startsWith('Time to do:') && r.message.includes(choreName)
      );

      if (choreReminder) {
        document.getElementById('edit-assignment-reminder-time').value = choreReminder.reminder_time || '';
        document.getElementById('edit-assignment-reminder-id').value = choreReminder.id;
      } else {
        document.getElementById('edit-assignment-reminder-time').value = '';
        document.getElementById('edit-assignment-reminder-id').value = '';
      }

      showModal('edit-assignment-modal');
    };

    window.toggleEditDaySelect = function() {
      const schedule = document.getElementById('edit-assignment-schedule').value;
      document.getElementById('edit-day-group').style.display = schedule === 'weekly' ? 'block' : 'none';
    };

    window.saveAssignmentEdit = async function() {
      const id = document.getElementById('edit-assignment-id').value;
      const schedule = document.getElementById('edit-assignment-schedule').value;
      const dayOfWeek = schedule === 'weekly' ? parseInt(document.getElementById('edit-assignment-day').value) : null;
      const isNightly = document.getElementById('edit-assignment-nightly').checked;
      const reminderTime = document.getElementById('edit-assignment-reminder-time').value;
      const existingReminderId = document.getElementById('edit-assignment-reminder-id').value;

      // Get the chore name from the display
      const choreNameDisplay = document.getElementById('edit-assignment-chore-name').textContent;
      const choreNameMatch = choreNameDisplay.match(/[^\s]+\s+(.+?)\s+\(/);
      const choreName = choreNameMatch ? choreNameMatch[1] : 'your chore';

      try {
        // Update the assignment
        await updateChoreAssignment(id, {
          recurrence_type: schedule,
          day_of_week: dayOfWeek,
          is_nightly: isNightly
        });

        // Handle reminder
        if (reminderTime && existingReminderId) {
          // Update existing reminder
          await updateReminder(existingReminderId, {
            reminder_time: reminderTime,
            message: `Time to do: ${choreName}`
          });
        } else if (reminderTime && !existingReminderId) {
          // Create new reminder
          await createReminder({
            childId: selectedPortalChildId,
            reminderTime,
            reminderType: 'custom',
            message: `Time to do: ${choreName}`
          });
        } else if (!reminderTime && existingReminderId) {
          // Delete existing reminder
          await deleteReminder(existingReminderId);
        }

        closeModal('edit-assignment-modal');
        await renderPortalAssignments();
        await renderPortalReminders();
        showToast('Assignment updated!');
      } catch (e) {
        console.error(e);
        showToast('Failed to update', 'error');
      }
    };

    window.deleteReminderById = async function(id) {
      if (!confirm('Delete this reminder?')) return;
      try {
        await deleteReminder(id);
        await renderPortalReminders();
        showToast('Reminder deleted');
      } catch (e) {
        showToast('Failed', 'error');
      }
    };

    // Add chore from portal
    // Chore quick templates
    const CHORE_TEMPLATES = [
      {
        name: 'Clean Your Room',
        icon: '',
        xp: 20,
        description: '1. Pick up ALL laundry and put in the hamper\n2. Remove all items from the floor\n3. Vacuum the entire floor including under the bed\n4. Remove all trash and throw away\n5. Wipe down all flat surfaces (desk, nightstand, dresser)\n6. Make your bed'
      },
      {
        name: 'Clean the Bathroom',
        icon: '',
        xp: 25,
        description: '1. Pick up all laundry and put in the hamper\n2. Remove all items from the floor\n3. Sweep and mop the floor\n4. Remove all trash and throw away\n5. Wipe down all flat surfaces (counter, sink area)\n6. Wipe down the mirror\n7. Clean the toilet (inside and outside)\n8. Hang up towels neatly'
      },
      {
        name: 'Clean the Office',
        icon: '',
        xp: 20,
        description: '1. Pick up ALL laundry and put in the hamper\n2. Remove all items from the floor\n3. Vacuum the entire floor\n4. Remove all trash and throw away\n5. Wipe down all flat surfaces (desk, shelves, tables)\n6. Organize papers and supplies neatly'
      },
      {
        name: 'Clean the Living Room',
        icon: '',
        xp: 20,
        description: '1. Pick up all items from the floor and put them away\n2. Vacuum the entire floor and under furniture\n3. Remove all trash and throw away\n4. Wipe down all flat surfaces (coffee table, end tables, TV stand)\n5. Fluff and straighten couch cushions\n6. Fold and put away any blankets'
      },
      {
        name: 'Take Out Trash',
        icon: '',
        xp: 10,
        description: '1. Empty all trash cans in the house\n2. Replace with new trash bags\n3. Take full bags out to the bin\n4. Bring bin to curb on trash day'
      },
      {
        name: 'Do the Dishes',
        icon: '',
        xp: 15,
        description: '1. Load all dirty dishes into the dishwasher\n2. Hand wash anything that can\'t go in the dishwasher\n3. Wipe down counters and sink\n4. Unload dishwasher when done (if running)'
      },
      {
        name: 'Do Laundry',
        icon: '',
        xp: 15,
        description: '1. Sort laundry by color (darks, lights, whites)\n2. Load washing machine and start cycle\n3. Move to dryer when done\n4. Fold all clothes when dry\n5. Put folded clothes away in drawers/closet'
      },
      {
        name: 'Yard Work',
        icon: '',
        xp: 25,
        description: '1. Mow the lawn (front and back)\n2. Pick up sticks and debris\n3. Pull weeds from garden beds\n4. Sweep walkways and driveway\n5. Water plants if needed'
      },
      {
        name: 'Feed & Walk the Dog',
        icon: '',
        xp: 10,
        description: '1. Fill food bowl with correct amount\n2. Fill water bowl with fresh water\n3. Take dog for a walk (at least 15 minutes)\n4. Clean up after the dog'
      },
      {
        name: 'Homework Time',
        icon: '',
        xp: 15,
        description: '1. Complete all assigned homework\n2. Study for any upcoming tests\n3. Read for at least 20 minutes\n4. Organize backpack for tomorrow'
      }
    ];

    function renderChoreTemplates(containerId, formPrefix) {
      const container = document.getElementById(containerId);
      if (!container) return;
      container.innerHTML = CHORE_TEMPLATES.map((t, i) => `
        <button type="button" onclick="applyChoreTemplate(${i}, '${formPrefix}')" style="
          display: inline-flex; align-items: center; gap: 6px;
          padding: 8px 14px; border-radius: 10px; border: 1px solid rgba(59, 130, 246, 0.3);
          background: rgba(59, 130, 246, 0.1); color: #93c5fd;
          font-size: 13px; font-weight: 600; cursor: pointer; transition: all 0.2s;
        ">${t.icon} ${t.name}</button>
      `).join('');
    }

    window.applyChoreTemplate = function(index, formPrefix) {
      const t = CHORE_TEMPLATES[index];
      if (!t) return;

      document.getElementById(formPrefix + '-name').value = t.name;

      const descEl = document.getElementById(formPrefix + '-desc');
      if (descEl) descEl.value = t.description;

      const iconEl = document.getElementById(formPrefix + '-icon');
      if (iconEl) {
        // Try to select the matching option
        const options = Array.from(iconEl.options);
        const match = options.find(o => o.value === t.icon);
        if (match) {
          iconEl.value = t.icon;
        } else {
          // Add a new option for icons not in the list
          const opt = document.createElement('option');
          opt.value = t.icon;
          opt.textContent = t.icon;
          iconEl.appendChild(opt);
          iconEl.value = t.icon;
        }
      }

      const xpEl = document.getElementById(formPrefix + '-xp');
      if (xpEl) {
        const options = Array.from(xpEl.options);
        const match = options.find(o => parseInt(o.value) === t.xp);
        if (match) {
          xpEl.value = t.xp.toString();
        }
      }

      showToast(t.name + ' template loaded');
    };

    // Render settings templates on first load
    setTimeout(() => {
      const picker = document.getElementById('settings-chore-templates-picker');
      if (picker) renderChoreTemplates('settings-chore-templates-picker', 'new-chore');
    }, 1000);

    window.addChoreFromPortal = async function() {
      const name = document.getElementById('add-chore-name').value.trim();
      const desc = document.getElementById('add-chore-desc').value.trim();
      const icon = document.getElementById('add-chore-icon').value;
      const xp = parseInt(document.getElementById('add-chore-xp').value);

      if (!name) {
        showToast('Enter chore name', 'error');
        return;
      }

      try {
        await createChoreTemplate({
          familyId: currentFamily.id,
          name,
          description: desc,
          icon,
          xpValue: xp
        });
        closeModal('add-chore-modal');
        document.getElementById('add-chore-name').value = '';
        document.getElementById('add-chore-desc').value = '';
        await loadSettingsData();
        renderPortalChores();
        showToast('Chore added!');
      } catch (e) {
        console.error(e);
        showToast('Failed to add chore', 'error');
      }
    };

    // Toggle day picker in assign modal
    window.toggleDayPicker = function() {
      const schedule = document.getElementById('assign-schedule').value;
      document.getElementById('day-picker-group').style.display = schedule === 'weekly' ? 'block' : 'none';
      document.getElementById('multi-day-picker-group').style.display = schedule === 'multiple' ? 'block' : 'none';
    };

    // Save assignment from portal
    window.saveAssignment = async function() {
      const childId = document.getElementById('assign-child').value;
      const choreId = document.getElementById('assign-chore').value;
      const schedule = document.getElementById('assign-schedule').value;
      const isNightly = document.getElementById('assign-nightly').checked;
      const reminderTime = document.getElementById('assign-reminder-time').value;

      if (!childId || !choreId) {
        showToast('Select child and chore', 'error');
        return;
      }

      // Get chore name for reminder message
      const chore = choreTemplates.find(c => c.id === choreId);
      const choreName = chore ? chore.name : 'your chore';

      try {
        if (schedule === 'multiple') {
          // Get all selected days
          const selectedDays = Array.from(document.querySelectorAll('input[name="assign-days"]:checked'))
            .map(cb => parseInt(cb.value));

          if (selectedDays.length === 0) {
            showToast('Select at least one day', 'error');
            return;
          }

          // Create an assignment for each selected day
          for (const day of selectedDays) {
            await createChoreAssignment({
              templateId: choreId,
              childId,
              recurrenceType: 'weekly',
              dayOfWeek: day,
              isNightly
            });
          }
          showToast(`Chore assigned to ${selectedDays.length} days!`);
        } else {
          const dayOfWeek = schedule === 'weekly' ? parseInt(document.getElementById('assign-day').value) : null;
          await createChoreAssignment({
            templateId: choreId,
            childId,
            recurrenceType: schedule,
            dayOfWeek,
            isNightly
          });
          showToast('Chore assigned!');
        }

        // Create reminder if time was specified
        if (reminderTime) {
          await createReminder({
            childId,
            reminderTime,
            reminderType: 'custom',
            message: `Time to do: ${choreName}`
          });
        }

        closeModal('assign-modal');
        await renderPortalAssignments();
        if (reminderTime) {
          await renderPortalReminders();
        }
      } catch (e) {
        console.error(e);
        showToast('Failed to assign', 'error');
      }
    };

    // Show assign modal with dropdowns populated
    window.showAssignChoreModal = function() {
      if (!selectedPortalChildId) {
        showToast('Select a child first', 'error');
        return;
      }

      // Populate child dropdown
      document.getElementById('assign-child').innerHTML = children.map(c =>
        `<option value="${c.id}" ${c.id === selectedPortalChildId ? 'selected' : ''}>${c.avatar || ''} ${c.name}</option>`
      ).join('');

      // Populate chore dropdown
      document.getElementById('assign-chore').innerHTML = choreTemplates.map(c =>
        `<option value="${c.id}">${c.icon} ${c.name}</option>`
      ).join('');

      // Reset schedule to daily and hide day pickers
      document.getElementById('assign-schedule').value = 'daily';
      document.getElementById('day-picker-group').style.display = 'none';
      document.getElementById('multi-day-picker-group').style.display = 'none';

      // Uncheck all day checkboxes
      document.querySelectorAll('input[name="assign-days"]').forEach(cb => cb.checked = false);

      // Reset reminder time and nightly checkbox
      document.getElementById('assign-reminder-time').value = '';
      document.getElementById('assign-nightly').checked = false;

      showModal('assign-modal');
    };

    // Save new reminder
    window.saveNewReminder = async function() {
      if (!selectedPortalChildId) {
        showToast('Select a child first', 'error');
        return;
      }

      const time = document.getElementById('add-reminder-time').value;
      const type = document.getElementById('add-reminder-type').value;
      const message = document.getElementById('add-reminder-message').value.trim();

      try {
        await createReminder({
          childId: selectedPortalChildId,
          reminderTime: time,
          reminderType: type,
          message
        });
        closeModal('add-reminder-modal');
        await renderPortalReminders();
        showToast('Reminder added!');
      } catch (e) {
        console.error(e);
        showToast('Failed to add reminder', 'error');
      }
    };

    let activityItems = [];

    async function renderActivityFeed() {
      // Activity feed is now rendered via renderPortalActivity
    }

    function getTimeAgo(date) {
      const seconds = Math.floor((new Date() - date) / 1000);
      if (seconds < 60) return 'Just now';
      const minutes = Math.floor(seconds / 60);
      if (minutes < 60) return `${minutes}m ago`;
      const hours = Math.floor(minutes / 60);
      if (hours < 24) return `${hours}h ago`;
      return formatDate(date.toISOString().split('T')[0]);
    }

    function formatDate(dateStr) {
      const date = new Date(dateStr);
      return date.toLocaleDateString('en-US', { weekday: 'short', month: 'short', day: 'numeric' });
    }

    // Browser Notifications
    let notificationsEnabled = false;

    window.toggleNotifications = async function() {
      if (!('Notification' in window)) {
        showToast('Notifications not supported', 'error');
        return;
      }

      if (Notification.permission === 'granted') {
        notificationsEnabled = !notificationsEnabled;
        showToast(notificationsEnabled ? 'Notifications ON' : 'Notifications OFF');
        updateNotifButton();
      } else if (Notification.permission !== 'denied') {
        const permission = await Notification.requestPermission();
        if (permission === 'granted') {
          notificationsEnabled = true;
          showToast('Notifications enabled!');
          updateNotifButton();
        }
      } else {
        showToast('Notifications blocked. Check browser settings.', 'error');
      }
    };

    function updateNotifButton() {
      const btn = document.getElementById('notif-toggle');
      btn.style.background = notificationsEnabled ? 'rgba(34, 197, 94, 0.2)' : 'rgba(234, 179, 8, 0.2)';
      btn.style.color = notificationsEnabled ? '#4ade80' : '#fbbf24';
    }

    function sendNotification(title, body, icon = '') {
      if (notificationsEnabled && Notification.permission === 'granted') {
        new Notification(title, { body, icon: '/icons/icon-192.svg' });
      }
    }

    // Notification system with polling fallback
    let notifications = [];
    let lastCheckedCompletions = new Map(); // Track seen chore completions by ID
    let lastCheckedNightly = new Map(); // Track seen nightly completions by ID
    let lastCheckedBonus = new Map(); // Track seen bonus completions by ID
    let notificationPollInterval = null;

    function setupRealtimeNotifications() {
      // Clear any existing poll interval
      if (notificationPollInterval) {
        clearInterval(notificationPollInterval);
      }

      // Initialize with current completions (don't notify for existing ones)
      initializeSeenCompletions();

      // Poll every 15 seconds for new completions
      notificationPollInterval = setInterval(checkForNewCompletions, 15000);
      console.log('Notification polling started');
    }

    async function initializeSeenCompletions() {
      // Mark all current completions as seen
      for (const child of children) {
        try {
          const completions = await getWeeklyCompletions(child.id, getWeekStart());
          completions.forEach(c => lastCheckedCompletions.set(c.id, true));
        } catch (e) {
          console.log('Error initializing chore completions:', e);
        }
        try {
          const nightlyComps = await getNightlyCompletions(child.id, getWeekStart());
          nightlyComps.forEach(c => lastCheckedNightly.set(c.id, true));
        } catch (e) {
          console.log('Error initializing nightly completions:', e);
        }
        try {
          const bonusComps = await getBonusTaskCompletions(child.id, getWeekStart());
          bonusComps.forEach(c => lastCheckedBonus.set(c.id, true));
        } catch (e) {
          console.log('Error initializing bonus completions:', e);
        }
      }
      console.log('Initialized seen completions:', lastCheckedCompletions.size, 'chores,', lastCheckedNightly.size, 'nightly,', lastCheckedBonus.size, 'bonus');
    }

    async function checkForNewCompletions() {
      if (!currentFamily || children.length === 0) return;

      for (const child of children) {
        // Check chore completions
        try {
          const completions = await getWeeklyCompletions(child.id, getWeekStart());

          for (const completion of completions) {
            if (!lastCheckedCompletions.has(completion.id)) {
              lastCheckedCompletions.set(completion.id, true);

              const choreName = completion.chore_assignments?.chore_templates?.name || 'a chore';

              addNotification({
                icon: child.avatar || '',
                text: `<strong>${child.name}</strong> completed ${choreName}`,
                subtext: `+${completion.xp_earned} XP`,
                time: new Date(completion.completed_at)
              });

              sendNotification(
                `${child.name} completed a quest!`,
                `${choreName} (+${completion.xp_earned} XP)`
              );
            }
          }
        } catch (e) {
          console.log('Error checking chore completions for', child.name, e);
        }

        // Check nightly zone completions
        try {
          const nightlyComps = await getNightlyCompletions(child.id, getWeekStart());

          for (const comp of nightlyComps) {
            if (!lastCheckedNightly.has(comp.id)) {
              lastCheckedNightly.set(comp.id, true);

              const zoneName = comp.nightly_zones?.name || 'a zone';
              const zoneIcon = comp.nightly_zones?.icon || '';

              addNotification({
                icon: child.avatar || '',
                text: `<strong>${child.name}</strong> completed ${zoneName} ${zoneIcon}`,
                subtext: '+5 XP',
                time: new Date(comp.completed_at || comp.created_at || new Date())
              });

              sendNotification(
                `${child.name} completed nightly patrol!`,
                `${zoneIcon} ${zoneName} (+5 XP)`
              );
            }
          }
        } catch (e) {
          console.log('Error checking nightly completions for', child.name, e);
        }

        // Check bonus task completions (pending + approved)
        try {
          const bonusComps = await getBonusTaskCompletions(child.id, getWeekStart());

          for (const comp of bonusComps) {
            if (!lastCheckedBonus.has(comp.id)) {
              lastCheckedBonus.set(comp.id, true);

              const taskName = comp.bonus_tasks?.name || 'a bonus task';
              const taskIcon = comp.bonus_tasks?.icon || '';
              const status = comp.status || 'approved';

              if (status === 'pending') {
                const taskXP = comp.bonus_tasks?.xp_value || 10;
                const taskAmount = parseFloat(comp.bonus_tasks?.amount) || 0;
                addNotification({
                  icon: child.avatar || '',
                  text: `<strong>${child.name}</strong> requested ${taskName} ${taskIcon}`,
                  subtext: 'Needs approval',
                  time: new Date(comp.completed_at),
                  pendingCompletionId: comp.id,
                  pendingXP: taskXP,
                  pendingAmount: taskAmount
                });

                sendNotification(
                  `${child.name} requested a Money Maker`,
                  `${taskIcon} ${taskName}  Tap to approve`
                );
              } else {
                const amount = parseFloat(comp.amount_earned) || 0;
                const subtext = amount > 0 ? `+$${amount.toFixed(2)}` : `+${comp.xp_earned} XP`;

                addNotification({
                  icon: child.avatar || '',
                  text: `<strong>${child.name}</strong> completed ${taskName} ${taskIcon}`,
                  subtext,
                  time: new Date(comp.completed_at)
                });

                sendNotification(
                  `${child.name} completed a Money Maker!`,
                  `${taskIcon} ${taskName} (${subtext})`
                );
              }
            }
          }
        } catch (e) {
          console.log('Error checking bonus completions for', child.name, e);
        }
      }

      // Refresh overview if we're viewing it
      const overviewActive = document.querySelector('#portal-overview.active');
      if (overviewActive) {
        await renderPortalOverview();
      }
    }

    function addNotification(notif) {
      notifications.unshift({
        ...notif,
        id: Date.now(),
        read: false
      });
      updateNotificationBadge();
      renderNotificationsList();
    }

    function updateNotificationBadge() {
      const badge = document.getElementById('notification-badge');
      const unreadCount = notifications.filter(n => !n.read).length;
      if (unreadCount > 0) {
        badge.textContent = unreadCount > 9 ? '9+' : unreadCount;
        badge.style.display = 'flex';
      } else {
        badge.style.display = 'none';
      }
    }

    function renderNotificationsList() {
      const list = document.getElementById('notifications-list');
      if (!list) return;

      if (notifications.length === 0) {
        list.innerHTML = '<div class="notification-empty">No new notifications</div>';
        return;
      }

      list.innerHTML = notifications.slice(0, 20).map(n => {
        const pendingActions = n.pendingCompletionId ? `
          <div style="display: flex; gap: 8px; margin-top: 8px;">
            <button onclick="event.stopPropagation(); approveFromNotification('${n.id}', '${n.pendingCompletionId}', ${n.pendingXP}, ${n.pendingAmount})" style="flex: 1; padding: 8px; border: none; border-radius: 8px; background: rgba(34, 197, 94, 0.2); color: #4ade80; font-weight: 700; font-size: 13px; cursor: pointer; min-height: 44px;"> Approve</button>
            <button onclick="event.stopPropagation(); denyFromNotification('${n.id}', '${n.pendingCompletionId}')" style="flex: 1; padding: 8px; border: none; border-radius: 8px; background: rgba(239, 68, 68, 0.2); color: #f87171; font-weight: 700; font-size: 13px; cursor: pointer; min-height: 44px;"> Deny</button>
          </div>
        ` : '';

        return `
          <div class="notification-item ${n.read ? '' : 'unread'}" onclick="markNotificationRead('${n.id}')">
            <div class="notification-icon">${n.icon}</div>
            <div class="notification-content">
              <div class="notification-text">${n.text}</div>
              <div class="notification-time">${n.subtext}  ${getTimeAgo(n.time)}</div>
              ${pendingActions}
            </div>
          </div>
        `;
      }).join('');
    }

    window.toggleNotifications = function() {
      const dropdown = document.getElementById('notifications-dropdown');
      const isVisible = dropdown.style.display === 'block';
      dropdown.style.display = isVisible ? 'none' : 'block';

      // Mark all as read when opening
      if (!isVisible) {
        notifications.forEach(n => n.read = true);
        updateNotificationBadge();
        renderNotificationsList();
      }
    };

    window.markNotificationRead = function(id) {
      const notif = notifications.find(n => n.id == id);
      if (notif) notif.read = true;
      updateNotificationBadge();
    };

    window.approveFromNotification = async function(notifId, completionId, xpEarned, amountEarned) {
      try {
        await approveBonusTask(completionId, xpEarned, amountEarned);
        // Remove the pending actions from this notification
        const notif = notifications.find(n => n.id == notifId);
        if (notif) {
          notif.pendingCompletionId = null;
          notif.subtext = 'Approved ';
          notif.read = true;
        }
        renderNotificationsList();
        updateNotificationBadge();
        showToast('Approved! XP & reward granted ');
        // Refresh pending approvals in overview
        await renderPendingApprovals();
      } catch (e) {
        console.error('Error approving from notification:', e);
        showToast('Failed to approve', 'error');
      }
    };

    window.denyFromNotification = async function(notifId, completionId) {
      try {
        await denyBonusTask(completionId);
        // Remove the pending actions from this notification
        const notif = notifications.find(n => n.id == notifId);
        if (notif) {
          notif.pendingCompletionId = null;
          notif.subtext = 'Denied ';
          notif.read = true;
        }
        renderNotificationsList();
        updateNotificationBadge();
        showToast('Request denied ');
        await renderPendingApprovals();
      } catch (e) {
        console.error('Error denying from notification:', e);
        showToast('Failed to deny', 'error');
      }
    };

    window.clearNotifications = function() {
      notifications = [];
      updateNotificationBadge();
      renderNotificationsList();
    };

    // Close notifications when clicking outside
    document.addEventListener('click', function(e) {
      const dropdown = document.getElementById('notifications-dropdown');
      const bell = document.getElementById('notification-bell');
      if (dropdown && !dropdown.contains(e.target) && !bell?.contains(e.target)) {
        dropdown.style.display = 'none';
      }
    });

    // Settings
    window.openSettings = async function() {
      showModal('settings-modal');
      await loadSettingsData();
    };

    async function loadSettingsData() {
      try {
        children = await getChildren(currentFamily.id);
        choreTemplates = await getChoreTemplates(currentFamily.id);
      } catch (e) { console.error(e); }

      // Children list with edit/delete buttons
      document.getElementById('children-list').innerHTML = children.length ? children.map(c => `
        <div class="item-card">
          <div class="item-icon">${c.avatar || ''}</div>
          <div class="item-info">
            <div class="item-name">${c.name}</div>
            <div class="item-desc">XP: ${c.current_xp || 0}  Streak: ${c.current_streak || 0} days</div>
          </div>
          <button class="item-btn" style="background: rgba(59, 130, 246, 0.2); color: #93c5fd;" onclick="editChild('${c.id}')" title="Edit"></button>
          <button class="item-btn" style="background: rgba(234, 179, 8, 0.2); color: #fbbf24;" onclick="resetChild('${c.id}')" title="Reset Progress"></button>
          <button class="item-btn" onclick="deleteChild('${c.id}')" title="Delete"></button>
        </div>
      `).join('') : '<div class="empty-state"><div class="empty-text">No children yet</div></div>';

      // Chores list
      document.getElementById('chores-list').innerHTML = choreTemplates.length ? choreTemplates.map(c => `
        <div class="item-card">
          <div class="item-icon">${c.icon}</div>
          <div class="item-info">
            <div class="item-name">${c.name}</div>
            <div class="item-desc">${c.xp_value} XP${c.description ? '  ' + c.description : ''}</div>
          </div>
          <button class="item-btn" style="background: rgba(59, 130, 246, 0.2); color: #93c5fd;" onclick="editChore('${c.id}')"></button>
          <button class="item-btn" onclick="deleteChore('${c.id}')"></button>
        </div>
      `).join('') : '<div class="empty-state"><div class="empty-text">No chores yet</div></div>';

      populateAssignDropdowns();
      await renderAssignments();
    }

    function populateAssignDropdowns() {
      // Settings modal dropdowns (with settings- prefix)
      const settingsChild = document.getElementById('settings-assign-child');
      const settingsChore = document.getElementById('settings-assign-chore');
      if (settingsChild) settingsChild.innerHTML = children.map(c => `<option value="${c.id}">${c.name}</option>`).join('');
      if (settingsChore) settingsChore.innerHTML = choreTemplates.map(c => `<option value="${c.id}">${c.icon} ${c.name}</option>`).join('');
    }

    async function renderAssignments() {
      const list = document.getElementById('assignments-list');
      let all = [];
      for (const child of children) {
        const a = await getChildAssignments(child.id);
        all = all.concat(a.map(x => ({ ...x, childName: child.name })));
      }
      list.innerHTML = all.length ? all.map(a => {
        const sched = a.recurrence_type === 'daily' ? 'Daily' : DAY_NAMES[a.day_of_week];
        const reminder = getReminderForAssignment(a.id);
        const reminderText = reminder ? ` ${formatTime12Hour(reminder.time)}` : '';
        return `
          <div class="item-card">
            <div class="item-icon">${a.chore_templates?.icon || ''}</div>
            <div class="item-info">
              <div class="item-name">${a.chore_templates?.name || 'Unknown'}</div>
              <div class="item-desc">${a.childName}  ${sched}${reminderText ? '  ' + reminderText : ''}</div>
            </div>
            <button class="item-btn" style="background: rgba(234, 179, 8, 0.2); color: #fbbf24;" onclick="editReminder('${a.id}', '${a.chore_templates?.name || ''}', '${a.childName}', '${a.chore_templates?.icon || ''}', '${a.recurrence_type === 'daily' ? 'daily' : 'weekly-' + a.day_of_week}')" title="Set reminder"></button>
            <button class="item-btn" onclick="deleteAssignment('${a.id}')" title="Delete"></button>
          </div>
        `;
      }).join('') : '<div class="empty-state"><div class="empty-text">No assignments yet</div></div>';
    }

    function formatTime12Hour(time24) {
      if (!time24) return '';
      const [hours, minutes] = time24.split(':');
      const h = parseInt(hours);
      const ampm = h >= 12 ? 'PM' : 'AM';
      const h12 = h % 12 || 12;
      return `${h12}:${minutes} ${ampm}`;
    }

    window.switchSettingsTab = function(tab) {
      document.querySelectorAll('.settings-tab').forEach(b => {
        b.classList.toggle('active', b.textContent.toLowerCase().includes(tab.substring(0, 4)));
      });
      document.querySelectorAll('.settings-content').forEach(c => {
        c.classList.toggle('active', c.id === `settings-${tab}`);
      });
      if (tab === 'assign') {
        populateAssignDropdowns();
        renderAssignments();
      }
      if (tab === 'nightly') {
        renderNightlyZonesList();
      }
      // Bonus tab now redirects to parent portal
    };

    window.addChild = async function() {
      const name = document.getElementById('new-child-name').value.trim();
      if (!name) { showToast('Enter name', 'error'); return; }
      try {
        await createUser({ familyId: currentFamily.id, type: 'child', name, avatar: '' });
        document.getElementById('new-child-name').value = '';
        await loadSettingsData();
        showToast('Child added!');
      } catch (e) { showToast('Failed', 'error'); }
    };

    let selectedEditAvatar = '';

    // Venmo username storage (localStorage, parent device only)
    function getVenmoUsername(childId) {
      const map = JSON.parse(localStorage.getItem('chore_chart_venmo') || '{}');
      return map[childId] || '';
    }

    function setVenmoUsername(childId, username) {
      const map = JSON.parse(localStorage.getItem('chore_chart_venmo') || '{}');
      if (username) {
        map[childId] = username.replace(/^@/, '');
      } else {
        delete map[childId];
      }
      localStorage.setItem('chore_chart_venmo', JSON.stringify(map));
    }

    function getCashAppTag(childId) {
      const map = JSON.parse(localStorage.getItem('chore_chart_cashapp') || '{}');
      return map[childId] || '';
    }

    function setCashAppTag(childId, cashtag) {
      const map = JSON.parse(localStorage.getItem('chore_chart_cashapp') || '{}');
      if (cashtag) {
        map[childId] = cashtag.replace(/^\$/, '');
      } else {
        delete map[childId];
      }
      localStorage.setItem('chore_chart_cashapp', JSON.stringify(map));
    }

    window.editChild = function(id) {
      const child = children.find(c => c.id === id);
      if (!child) return;

      document.getElementById('edit-child-id').value = id;
      document.getElementById('edit-child-name').value = child.name;
      document.getElementById('edit-child-venmo').value = getVenmoUsername(id);
      document.getElementById('edit-child-cashapp').value = getCashAppTag(id);
      selectedEditAvatar = child.avatar || '';

      // Setup avatar picker
      const picker = document.getElementById('edit-child-avatar-picker');
      picker.querySelectorAll('.avatar-option').forEach(btn => {
        btn.classList.toggle('selected', btn.dataset.avatar === selectedEditAvatar);
        btn.onclick = () => {
          picker.querySelectorAll('.avatar-option').forEach(b => b.classList.remove('selected'));
          btn.classList.add('selected');
          selectedEditAvatar = btn.dataset.avatar;
        };
      });

      showModal('edit-child-modal');
    };

    window.saveChildEdit = async function() {
      const id = document.getElementById('edit-child-id').value;
      const name = document.getElementById('edit-child-name').value.trim();
      const venmo = document.getElementById('edit-child-venmo').value.trim();
      const cashapp = document.getElementById('edit-child-cashapp').value.trim();
      if (!name) { showToast('Enter name', 'error'); return; }

      // Save payment usernames locally
      setVenmoUsername(id, venmo);
      setCashAppTag(id, cashapp);

      try {
        await updateUser(id, { name, avatar: selectedEditAvatar });
        closeModal('edit-child-modal');
        await loadSettingsData();
        renderPortalChildSelector();
        await renderPortalOverview();
        showToast('Child updated!');
      } catch (e) {
        console.error(e);
        showToast('Failed to update', 'error');
      }
    };

    window.resetChild = async function(id) {
      const child = children.find(c => c.id === id);
      if (!child) return;

      if (!confirm(`Reset all progress for ${child.name}? This will clear all XP, streaks, and completion history. This cannot be undone.`)) return;

      try {
        await resetChildProgress(id);
        await loadSettingsData();
        renderPortalChildSelector();
        await renderPortalOverview();
        showToast(child.name + ' progress reset');
      } catch (e) {
        console.error(e);
        showToast('Failed to reset progress', 'error');
      }
    };

    window.resetChildAchievements = async function() {
      if (!selectedPortalChildId) { showToast('Select a child first', 'error'); return; }
      const child = children.find(c => c.id === selectedPortalChildId);
      if (!child) return;
      if (!confirm(`Reset all achievements for ${child.name}? This cannot be undone.`)) return;
      try {
        await resetAchievements(selectedPortalChildId);
        showToast(child.name + ' achievements reset');
      } catch (e) {
        console.error(e);
        showToast('Failed to reset achievements', 'error');
      }
    };

    window.resetChildPrivileges = async function() {
      if (!selectedPortalChildId) { showToast('Select a child first', 'error'); return; }
      const child = children.find(c => c.id === selectedPortalChildId);
      if (!child) return;
      if (!confirm(`Reset all privilege unlocks for ${child.name}? This cannot be undone.`)) return;
      try {
        await resetPrivileges(selectedPortalChildId);
        showToast(child.name + ' privileges reset');
      } catch (e) {
        console.error(e);
        showToast('Failed to reset privileges', 'error');
      }
    };

    window.deleteChild = async function(id) {
      const child = children.find(c => c.id === id);
      if (!child) return;

      if (!confirm(`Delete ${child.name}? This will remove all their chores and progress.`)) return;

      try {
        await deleteUser(id);
        await loadSettingsData();
        // If deleted child was selected, select first remaining child
        if (selectedPortalChildId === id && children.length > 0) {
          selectedPortalChildId = children[0].id;
        } else if (children.length === 0) {
          selectedPortalChildId = null;
        }
        renderPortalChildSelector();
        await renderPortalOverview();
        showToast('Child removed');
      } catch (e) {
        console.error(e);
        showToast('Failed to delete', 'error');
      }
    };

    window.addChore = async function() {
      const name = document.getElementById('new-chore-name').value.trim();
      const desc = document.getElementById('new-chore-desc').value.trim();
      const icon = document.getElementById('new-chore-icon').value;
      const xp = parseInt(document.getElementById('new-chore-xp').value);
      if (!name) { showToast('Enter name', 'error'); return; }
      try {
        await createChoreTemplate({ familyId: currentFamily.id, name, description: desc, icon, xpValue: xp });
        document.getElementById('new-chore-name').value = '';
        document.getElementById('new-chore-desc').value = '';
        await loadSettingsData();
        showToast('Chore added!');
      } catch (e) { showToast('Failed', 'error'); }
    };

    window.deleteChore = async function(id) {
      if (!confirm('Delete chore?')) return;
      try {
        await deleteChoreTemplate(id);
        await loadSettingsData();
        showToast('Deleted');
      } catch (e) { showToast('Failed', 'error'); }
    };

    window.editChore = function(id) {
      const chore = choreTemplates.find(c => c.id === id);
      if (!chore) return;
      document.getElementById('edit-chore-id').value = id;
      document.getElementById('edit-chore-name').value = chore.name;
      document.getElementById('edit-chore-desc').value = chore.description || '';
      document.getElementById('edit-chore-icon').value = chore.icon;
      document.getElementById('edit-chore-xp').value = chore.xp_value;
      showModal('edit-chore-modal');
    };

    window.saveChoreEdit = async function() {
      const id = document.getElementById('edit-chore-id').value;
      const name = document.getElementById('edit-chore-name').value.trim();
      const description = document.getElementById('edit-chore-desc').value.trim();
      const icon = document.getElementById('edit-chore-icon').value;
      const xp_value = parseInt(document.getElementById('edit-chore-xp').value);
      if (!name) { showToast('Enter name', 'error'); return; }
      try {
        await updateChoreTemplate(id, { name, description, icon, xp_value });
        closeModal('edit-chore-modal');
        await loadSettingsData();
        showToast('Chore updated!');
      } catch (e) { showToast('Failed', 'error'); }
    };

    // Nightly Zone Management
    function renderNightlyZonesList() {
      const zones = getNightlyZones();
      const list = document.getElementById('nightly-zones-list');
      if (zones.length === 0) {
        list.innerHTML = '<div class="empty-state"><div class="empty-text">No zones configured</div></div>';
        return;
      }
      list.innerHTML = zones.map(z => `
        <div class="item-card">
          <div class="item-icon">${z.icon}</div>
          <div class="item-info">
            <div class="item-name">${z.label || z.name}</div>
            <div class="item-desc">${z.id ? '+5 XP' : '+5 XP (default)'}</div>
          </div>
          ${z.id ? `
            <button class="item-btn" style="background: rgba(59, 130, 246, 0.2); color: #93c5fd;" onclick="editNightlyZone('${z.id}')"></button>
            <button class="item-btn" onclick="deleteNightlyZone('${z.id}')"></button>
          ` : ''}
        </div>
      `).join('');
    }

    window.addNightlyZone = async function() {
      const name = document.getElementById('new-zone-name').value.trim();
      const icon = document.getElementById('new-zone-icon').value;
      if (!name) { showToast('Enter zone name', 'error'); return; }

      const key = name.toLowerCase().replace(/\s+/g, '_') + '_' + Date.now();
      try {
        await createNightlyZone({
          familyId: currentFamily.id,
          zoneKey: key,
          name: name.toUpperCase(),
          icon,
          sortOrder: nightlyZonesDB.length
        });
        await loadNightlyZonesFromDB();
        document.getElementById('new-zone-name').value = '';
        renderNightlyZonesList();
        renderNightly();
        showToast('Zone added!');
      } catch (e) {
        console.error('Error adding zone:', e);
        showToast('Error adding zone', 'error');
      }
    };

    window.editNightlyZone = function(idOrKey) {
      const zones = getNightlyZones();
      const zone = zones.find(z => z.id === idOrKey || z.key === idOrKey);
      if (!zone) return;

      document.getElementById('edit-zone-key').value = zone.id || zone.key;
      document.getElementById('edit-zone-name').value = zone.label || zone.name;
      document.getElementById('edit-zone-icon').value = zone.icon;
      showModal('edit-zone-modal');
    };

    window.saveZoneEdit = async function() {
      const idOrKey = document.getElementById('edit-zone-key').value;
      const name = document.getElementById('edit-zone-name').value.trim();
      const icon = document.getElementById('edit-zone-icon').value;
      if (!name) { showToast('Enter zone name', 'error'); return; }

      const zones = getNightlyZones();
      const zone = zones.find(z => z.id === idOrKey || z.key === idOrKey);
      if (!zone) return;

      try {
        if (zone.id) {
          await updateNightlyZoneInDB(zone.id, { name: name.toUpperCase(), icon });
          await loadNightlyZonesFromDB();
        }
        closeModal('edit-zone-modal');
        renderNightlyZonesList();
        renderNightly();
        showToast('Zone updated!');
      } catch (e) {
        console.error('Error updating zone:', e);
        showToast('Error updating zone', 'error');
      }
    };

    window.deleteNightlyZone = async function(idOrKey) {
      if (!confirm('Delete this zone?')) return;

      const zones = getNightlyZones();
      const zone = zones.find(z => z.id === idOrKey || z.key === idOrKey);

      try {
        if (zone?.id) {
          await deleteNightlyZoneFromDB(zone.id);
          await loadNightlyZonesFromDB();
        }
        renderNightlyZonesList();
        renderNightly();
        showToast('Zone deleted');
      } catch (e) {
        console.error('Error deleting zone:', e);
        showToast('Error deleting zone', 'error');
      }
    };

    window.assignChoreFromSettings = async function() {
      const childId = document.getElementById('settings-assign-child').value;
      const templateId = document.getElementById('settings-assign-chore').value;
      const schedule = document.getElementById('settings-assign-schedule').value;
      const reminderTime = document.getElementById('settings-assign-reminder-time').value;
      if (!childId || !templateId) { showToast('Select child and chore', 'error'); return; }

      let recurrenceType = 'daily', dayOfWeek = null;
      if (schedule.startsWith('weekly-')) {
        recurrenceType = 'weekly';
        dayOfWeek = parseInt(schedule.split('-')[1]);
      }
      try {
        const newAssignment = await createChoreAssignment({ templateId, childId, recurrenceType, dayOfWeek });
        // Track as new for this week's welcome message
        if (newAssignment?.id) {
          trackNewChoreAssignment(newAssignment.id);

          // Save reminder if time was set
          if (reminderTime) {
            const child = children.find(c => c.id === childId);
            const chore = choreTemplates.find(c => c.id === templateId);
            if (child && chore) {
              addReminder(
                newAssignment.id,
                childId,
                child.name,
                chore.name,
                chore.icon,
                reminderTime,
                schedule
              );
            }
          }
        }

        // Clear the reminder time field
        document.getElementById('settings-assign-reminder-time').value = '';

        await renderAssignments();
        if (currentUser) {
          assignments = await getChildAssignments(currentUser.id);
          renderQuests();
        }
        showToast('Assigned!');
      } catch (e) { showToast('Failed', 'error'); }
    };

    window.deleteAssignment = async function(id) {
      if (!confirm('Remove this assignment?')) return;
      try {
        await deleteChoreAssignment(id);
        // Also remove any associated reminder
        removeReminder(id);
        // Refresh portal view if in portal
        if (selectedPortalChildId) {
          await renderPortalAssignments();
        }
        // Refresh settings view if exists
        if (document.getElementById('assignments-list')) {
          await renderAssignments();
        }
        if (currentUser) {
          assignments = await getChildAssignments(currentUser.id);
          renderQuests();
        }
        showToast('Removed');
      } catch (e) { showToast('Failed', 'error'); }
    };

    window.generateLinkCode = async function() {
      try {
        const code = await generateFamilyLinkCode(currentFamily.id);
        const codeHtml = `
          <div class="link-code-display">
            <div class="link-code-label">FAMILY LINK CODE</div>
            <div class="link-code">${code}</div>
            <div class="link-code-expires">Expires in 15 minutes</div>
          </div>
        `;
        // Update both containers if they exist
        const container1 = document.getElementById('link-code-container');
        const container2 = document.getElementById('portal-link-code-container');
        if (container1) container1.innerHTML = codeHtml;
        if (container2) container2.innerHTML = codeHtml;
        showToast('Link code generated!');
      } catch (e) { showToast('Failed', 'error'); }
    };

    // Toast
    function showToast(message, type = 'success') {
      const toast = document.getElementById('toast');
      toast.textContent = message;
      toast.className = `toast show ${type}`;
      setTimeout(() => toast.classList.remove('show'), 2500);
    }

    // Service Worker
    if ('serviceWorker' in navigator) {
      navigator.serviceWorker.register('sw.js').catch(console.error);
    }

    // Start reminder checker immediately
    checkReminders();

    // Start
    init();
  </script>
</body>
</html>
